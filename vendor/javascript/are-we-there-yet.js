import*as t from"util";import*as e from"events";import*as r from"readable-stream";import*as i from"delegates";var n="default"in e?e.default:e;var a="default"in t?t.default:t;var o={};var h=n.EventEmitter;var s=a;var c=0;var d=o=function(t){h.call(this);this.id=++c;this.name=t};s.inherits(d,h);var u=o;var p="default"in t?t.default:t;var l={};var f=p;var m=u;var v=l=function(t,e){m.call(this,t);this.workDone=0;this.workTodo=e||0};f.inherits(v,m);v.prototype.completed=function(){return 0===this.workTodo?0:this.workDone/this.workTodo};v.prototype.addWork=function(t){this.workTodo+=t;this.emit("change",this.name,this.completed(),this)};v.prototype.completeWork=function(t){this.workDone+=t;this.workDone>this.workTodo&&(this.workDone=this.workTodo);this.emit("change",this.name,this.completed(),this)};v.prototype.finish=function(){this.workTodo=this.workDone=1;this.emit("change",this.name,1,this)};var k=l;var g="default"in t?t.default:t;var w="default"in r?r.default:r;var b="default"in i?i.default:i;var T={};var y=g;var C=w;var G=b;var W=k;var D=T=function(t,e,r){C.Transform.call(this,r);this.tracker=new W(t,e);this.name=t;this.id=this.tracker.id;this.tracker.on("change",delegateChange(this))};y.inherits(D,C.Transform);function delegateChange(t){return function(e,r,i){t.emit("change",e,r,t)}}D.prototype._transform=function(t,e,r){this.tracker.completeWork(t.length?t.length:1);this.push(t);r()};D.prototype._flush=function(t){this.tracker.finish();t()};G(D.prototype,"tracker").method("completed").method("addWork").method("finish");var U=T;var E="default"in t?t.default:t;var I={};var S=E;var _=u;var j=k;var x=U;var A=I=function(t){_.call(this,t);this.parentGroup=null;this.trackers=[];this.completion={};this.weight={};this.totalWeight=0;this.finished=false;this.bubbleChange=bubbleChange(this)};S.inherits(A,_);function bubbleChange(t){return function(e,r,i){t.completion[i.id]=r;t.finished||t.emit("change",e||t.name,t.completed(),t)}}A.prototype.nameInTree=function(){var t=[];var e=this;while(e){t.unshift(e.name);e=e.parentGroup}return t.join("/")};A.prototype.addUnit=function(t,e){if(t.addUnit){var r=this;while(r){if(t===r)throw new Error("Attempted to add tracker group "+t.name+" to tree that already includes it "+this.nameInTree(this));r=r.parentGroup}t.parentGroup=this}this.weight[t.id]=e||1;this.totalWeight+=this.weight[t.id];this.trackers.push(t);this.completion[t.id]=t.completed();t.on("change",this.bubbleChange);this.finished||this.emit("change",t.name,this.completion[t.id],t);return t};A.prototype.completed=function(){if(0===this.trackers.length)return 0;var t=1/this.totalWeight;var e=0;for(var r=0;r<this.trackers.length;r++){var i=this.trackers[r].id;e+=t*this.weight[i]*this.completion[i]}return e};A.prototype.newGroup=function(t,e){return this.addUnit(new A(t),e)};A.prototype.newItem=function(t,e,r){return this.addUnit(new j(t,e),r)};A.prototype.newStream=function(t,e,r){return this.addUnit(new x(t,e),r)};A.prototype.finish=function(){this.finished=true;this.trackers.length||this.addUnit(new j,1,true);for(var t=0;t<this.trackers.length;t++){var e=this.trackers[t];e.finish();e.removeListener("change",this.bubbleChange)}this.emit("change",this.name,1,this)};var L="                                  ";A.prototype.debug=function(t){t=t||0;var e=t?L.substr(0,t):"";var r=e+(this.name||"top")+": "+this.completed()+"\n";this.trackers.forEach((function(i){r+=i instanceof A?i.debug(t+1):e+" "+i.name+": "+i.completed()+"\n"}));return r};var q=I;var z={};z.TrackerGroup=q;z.Tracker=k;z.TrackerStream=U;const B=z.TrackerGroup,F=z.Tracker,H=z.TrackerStream;export{F as Tracker,B as TrackerGroup,H as TrackerStream,z as default};

