import e from"url";import r from"path";import a from"stream";import t from"abbrev";import n from"os";import i from"process";var l="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var f={};var o=i;var s=o.env.DEBUG_NOPT||o.env.NOPT_DEBUG?function(){console.error.apply(console,arguments)}:function(){};var u=e,v=r,d=a.Stream,p=t,c=n;f=f=nopt;f.clean=clean;f.typeDefs={String:{type:String,validate:validateString},Boolean:{type:Boolean,validate:validateBoolean},url:{type:u,validate:validateUrl},Number:{type:Number,validate:validateNumber},path:{type:v,validate:validatePath},Stream:{type:d,validate:validateStream},Date:{type:Date,validate:validateDate}};function nopt(e,r,a,t){a=a||o.argv;e=e||{};r=r||{};"number"!==typeof t&&(t=2);s(e,r,a,t);a=a.slice(t);var n={},i,u={remain:[],cooked:a,original:a.slice(0)};parse(a,n,u.remain,e,r);clean(n,e,f.typeDefs);n.argv=u;Object.defineProperty(n.argv,"toString",{value:function(){return(this||l).original.map(JSON.stringify).join(" ")},enumerable:false});return n}function clean(e,r,a){a=a||f.typeDefs;var t={},n=[false,true,null,String,Array];Object.keys(e).forEach((function(i){if("argv"!==i){var l=e[i],o=Array.isArray(l),u=r[i];o||(l=[l]);u||(u=n);u===Array&&(u=n.concat(Array));Array.isArray(u)||(u=[u]);s("val=%j",l);s("types=",u);l=l.map((function(n){if("string"===typeof n){s("string %j",n);n=n.trim();if("null"===n&&~u.indexOf(null)||"true"===n&&(~u.indexOf(true)||~u.indexOf(Boolean))||"false"===n&&(~u.indexOf(false)||~u.indexOf(Boolean))){n=JSON.parse(n);s("jsonable %j",n)}else if(~u.indexOf(Number)&&!isNaN(n)){s("convert to number",n);n=+n}else if(~u.indexOf(Date)&&!isNaN(Date.parse(n))){s("convert to date",n);n=new Date(n)}}if(!r.hasOwnProperty(i))return n;false===n&&~u.indexOf(null)&&!(~u.indexOf(false)||~u.indexOf(Boolean))&&(n=null);var l={};l[i]=n;s("prevalidated val",l,n,r[i]);if(!validate(l,i,n,r[i],a)){f.invalidHandler?f.invalidHandler(i,n,r[i],e):false!==f.invalidHandler&&s("invalid: "+i+"="+n,r[i]);return t}s("validated val",l,n,r[i]);return l[i]})).filter((function(e){return e!==t}));if(l.length||-1!==u.indexOf(Array))if(o){s(o,e[i],l);e[i]=l}else e[i]=l[0];else{s("VAL HAS NO LENGTH, DELETE IT",l,i,u.indexOf(Array));delete e[i]}s("k=%s val=%j",i,l,e[i])}}))}function validateString(e,r,a){e[r]=String(a)}function validatePath(e,r,a){if(true===a)return false;if(null===a)return true;a=String(a);var t="win32"===o.platform,n=t?/^~(\/|\\)/:/^~\//,i=c.homedir();i&&a.match(n)?e[r]=v.resolve(i,a.substr(2)):e[r]=v.resolve(a);return true}function validateNumber(e,r,a){s("validate Number %j %j %j",r,a,isNaN(a));if(isNaN(a))return false;e[r]=+a}function validateDate(e,r,a){var t=Date.parse(a);s("validate Date %j %j %j",r,a,t);if(isNaN(t))return false;e[r]=new Date(a)}function validateBoolean(e,r,a){a=a instanceof Boolean?a.valueOf():"string"===typeof a?isNaN(a)?"null"!==a&&"false"!==a:!!+a:!!a;e[r]=a}function validateUrl(e,r,a){a=u.parse(String(a));if(!a.host)return false;e[r]=a.href}function validateStream(e,r,a){if(!(a instanceof d))return false;e[r]=a}function validate(e,r,a,t,n){if(Array.isArray(t)){for(var i=0,l=t.length;i<l;i++)if(t[i]!==Array&&validate(e,r,a,t[i],n))return true;delete e[r];return false}if(t===Array)return true;if(t!==t){s("Poison NaN",r,a,t);delete e[r];return false}if(a===t){s("Explicitly allowed %j",a);e[r]=a;return true}var f=false,o=Object.keys(n);for(var i=0,l=o.length;i<l;i++){s("test type %j %j %j",r,a,o[i]);var u=n[o[i]];if(u&&(t&&t.name&&u.type&&u.type.name?t.name===u.type.name:t===u.type)){var v={};f=false!==u.validate(v,r,a);a=v[r];if(f){e[r]=a;break}}}s("OK? %j (%j %j %j)",f,r,a,o[i]);f||delete e[r];return f}function parse(e,r,a,t,n){s("parse",e,r,a);var i=null,l=p(Object.keys(t)),f=p(Object.keys(n));for(var o=0;o<e.length;o++){var u=e[o];s("arg",u);if(u.match(/^-{2,}$/)){a.push.apply(a,e.slice(o+1));e[o]="--";break}var v=false;if("-"===u.charAt(0)&&u.length>1){var d=u.indexOf("=");if(d>-1){v=true;var c=u.substr(d+1);u=u.substr(0,d);e.splice(o,1,u,c)}var y=resolveShort(u,n,f,l);s("arg=%j shRes=%j",u,y);if(y){s(u,y);e.splice.apply(e,[o,1].concat(y));if(u!==y[0]){o--;continue}}u=u.replace(/^-+/,"");var m=null;while(0===u.toLowerCase().indexOf("no-")){m=!m;u=u.substr(3)}l[u]&&(u=l[u]);var h=t[u];var O=Array.isArray(h);if(O&&1===h.length){O=false;h=h[0]}var g=h===Array||O&&-1!==h.indexOf(Array);if(!t.hasOwnProperty(u)&&r.hasOwnProperty(u)){Array.isArray(r[u])||(r[u]=[r[u]]);g=true}var N,b=e[o+1];var j="boolean"===typeof m||h===Boolean||O&&-1!==h.indexOf(Boolean)||"undefined"===typeof h&&!v||"false"===b&&(null===h||O&&~h.indexOf(null));if(j){N=!m;if("true"===b||"false"===b){N=JSON.parse(b);b=null;m&&(N=!N);o++}if(O&&b)if(~h.indexOf(b)){N=b;o++}else if("null"===b&&~h.indexOf(null)){N=null;o++}else if(b.match(/^-{2,}[^-]/)||isNaN(b)||!~h.indexOf(Number)){if(!b.match(/^-[^-]/)&&~h.indexOf(String)){N=b;o++}}else{N=+b;o++}g?(r[u]=r[u]||[]).push(N):r[u]=N;continue}if(h===String)if(void 0===b)b="";else if(b.match(/^-{1,2}[^-]+/)){b="";o--}if(b&&b.match(/^-{2,}$/)){b=void 0;o--}N=void 0===b||b;g?(r[u]=r[u]||[]).push(N):r[u]=N;o++}else a.push(u)}}function resolveShort(e,r,a,t){e=e.replace(/^-+/,"");if(t[e]===e)return null;if(r[e]){r[e]&&!Array.isArray(r[e])&&(r[e]=r[e].split(/\s+/));return r[e]}var n=r.___singles;if(!n){n=Object.keys(r).filter((function(e){return 1===e.length})).reduce((function(e,r){e[r]=true;return e}),{});r.___singles=n;s("shorthand singles",n)}var i=e.split("").filter((function(e){return n[e]}));if(i.join("")===e)return i.map((function(e){return r[e]})).reduce((function(e,r){return e.concat(r)}),[]);if(t[e]&&!r[e])return null;a[e]&&(e=a[e]);r[e]&&!Array.isArray(r[e])&&(r[e]=r[e].split(/\s+/));return r[e]}var y=f;const m=f.typeDefs;const h=f.clean;export default y;export{h as clean,m as typeDefs};

