import*as e from"@tensorflow/tfjs-core";export{e as tf};import{__extends as t,__spreadArrays as r,__assign as n,__awaiter as a,__generator as o}from"tslib";function drawContour(e,t,r){void 0===r&&(r=false);e.beginPath();t.slice(1).forEach((function(r,n){var a=r.x,o=r.y;var i=t[n];e.moveTo(i.x,i.y);e.lineTo(a,o)}));if(r){var n=t[t.length-1];var a=t[0];if(!n||!a)return;e.moveTo(n.x,n.y);e.lineTo(a.x,a.y)}e.stroke()}var i=function(){function Dimensions(e,t){if(!isValidNumber(e)||!isValidNumber(t))throw new Error("Dimensions.constructor - expected width and height to be valid numbers, instead have "+JSON.stringify({width:e,height:t}));this._width=e;this._height=t}Object.defineProperty(Dimensions.prototype,"width",{get:function(){return this._width},enumerable:true,configurable:true});Object.defineProperty(Dimensions.prototype,"height",{get:function(){return this._height},enumerable:true,configurable:true});Dimensions.prototype.reverse=function(){return new Dimensions(1/this.width,1/this.height)};return Dimensions}();function isTensor(t,r){return t instanceof e.Tensor&&t.shape.length===r}function isTensor1D(e){return isTensor(e,1)}function isTensor2D(e){return isTensor(e,2)}function isTensor3D(e){return isTensor(e,3)}function isTensor4D(e){return isTensor(e,4)}function isFloat(e){return e%1!==0}function isEven(e){return e%2===0}function round(e,t){void 0===t&&(t=2);var r=Math.pow(10,t);return Math.floor(e*r)/r}function isDimensions(e){return e&&e.width&&e.height}function computeReshapedDimensions(e,t){var r=e.width,n=e.height;var a=t/Math.max(n,r);return new i(Math.round(r*a),Math.round(n*a))}function getCenterPoint(e){return e.reduce((function(e,t){return e.add(t)}),new c(0,0)).div(new c(e.length,e.length))}function range(e,t,r){return Array(e).fill(0).map((function(e,n){return t+n*r}))}function isValidNumber(e){return!!e&&Infinity!==e&&-Infinity!==e&&!isNaN(e)||0===e}function isValidProbablitiy(e){return isValidNumber(e)&&0<=e&&e<=1}var s=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",isTensor:isTensor,isTensor1D:isTensor1D,isTensor2D:isTensor2D,isTensor3D:isTensor3D,isTensor4D:isTensor4D,isFloat:isFloat,isEven:isEven,round:round,isDimensions:isDimensions,computeReshapedDimensions:computeReshapedDimensions,getCenterPoint:getCenterPoint,range:range,isValidNumber:isValidNumber,isValidProbablitiy:isValidProbablitiy});var c=function(){function Point(e,t){this._x=e;this._y=t}Object.defineProperty(Point.prototype,"x",{get:function(){return this._x},enumerable:true,configurable:true});Object.defineProperty(Point.prototype,"y",{get:function(){return this._y},enumerable:true,configurable:true});Point.prototype.add=function(e){return new Point(this.x+e.x,this.y+e.y)};Point.prototype.sub=function(e){return new Point(this.x-e.x,this.y-e.y)};Point.prototype.mul=function(e){return new Point(this.x*e.x,this.y*e.y)};Point.prototype.div=function(e){return new Point(this.x/e.x,this.y/e.y)};Point.prototype.abs=function(){return new Point(Math.abs(this.x),Math.abs(this.y))};Point.prototype.magnitude=function(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))};Point.prototype.floor=function(){return new Point(Math.floor(this.x),Math.floor(this.y))};return Point}();var u=function(){function Box(e,t){void 0===t&&(t=true);var r=e||{};var n=[r.left,r.top,r.right,r.bottom].every(isValidNumber);var a=[r.x,r.y,r.width,r.height].every(isValidNumber);if(!a&&!n)throw new Error("Box.constructor - expected box to be IBoundingBox | IRect, instead have "+JSON.stringify(r));var o=a?[r.x,r.y,r.width,r.height]:[r.left,r.top,r.right-r.left,r.bottom-r.top],i=o[0],s=o[1],c=o[2],u=o[3];Box.assertIsValidBox({x:i,y:s,width:c,height:u},"Box.constructor",t);this._x=i;this._y=s;this._width=c;this._height=u}Box.isRect=function(e){return!!e&&[e.x,e.y,e.width,e.height].every(isValidNumber)};Box.assertIsValidBox=function(e,t,r){void 0===r&&(r=false);if(!Box.isRect(e))throw new Error(t+" - invalid box: "+JSON.stringify(e)+", expected object with properties x, y, width, height");if(!r&&(e.width<0||e.height<0))throw new Error(t+" - width ("+e.width+") and height ("+e.height+") must be positive numbers")};Object.defineProperty(Box.prototype,"x",{get:function(){return this._x},enumerable:true,configurable:true});Object.defineProperty(Box.prototype,"y",{get:function(){return this._y},enumerable:true,configurable:true});Object.defineProperty(Box.prototype,"width",{get:function(){return this._width},enumerable:true,configurable:true});Object.defineProperty(Box.prototype,"height",{get:function(){return this._height},enumerable:true,configurable:true});Object.defineProperty(Box.prototype,"left",{get:function(){return this.x},enumerable:true,configurable:true});Object.defineProperty(Box.prototype,"top",{get:function(){return this.y},enumerable:true,configurable:true});Object.defineProperty(Box.prototype,"right",{get:function(){return this.x+this.width},enumerable:true,configurable:true});Object.defineProperty(Box.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:true,configurable:true});Object.defineProperty(Box.prototype,"area",{get:function(){return this.width*this.height},enumerable:true,configurable:true});Object.defineProperty(Box.prototype,"topLeft",{get:function(){return new c(this.left,this.top)},enumerable:true,configurable:true});Object.defineProperty(Box.prototype,"topRight",{get:function(){return new c(this.right,this.top)},enumerable:true,configurable:true});Object.defineProperty(Box.prototype,"bottomLeft",{get:function(){return new c(this.left,this.bottom)},enumerable:true,configurable:true});Object.defineProperty(Box.prototype,"bottomRight",{get:function(){return new c(this.right,this.bottom)},enumerable:true,configurable:true});Box.prototype.round=function(){var e=[this.x,this.y,this.width,this.height].map((function(e){return Math.round(e)})),t=e[0],r=e[1],n=e[2],a=e[3];return new Box({x:t,y:r,width:n,height:a})};Box.prototype.floor=function(){var e=[this.x,this.y,this.width,this.height].map((function(e){return Math.floor(e)})),t=e[0],r=e[1],n=e[2],a=e[3];return new Box({x:t,y:r,width:n,height:a})};Box.prototype.toSquare=function(){var e=this,t=e.x,r=e.y,n=e.width,a=e.height;var o=Math.abs(n-a);if(n<a){t-=o/2;n+=o}if(a<n){r-=o/2;a+=o}return new Box({x:t,y:r,width:n,height:a})};Box.prototype.rescale=function(e){var t=isDimensions(e)?e.width:e;var r=isDimensions(e)?e.height:e;return new Box({x:this.x*t,y:this.y*r,width:this.width*t,height:this.height*r})};Box.prototype.pad=function(e,t){var r=[this.x-e/2,this.y-t/2,this.width+e,this.height+t],n=r[0],a=r[1],o=r[2],i=r[3];return new Box({x:n,y:a,width:o,height:i})};Box.prototype.clipAtImageBorders=function(e,t){var r=this,n=r.x,a=r.y,o=r.right,i=r.bottom;var s=Math.max(n,0);var c=Math.max(a,0);var u=o-s;var l=i-c;var h=Math.min(u,e-s);var p=Math.min(l,t-c);return new Box({x:s,y:c,width:h,height:p}).floor()};Box.prototype.shift=function(e,t){var r=this,n=r.width,a=r.height;var o=this.x+e;var i=this.y+t;return new Box({x:o,y:i,width:n,height:a})};Box.prototype.padAtBorders=function(e,t){var r=this.width+1;var n=this.height+1;var a=1;var o=1;var i=r;var s=n;var c=this.left;var u=this.top;var l=this.right;var h=this.bottom;if(l>t){i=-l+t+r;l=t}if(h>e){s=-h+e+n;h=e}if(c<1){s=2-c;c=1}if(u<1){s=2-u;u=1}return{dy:o,edy:s,dx:a,edx:i,y:u,ey:h,x:c,ex:l,w:r,h:n}};Box.prototype.calibrate=function(e){return new Box({left:this.left+e.left*this.width,top:this.top+e.top*this.height,right:this.right+e.right*this.width,bottom:this.bottom+e.bottom*this.height}).toSquare().round()};return Box}();var l=function(e){t(BoundingBox,e);function BoundingBox(t,r,n,a,o){void 0===o&&(o=false);return e.call(this,{left:t,top:r,right:n,bottom:a},o)||this}return BoundingBox}(u);var h=function(){function ObjectDetection(e,t,r,n,a){this._imageDims=new i(a.width,a.height);this._score=e;this._classScore=t;this._className=r;this._box=new u(n).rescale(this._imageDims)}Object.defineProperty(ObjectDetection.prototype,"score",{get:function(){return this._score},enumerable:true,configurable:true});Object.defineProperty(ObjectDetection.prototype,"classScore",{get:function(){return this._classScore},enumerable:true,configurable:true});Object.defineProperty(ObjectDetection.prototype,"className",{get:function(){return this._className},enumerable:true,configurable:true});Object.defineProperty(ObjectDetection.prototype,"box",{get:function(){return this._box},enumerable:true,configurable:true});Object.defineProperty(ObjectDetection.prototype,"imageDims",{get:function(){return this._imageDims},enumerable:true,configurable:true});Object.defineProperty(ObjectDetection.prototype,"imageWidth",{get:function(){return this.imageDims.width},enumerable:true,configurable:true});Object.defineProperty(ObjectDetection.prototype,"imageHeight",{get:function(){return this.imageDims.height},enumerable:true,configurable:true});Object.defineProperty(ObjectDetection.prototype,"relativeBox",{get:function(){return new u(this._box).rescale(this.imageDims.reverse())},enumerable:true,configurable:true});ObjectDetection.prototype.forSize=function(e,t){return new ObjectDetection(this.score,this.classScore,this.className,this.relativeBox,{width:e,height:t})};return ObjectDetection}();var p=function(e){t(FaceDetection,e);function FaceDetection(t,r,n){return e.call(this,t,t,"",r,n)||this}FaceDetection.prototype.forSize=function(t,r){var n=e.prototype.forSize.call(this,t,r),a=n.score,o=n.relativeBox,i=n.imageDims;return new FaceDetection(a,o,i)};return FaceDetection}(h);function iou(e,t,r){void 0===r&&(r=true);var n=Math.max(0,Math.min(e.right,t.right)-Math.max(e.left,t.left));var a=Math.max(0,Math.min(e.bottom,t.bottom)-Math.max(e.top,t.top));var o=n*a;return r?o/(e.area+t.area-o):o/Math.min(e.area,t.area)}function minBbox(e){var t=e.map((function(e){return e.x}));var r=e.map((function(e){return e.y}));var n=t.reduce((function(e,t){return t<e?t:e}),Infinity);var a=r.reduce((function(e,t){return t<e?t:e}),Infinity);var o=t.reduce((function(e,t){return e<t?t:e}),0);var i=r.reduce((function(e,t){return e<t?t:e}),0);return new l(n,a,o,i)}function nonMaxSuppression$1(e,t,r,n){void 0===n&&(n=true);var a=t.map((function(e,t){return{score:e,boxIndex:t}})).sort((function(e,t){return e.score-t.score})).map((function(e){return e.boxIndex}));var o=[];var _loop_1=function(){var t=a.pop();o.push(t);var i=a;var s=[];for(var c=0;c<i.length;c++){var u=i[c];var l=e[t];var h=e[u];s.push(iou(l,h,n))}a=a.filter((function(e,t){return s[t]<=r}))};while(a.length>0)_loop_1();return o}function normalize$1(t,n){return e.tidy((function(){var a=n[0],o=n[1],i=n[2];var s=e.fill(r(t.shape.slice(0,3),[1]),a);var c=e.fill(r(t.shape.slice(0,3),[1]),o);var u=e.fill(r(t.shape.slice(0,3),[1]),i);var l=e.concat([s,c,u],3);return e.sub(t,l)}))}
/**
 * Pads the smaller dimension of an image tensor with zeros, such that width === height.
 *
 * @param imgTensor The image tensor.
 * @param isCenterImage (optional, default: false) If true, add an equal amount of padding on
 * both sides of the minor dimension oof the image.
 * @returns The padded tensor with width === height.
 */function padToSquare(t,r){void 0===r&&(r=false);return e.tidy((function(){var n=t.shape.slice(1),a=n[0],o=n[1];if(a===o)return t;var i=Math.abs(a-o);var s=Math.round(i*(r?.5:1));var c=a>o?2:1;var createPaddingTensor=function(r){var n=t.shape.slice();n[c]=r;return e.fill(n,0)};var u=createPaddingTensor(s);var l=i-u.shape[c];var h=r&&l?createPaddingTensor(l):null;var p=[h,t,u].filter((function(e){return!!e})).map((function(e){return e.toFloat()}));return e.concat(p,c)}))}function shuffleArray(e){var t=e.slice();for(var r=t.length-1;r>0;r--){var n=Math.floor(Math.random()*(r+1));var a=t[r];t[r]=t[n];t[n]=a}return t}function sigmoid(e){return 1/(1+Math.exp(-e))}function inverseSigmoid(e){return Math.log(e/(1-e))}var v=function(e){t(Rect,e);function Rect(t,r,n,a,o){void 0===o&&(o=false);return e.call(this,{x:t,y:r,width:n,height:a},o)||this}return Rect}(u);var d=.5;var f=.43;var m=.45;var g=function(){function FaceLandmarks(e,t,r){void 0===r&&(r=new c(0,0));var n=t.width,a=t.height;this._imgDims=new i(n,a);this._shift=r;this._positions=e.map((function(e){return e.mul(new c(n,a)).add(r)}))}Object.defineProperty(FaceLandmarks.prototype,"shift",{get:function(){return new c(this._shift.x,this._shift.y)},enumerable:true,configurable:true});Object.defineProperty(FaceLandmarks.prototype,"imageWidth",{get:function(){return this._imgDims.width},enumerable:true,configurable:true});Object.defineProperty(FaceLandmarks.prototype,"imageHeight",{get:function(){return this._imgDims.height},enumerable:true,configurable:true});Object.defineProperty(FaceLandmarks.prototype,"positions",{get:function(){return this._positions},enumerable:true,configurable:true});Object.defineProperty(FaceLandmarks.prototype,"relativePositions",{get:function(){var e=this;return this._positions.map((function(t){return t.sub(e._shift).div(new c(e.imageWidth,e.imageHeight))}))},enumerable:true,configurable:true});FaceLandmarks.prototype.forSize=function(e,t){return new this.constructor(this.relativePositions,{width:e,height:t})};FaceLandmarks.prototype.shiftBy=function(e,t){return new this.constructor(this.relativePositions,this._imgDims,new c(e,t))};FaceLandmarks.prototype.shiftByPoint=function(e){return this.shiftBy(e.x,e.y)};
/**
     * Aligns the face landmarks after face detection from the relative positions of the faces
     * bounding box, or it's current shift. This function should be used to align the face images
     * after face detection has been performed, before they are passed to the face recognition net.
     * This will make the computed face descriptor more accurate.
     *
     * @param detection (optional) The bounding box of the face or the face detection result. If
     * no argument was passed the position of the face landmarks are assumed to be relative to
     * it's current shift.
     * @returns The bounding box of the aligned face.
     */FaceLandmarks.prototype.align=function(e,t){void 0===t&&(t={});if(e){var r=e instanceof p?e.box.floor():new u(e);return this.shiftBy(r.x,r.y).align(null,t)}var n=Object.assign({},{useDlibAlignment:false,minBoxPadding:.2},t),a=n.useDlibAlignment,o=n.minBoxPadding;return a?this.alignDlib():this.alignMinBbox(o)};FaceLandmarks.prototype.alignDlib=function(){var e=this.getRefPointsForAlignment();var t=e[0],r=e[1],n=e[2];var distToMouth=function(e){return n.sub(e).magnitude()};var a=(distToMouth(t)+distToMouth(r))/2;var o=Math.floor(a/m);var i=getCenterPoint(e);var s=Math.floor(Math.max(0,i.x-d*o));var c=Math.floor(Math.max(0,i.y-f*o));return new v(s,c,Math.min(o,this.imageWidth+s),Math.min(o,this.imageHeight+c))};FaceLandmarks.prototype.alignMinBbox=function(e){var t=minBbox(this.positions);return t.pad(t.width*e,t.height*e)};FaceLandmarks.prototype.getRefPointsForAlignment=function(){throw new Error("getRefPointsForAlignment not implemented by base class")};return FaceLandmarks}();var x=function(e){t(FaceLandmarks5,e);function FaceLandmarks5(){return null!==e&&e.apply(this,arguments)||this}FaceLandmarks5.prototype.getRefPointsForAlignment=function(){var e=this.positions;return[e[0],e[1],getCenterPoint([e[3],e[4]])]};return FaceLandmarks5}(g);var y=function(e){t(FaceLandmarks68,e);function FaceLandmarks68(){return null!==e&&e.apply(this,arguments)||this}FaceLandmarks68.prototype.getJawOutline=function(){return this.positions.slice(0,17)};FaceLandmarks68.prototype.getLeftEyeBrow=function(){return this.positions.slice(17,22)};FaceLandmarks68.prototype.getRightEyeBrow=function(){return this.positions.slice(22,27)};FaceLandmarks68.prototype.getNose=function(){return this.positions.slice(27,36)};FaceLandmarks68.prototype.getLeftEye=function(){return this.positions.slice(36,42)};FaceLandmarks68.prototype.getRightEye=function(){return this.positions.slice(42,48)};FaceLandmarks68.prototype.getMouth=function(){return this.positions.slice(48,68)};FaceLandmarks68.prototype.getRefPointsForAlignment=function(){return[this.getLeftEye(),this.getRightEye(),this.getMouth()].map(getCenterPoint)};return FaceLandmarks68}(g);var b=function(){function FaceMatch(e,t){this._label=e;this._distance=t}Object.defineProperty(FaceMatch.prototype,"label",{get:function(){return this._label},enumerable:true,configurable:true});Object.defineProperty(FaceMatch.prototype,"distance",{get:function(){return this._distance},enumerable:true,configurable:true});FaceMatch.prototype.toString=function(e){void 0===e&&(e=true);return this.label+(e?" ("+round(this.distance)+")":"")};return FaceMatch}();var w=function(e){t(LabeledBox,e);function LabeledBox(t,r){var n=e.call(this,t)||this;n._label=r;return n}LabeledBox.assertIsValidLabeledBox=function(e,t){u.assertIsValidBox(e,t);if(!isValidNumber(e.label))throw new Error(t+" - expected property label ("+e.label+") to be a number")};Object.defineProperty(LabeledBox.prototype,"label",{get:function(){return this._label},enumerable:true,configurable:true});return LabeledBox}(u);var _=function(){function LabeledFaceDescriptors(e,t){if(!("string"===typeof e))throw new Error("LabeledFaceDescriptors - constructor expected label to be a string");if(!Array.isArray(t)||t.some((function(e){return!(e instanceof Float32Array)})))throw new Error("LabeledFaceDescriptors - constructor expected descriptors to be an array of Float32Array");this._label=e;this._descriptors=t}Object.defineProperty(LabeledFaceDescriptors.prototype,"label",{get:function(){return this._label},enumerable:true,configurable:true});Object.defineProperty(LabeledFaceDescriptors.prototype,"descriptors",{get:function(){return this._descriptors},enumerable:true,configurable:true});LabeledFaceDescriptors.prototype.toJSON=function(){return{label:this.label,descriptors:this.descriptors.map((function(e){return Array.from(e)}))}};LabeledFaceDescriptors.fromJSON=function(e){var t=e.descriptors.map((function(e){return new Float32Array(e)}));return new LabeledFaceDescriptors(e.label,t)};return LabeledFaceDescriptors}();var P=function(e){t(PredictedBox,e);function PredictedBox(t,r,n,a){var o=e.call(this,t,r)||this;o._score=n;o._classScore=a;return o}PredictedBox.assertIsValidPredictedBox=function(e,t){w.assertIsValidLabeledBox(e,t);if(!isValidProbablitiy(e.score)||!isValidProbablitiy(e.classScore))throw new Error(t+" - expected properties score ("+e.score+") and ("+e.classScore+") to be a number between [0, 1]")};Object.defineProperty(PredictedBox.prototype,"score",{get:function(){return this._score},enumerable:true,configurable:true});Object.defineProperty(PredictedBox.prototype,"classScore",{get:function(){return this._classScore},enumerable:true,configurable:true});return PredictedBox}(w);function isWithFaceDetection(e){return e.detection instanceof p}function extendWithFaceDetection(e,t){var r={detection:t};return Object.assign({},e,r)}function createBrowserEnv(){var e=window.fetch||function(){throw new Error("fetch - missing fetch implementation for browser environment")};var readFile=function(){throw new Error("readFile - filesystem not available for browser environment")};return{Canvas:HTMLCanvasElement,CanvasRenderingContext2D:CanvasRenderingContext2D,Image:HTMLImageElement,ImageData:ImageData,Video:HTMLVideoElement,createCanvasElement:function(){return document.createElement("canvas")},createImageElement:function(){return document.createElement("img")},fetch:e,readFile:readFile}}function createFileSystem(e){var t="";if(!e)try{e=require("fs")}catch(e){t=e.toString()}var r=e?function(t){return new Promise((function(r,n){e.readFile(t,(function(e,t){return e?n(e):r(t)}))}))}:function(){throw new Error("readFile - failed to require fs in nodejs environment with error: "+t)};return{readFile:r}}function createNodejsEnv(){var e=global.Canvas||global.HTMLCanvasElement;var t=global.Image||global.HTMLImageElement;var createCanvasElement=function(){if(e)return new e;throw new Error("createCanvasElement - missing Canvas implementation for nodejs environment")};var createImageElement=function(){if(t)return new t;throw new Error("createImageElement - missing Image implementation for nodejs environment")};var r=global.fetch||function(){throw new Error("fetch - missing fetch implementation for nodejs environment")};var a=createFileSystem();return n({Canvas:e||function(){function Canvas(){}return Canvas}(),CanvasRenderingContext2D:global.CanvasRenderingContext2D||function(){function class_1(){}return class_1}(),Image:t||function(){function Image(){}return Image}(),ImageData:global.ImageData||function(){function class_2(){}return class_2}(),Video:global.HTMLVideoElement||function(){function class_3(){}return class_3}(),createCanvasElement:createCanvasElement,createImageElement:createImageElement,fetch:r},a)}function isBrowser(){return"object"===typeof window&&"undefined"!==typeof document&&"undefined"!==typeof HTMLImageElement&&"undefined"!==typeof HTMLCanvasElement&&"undefined"!==typeof HTMLVideoElement&&"undefined"!==typeof ImageData&&"undefined"!==typeof CanvasRenderingContext2D}function isNodejs(){return"object"===typeof global&&"function"===typeof require&&"undefined"!==typeof module&&"undefined"!==typeof process&&!!process.version}var F;function getEnv(){if(!F)throw new Error("getEnv - environment is not defined, check isNodejs() and isBrowser()");return F}function setEnv(e){F=e}function initialize(){isBrowser()&&setEnv(createBrowserEnv());isNodejs()&&setEnv(createNodejsEnv())}function monkeyPatch(e){F||initialize();if(!F)throw new Error("monkeyPatch - environment is not defined, check isNodejs() and isBrowser()");var t=e.Canvas,r=void 0===t?F.Canvas:t,n=e.Image,a=void 0===n?F.Image:n;F.Canvas=r;F.Image=a;F.createCanvasElement=e.createCanvasElement||function(){return new r};F.createImageElement=e.createImageElement||function(){return new a};F.ImageData=e.ImageData||F.ImageData;F.Video=e.Video||F.Video;F.fetch=e.fetch||F.fetch;F.readFile=e.readFile||F.readFile}var T={getEnv:getEnv,setEnv:setEnv,initialize:initialize,createBrowserEnv:createBrowserEnv,createFileSystem:createFileSystem,createNodejsEnv:createNodejsEnv,monkeyPatch:monkeyPatch,isBrowser:isBrowser,isNodejs:isNodejs};initialize();function resolveInput(e){return T.isNodejs()||"string"!==typeof e?e:document.getElementById(e)}function getContext2dOrThrow(e){var t=T.getEnv(),r=t.Canvas,n=t.CanvasRenderingContext2D;if(e instanceof n)return e;var a=resolveInput(e);if(!(a instanceof r))throw new Error("resolveContext2d - expected canvas to be of instance of Canvas");var o=a.getContext("2d");if(!o)throw new Error("resolveContext2d - canvas 2d context is null");return o}var C;(function(e){e.TOP_LEFT="TOP_LEFT";e.TOP_RIGHT="TOP_RIGHT";e.BOTTOM_LEFT="BOTTOM_LEFT";e.BOTTOM_RIGHT="BOTTOM_RIGHT"})(C||(C={}));var D=function(){function DrawTextFieldOptions(e){void 0===e&&(e={});var t=e.anchorPosition,r=e.backgroundColor,n=e.fontColor,a=e.fontSize,o=e.fontStyle,i=e.padding;this.anchorPosition=t||C.TOP_LEFT;this.backgroundColor=r||"rgba(0, 0, 0, 0.5)";this.fontColor=n||"rgba(255, 255, 255, 1)";this.fontSize=a||14;this.fontStyle=o||"Georgia";this.padding=i||4}return DrawTextFieldOptions}();var k=function(){function DrawTextField(e,t,r){void 0===r&&(r={});this.text="string"===typeof e?[e]:e instanceof DrawTextField?e.text:e;this.anchor=t;this.options=new D(r)}DrawTextField.prototype.measureWidth=function(e){var t=this.options.padding;return this.text.map((function(t){return e.measureText(t).width})).reduce((function(e,t){return e<t?t:e}),0)+2*t};DrawTextField.prototype.measureHeight=function(){var e=this.options,t=e.fontSize,r=e.padding;return this.text.length*t+2*r};DrawTextField.prototype.getUpperLeft=function(e,t){var r=this.options.anchorPosition;var n=r===C.BOTTOM_RIGHT||r===C.TOP_RIGHT;var a=r===C.BOTTOM_LEFT||r===C.BOTTOM_RIGHT;var o=this.measureWidth(e);var i=this.measureHeight();var s=n?this.anchor.x-o:this.anchor.x;var c=a?this.anchor.y-i:this.anchor.y;if(t){var u=t.width,l=t.height;var h=Math.max(Math.min(s,u-o),0);var p=Math.max(Math.min(c,l-i),0);return{x:h,y:p}}return{x:s,y:c}};DrawTextField.prototype.draw=function(e){var t=resolveInput(e);var r=getContext2dOrThrow(t);var n=this.options,a=n.backgroundColor,o=n.fontColor,i=n.fontSize,s=n.fontStyle,c=n.padding;r.font=i+"px "+s;var u=this.measureWidth(r);var l=this.measureHeight();r.fillStyle=a;var h=this.getUpperLeft(r,t);r.fillRect(h.x,h.y,u,l);r.fillStyle=o;this.text.forEach((function(e,t){var n=c+h.x;var a=c+h.y+(t+1)*i;r.fillText(e,n,a)}))};return DrawTextField}();var E=function(){function DrawBoxOptions(e){void 0===e&&(e={});var t=e.boxColor,r=e.lineWidth,n=e.label,a=e.drawLabelOptions;this.boxColor=t||"rgba(0, 0, 255, 1)";this.lineWidth=r||2;this.label=n;var o={anchorPosition:C.BOTTOM_LEFT,backgroundColor:this.boxColor};this.drawLabelOptions=new D(Object.assign({},o,a))}return DrawBoxOptions}();var M=function(){function DrawBox(e,t){void 0===t&&(t={});this.box=new u(e);this.options=new E(t)}DrawBox.prototype.draw=function(e){var t=getContext2dOrThrow(e);var r=this.options,n=r.boxColor,a=r.lineWidth;var o=this.box,i=o.x,s=o.y,c=o.width,u=o.height;t.strokeStyle=n;t.lineWidth=a;t.strokeRect(i,s,c,u);var l=this.options.label;l&&new k([l],{x:i-a/2,y:s},this.options.drawLabelOptions).draw(e)};return DrawBox}();function drawDetections(e,t){var r=Array.isArray(t)?t:[t];r.forEach((function(t){var r=t instanceof p?t.score:isWithFaceDetection(t)?t.detection.score:void 0;var n=t instanceof p?t.box:isWithFaceDetection(t)?t.detection.box:new u(t);var a=r?""+round(r):void 0;new M(n,{label:a}).draw(e)}))}function isMediaLoaded(e){var t=T.getEnv(),r=t.Image,n=t.Video;return e instanceof r&&e.complete||e instanceof n&&e.readyState>=3}function awaitMediaLoaded(e){return new Promise((function(t,r){if(e instanceof T.getEnv().Canvas||isMediaLoaded(e))return t();function onLoad(e){if(e.currentTarget){e.currentTarget.removeEventListener("load",onLoad);e.currentTarget.removeEventListener("error",onError);t(e)}}function onError(e){if(e.currentTarget){e.currentTarget.removeEventListener("load",onLoad);e.currentTarget.removeEventListener("error",onError);r(e)}}e.addEventListener("load",onLoad);e.addEventListener("error",onError)}))}function bufferToImage(e){return new Promise((function(t,r){if(!(e instanceof Blob))return r("bufferToImage - expected buf to be of type: Blob");var n=new FileReader;n.onload=function(){if("string"!==typeof n.result)return r("bufferToImage - expected reader.result to be a string, in onload");var e=T.getEnv().createImageElement();e.onload=function(){return t(e)};e.onerror=r;e.src=n.result};n.onerror=r;n.readAsDataURL(e)}))}function getMediaDimensions(e){var t=T.getEnv(),r=t.Image,n=t.Video;return e instanceof r?new i(e.naturalWidth,e.naturalHeight):e instanceof n?new i(e.videoWidth,e.videoHeight):new i(e.width,e.height)}function createCanvas(e){var t=e.width,r=e.height;var n=T.getEnv().createCanvasElement;var a=n();a.width=t;a.height=r;return a}function createCanvasFromMedia(e,t){var r=T.getEnv().ImageData;if(!(e instanceof r)&&!isMediaLoaded(e))throw new Error("createCanvasFromMedia - media has not finished loading yet");var n=t||getMediaDimensions(e),a=n.width,o=n.height;var i=createCanvas({width:a,height:o});e instanceof r?getContext2dOrThrow(i).putImageData(e,0,0):getContext2dOrThrow(i).drawImage(e,0,0,a,o);return i}function imageTensorToCanvas(t,r){return a(this,void 0,void 0,(function(){var n,a,i,s,c,u;return o(this,(function(o){switch(o.label){case 0:n=r||T.getEnv().createCanvasElement();a=t.shape.slice(isTensor4D(t)?1:0),i=a[0],s=a[1],c=a[2];u=e.tidy((function(){return t.as3D(i,s,c).toInt()}));return[4,e.browser.toPixels(u,n)];case 1:o.sent();u.dispose();return[2,n]}}))}))}function isMediaElement(e){var t=T.getEnv(),r=t.Image,n=t.Canvas,a=t.Video;return e instanceof r||e instanceof n||e instanceof a}function imageToSquare(e,t,r){void 0===r&&(r=false);var n=T.getEnv(),a=n.Image,o=n.Canvas;if(!(e instanceof a||e instanceof o))throw new Error("imageToSquare - expected arg0 to be HTMLImageElement | HTMLCanvasElement");var i=getMediaDimensions(e);var s=t/Math.max(i.height,i.width);var c=s*i.width;var u=s*i.height;var l=createCanvas({width:t,height:t});var h=e instanceof o?e:createCanvasFromMedia(e);var p=Math.abs(c-u)/2;var v=r&&c<u?p:0;var d=r&&u<c?p:0;getContext2dOrThrow(l).drawImage(h,v,d,c,u);return l}var S=function(){function NetInput(e,t){var r=this;void 0===t&&(t=false);this._imageTensors=[];this._canvases=[];this._treatAsBatchInput=false;this._inputDimensions=[];if(!Array.isArray(e))throw new Error("NetInput.constructor - expected inputs to be an Array of TResolvedNetInput or to be instanceof tf.Tensor4D, instead have "+e);this._treatAsBatchInput=t;this._batchSize=e.length;e.forEach((function(e,t){if(isTensor3D(e)){r._imageTensors[t]=e;r._inputDimensions[t]=e.shape}else if(isTensor4D(e)){var n=e.shape[0];if(1!==n)throw new Error("NetInput - tf.Tensor4D with batchSize "+n+" passed, but not supported in input array");r._imageTensors[t]=e;r._inputDimensions[t]=e.shape.slice(1)}else{var a=e instanceof T.getEnv().Canvas?e:createCanvasFromMedia(e);r._canvases[t]=a;r._inputDimensions[t]=[a.height,a.width,3]}}))}Object.defineProperty(NetInput.prototype,"imageTensors",{get:function(){return this._imageTensors},enumerable:true,configurable:true});Object.defineProperty(NetInput.prototype,"canvases",{get:function(){return this._canvases},enumerable:true,configurable:true});Object.defineProperty(NetInput.prototype,"isBatchInput",{get:function(){return this.batchSize>1||this._treatAsBatchInput},enumerable:true,configurable:true});Object.defineProperty(NetInput.prototype,"batchSize",{get:function(){return this._batchSize},enumerable:true,configurable:true});Object.defineProperty(NetInput.prototype,"inputDimensions",{get:function(){return this._inputDimensions},enumerable:true,configurable:true});Object.defineProperty(NetInput.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:true,configurable:true});Object.defineProperty(NetInput.prototype,"reshapedInputDimensions",{get:function(){var e=this;return range(this.batchSize,0,1).map((function(t,r){return e.getReshapedInputDimensions(r)}))},enumerable:true,configurable:true});NetInput.prototype.getInput=function(e){return this.canvases[e]||this.imageTensors[e]};NetInput.prototype.getInputDimensions=function(e){return this._inputDimensions[e]};NetInput.prototype.getInputHeight=function(e){return this._inputDimensions[e][0]};NetInput.prototype.getInputWidth=function(e){return this._inputDimensions[e][1]};NetInput.prototype.getReshapedInputDimensions=function(e){if("number"!==typeof this.inputSize)throw new Error("getReshapedInputDimensions - inputSize not set, toBatchTensor has not been called yet");var t=this.getInputWidth(e);var r=this.getInputHeight(e);return computeReshapedDimensions({width:t,height:r},this.inputSize)};
/**
     * Create a batch tensor from all input canvases and tensors
     * with size [batchSize, inputSize, inputSize, 3].
     *
     * @param inputSize Height and width of the tensor.
     * @param isCenterImage (optional, default: false) If true, add an equal amount of padding on
     * both sides of the minor dimension oof the image.
     * @returns The batch tensor.
     */NetInput.prototype.toBatchTensor=function(t,r){var n=this;void 0===r&&(r=true);this._inputSize=t;return e.tidy((function(){var a=range(n.batchSize,0,1).map((function(a){var o=n.getInput(a);if(o instanceof e.Tensor){var i=isTensor4D(o)?o:o.expandDims();i=padToSquare(i,r);i.shape[1]===t&&i.shape[2]===t||(i=e.image.resizeBilinear(i,[t,t]));return i.as3D(t,t,3)}if(o instanceof T.getEnv().Canvas)return e.browser.fromPixels(imageToSquare(o,t,r));throw new Error("toBatchTensor - at batchIdx "+a+", expected input to be instanceof tf.Tensor or instanceof HTMLCanvasElement, instead have "+o)}));var o=e.stack(a.map((function(e){return e.toFloat()}))).as4D(n.batchSize,t,t,3);return o}))};return NetInput}();
/**
 * Validates the input to make sure, they are valid net inputs and awaits all media elements
 * to be finished loading.
 *
 * @param input The input, which can be a media element or an array of different media elements.
 * @returns A NetInput instance, which can be passed into one of the neural networks.
 */function toNetInput(e){return a(this,void 0,void 0,(function(){var t,r,n;return o(this,(function(a){switch(a.label){case 0:if(e instanceof S)return[2,e];t=Array.isArray(e)?e:[e];if(!t.length)throw new Error("toNetInput - empty array passed as input");r=function(t){return Array.isArray(e)?" at input index "+t+":":""};n=t.map(resolveInput);n.forEach((function(e,n){if(!isMediaElement(e)&&!isTensor3D(e)&&!isTensor4D(e)){if("string"===typeof t[n])throw new Error("toNetInput -"+r(n)+" string passed, but could not resolve HTMLElement for element id "+t[n]);throw new Error("toNetInput -"+r(n)+" expected media to be of type HTMLImageElement | HTMLVideoElement | HTMLCanvasElement | tf.Tensor3D, or to be an element id")}if(isTensor4D(e)){var a=e.shape[0];if(1!==a)throw new Error("toNetInput -"+r(n)+" tf.Tensor4D with batchSize "+a+" passed, but not supported in input array")}}));return[4,Promise.all(n.map((function(e){return isMediaElement(e)&&awaitMediaLoaded(e)})))];case 1:a.sent();return[2,new S(n,Array.isArray(e))]}}))}))}
/**
 * Extracts the image regions containing the detected faces.
 *
 * @param input The image that face detection has been performed on.
 * @param detections The face detection results or face bounding boxes for that image.
 * @returns The Canvases of the corresponding image region for each detected face.
 */function extractFaces(e,t){return a(this,void 0,void 0,(function(){var r,n,a,i,s,c,u;return o(this,(function(o){switch(o.label){case 0:r=T.getEnv().Canvas;n=e;return e instanceof r?[3,5]:[4,toNetInput(e)];case 1:a=o.sent();if(a.batchSize>1)throw new Error("extractFaces - batchSize > 1 not supported");i=a.getInput(0);if(!(i instanceof r))return[3,2];s=i;return[3,4];case 2:return[4,imageTensorToCanvas(i)];case 3:s=o.sent();o.label=4;case 4:n=s;o.label=5;case 5:c=getContext2dOrThrow(n);u=t.map((function(e){return e instanceof p?e.forSize(n.width,n.height).box.floor():e})).map((function(e){return e.clipAtImageBorders(n.width,n.height)}));return[2,u.map((function(e){var t=e.x,r=e.y,n=e.width,a=e.height;var o=createCanvas({width:n,height:a});getContext2dOrThrow(o).putImageData(c.getImageData(t,r,n,a),0,0);return o}))]}}))}))}
/**
 * Extracts the tensors of the image regions containing the detected faces.
 * Useful if you want to compute the face descriptors for the face images.
 * Using this method is faster then extracting a canvas for each face and
 * converting them to tensors individually.
 *
 * @param imageTensor The image tensor that face detection has been performed on.
 * @param detections The face detection results or face bounding boxes for that image.
 * @returns Tensors of the corresponding image region for each detected face.
 */function extractFaceTensors(t,r){return a(this,void 0,void 0,(function(){return o(this,(function(n){if(!isTensor3D(t)&&!isTensor4D(t))throw new Error("extractFaceTensors - expected image tensor to be 3D or 4D");if(isTensor4D(t)&&t.shape[0]>1)throw new Error("extractFaceTensors - batchSize > 1 not supported");return[2,e.tidy((function(){var n=t.shape.slice(isTensor4D(t)?1:0),a=n[0],o=n[1],i=n[2];var s=r.map((function(e){return e instanceof p?e.forSize(o,a).box:e})).map((function(e){return e.clipAtImageBorders(o,a)}));var c=s.map((function(r){var n=r.x,s=r.y,c=r.width,u=r.height;return e.slice3d(t.as3D(a,o,i),[s,n,0],[u,c,i])}));return c}))]}))}))}function fetchOrThrow(e,t){return a(this,void 0,void 0,(function(){var r,n;return o(this,(function(a){switch(a.label){case 0:r=T.getEnv().fetch;return[4,r(e,t)];case 1:n=a.sent();if(!(n.status<400))throw new Error("failed to fetch: ("+n.status+") "+n.statusText+", from url: "+n.url);return[2,n]}}))}))}function fetchImage(e){return a(this,void 0,void 0,(function(){var t,r;return o(this,(function(n){switch(n.label){case 0:return[4,fetchOrThrow(e)];case 1:t=n.sent();return[4,t.blob()];case 2:r=n.sent();if(!r.type.startsWith("image/"))throw new Error("fetchImage - expected blob type to be of type image/*, instead have: "+r.type+", for url: "+t.url);return[2,bufferToImage(r)]}}))}))}function fetchJson(e){return a(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,fetchOrThrow(e)];case 1:return[2,t.sent().json()]}}))}))}function fetchNetWeights(e){return a(this,void 0,void 0,(function(){var t;return o(this,(function(r){switch(r.label){case 0:t=Float32Array.bind;return[4,fetchOrThrow(e)];case 1:return[4,r.sent().arrayBuffer()];case 2:return[2,new(t.apply(Float32Array,[void 0,r.sent()]))]}}))}))}function getModelUris(e,t){var r=t+"-weights_manifest.json";if(!e)return{modelBaseUri:"",manifestUri:r};if("/"===e)return{modelBaseUri:"/",manifestUri:"/"+r};var n=e.startsWith("http://")?"http://":e.startsWith("https://")?"https://":"";e=e.replace(n,"");var a=e.split("/").filter((function(e){return e}));var o=e.endsWith(".json")?a[a.length-1]:r;var i=n+(e.endsWith(".json")?a.slice(0,a.length-1):a).join("/");i=e.startsWith("/")?"/"+i:i;return{modelBaseUri:i,manifestUri:"/"===i?"/"+o:i+"/"+o}}function loadWeightMap(t,r){return a(this,void 0,void 0,(function(){var n,a,i,s;return o(this,(function(o){switch(o.label){case 0:n=getModelUris(t,r),a=n.manifestUri,i=n.modelBaseUri;return[4,fetchJson(a)];case 1:s=o.sent();return[2,e.io.loadWeights(s,i)]}}))}))}function matchDimensions(e,t,r){void 0===r&&(r=false);var n=r?getMediaDimensions(t):t,a=n.width,o=n.height;e.width=a;e.height=o;return{width:a,height:o}}var L=function(){function NeuralNetwork(e){this._name=e;this._params=void 0;this._paramMappings=[]}Object.defineProperty(NeuralNetwork.prototype,"params",{get:function(){return this._params},enumerable:true,configurable:true});Object.defineProperty(NeuralNetwork.prototype,"paramMappings",{get:function(){return this._paramMappings},enumerable:true,configurable:true});Object.defineProperty(NeuralNetwork.prototype,"isLoaded",{get:function(){return!!this.params},enumerable:true,configurable:true});NeuralNetwork.prototype.getParamFromPath=function(e){var t=this.traversePropertyPath(e),r=t.obj,n=t.objProp;return r[n]};NeuralNetwork.prototype.reassignParamFromPath=function(e,t){var r=this.traversePropertyPath(e),n=r.obj,a=r.objProp;n[a].dispose();n[a]=t};NeuralNetwork.prototype.getParamList=function(){var e=this;return this._paramMappings.map((function(t){var r=t.paramPath;return{path:r,tensor:e.getParamFromPath(r)}}))};NeuralNetwork.prototype.getTrainableParams=function(){return this.getParamList().filter((function(t){return t.tensor instanceof e.Variable}))};NeuralNetwork.prototype.getFrozenParams=function(){return this.getParamList().filter((function(t){return!(t.tensor instanceof e.Variable)}))};NeuralNetwork.prototype.variable=function(){var e=this;this.getFrozenParams().forEach((function(t){var r=t.path,n=t.tensor;e.reassignParamFromPath(r,n.variable())}))};NeuralNetwork.prototype.freeze=function(){var t=this;this.getTrainableParams().forEach((function(r){var n=r.path,a=r.tensor;var o=e.tensor(a.dataSync());a.dispose();t.reassignParamFromPath(n,o)}))};NeuralNetwork.prototype.dispose=function(e){void 0===e&&(e=true);this.getParamList().forEach((function(t){if(e&&t.tensor.isDisposed)throw new Error("param tensor has already been disposed for path "+t.path);t.tensor.dispose()}));this._params=void 0};NeuralNetwork.prototype.serializeParams=function(){return new Float32Array(this.getParamList().map((function(e){var t=e.tensor;return Array.from(t.dataSync())})).reduce((function(e,t){return e.concat(t)})))};NeuralNetwork.prototype.load=function(e){return a(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:if(e instanceof Float32Array){this.extractWeights(e);return[2]}return[4,this.loadFromUri(e)];case 1:t.sent();return[2]}}))}))};NeuralNetwork.prototype.loadFromUri=function(e){return a(this,void 0,void 0,(function(){var t;return o(this,(function(r){switch(r.label){case 0:if(e&&"string"!==typeof e)throw new Error(this._name+".loadFromUri - expected model uri");return[4,loadWeightMap(e,this.getDefaultModelName())];case 1:t=r.sent();this.loadFromWeightMap(t);return[2]}}))}))};NeuralNetwork.prototype.loadFromDisk=function(t){return a(this,void 0,void 0,(function(){var r,n,a,i,s,c,u,l,h,p;return o(this,(function(o){switch(o.label){case 0:if(t&&"string"!==typeof t)throw new Error(this._name+".loadFromDisk - expected model file path");r=T.getEnv().readFile;n=getModelUris(t,this.getDefaultModelName()),a=n.manifestUri,i=n.modelBaseUri;s=function(e){return Promise.all(e.map((function(e){return r(e).then((function(e){return e.buffer}))})))};c=e.io.weightsLoaderFactory(s);h=(l=JSON).parse;return[4,r(a)];case 1:u=h.apply(l,[o.sent().toString()]);return[4,c(u,i)];case 2:p=o.sent();this.loadFromWeightMap(p);return[2]}}))}))};NeuralNetwork.prototype.loadFromWeightMap=function(e){var t=this.extractParamsFromWeigthMap(e),r=t.paramMappings,n=t.params;this._paramMappings=r;this._params=n};NeuralNetwork.prototype.extractWeights=function(e){var t=this.extractParams(e),r=t.paramMappings,n=t.params;this._paramMappings=r;this._params=n};NeuralNetwork.prototype.traversePropertyPath=function(t){if(!this.params)throw new Error("traversePropertyPath - model has no loaded params");var r=t.split("/").reduce((function(e,r){if(!e.nextObj.hasOwnProperty(r))throw new Error("traversePropertyPath - object does not have property "+r+", for path "+t);return{obj:e.nextObj,objProp:r,nextObj:e.nextObj[r]}}),{nextObj:this.params});var n=r.obj,a=r.objProp;if(!n||!a||!(n[a]instanceof e.Tensor))throw new Error("traversePropertyPath - parameter is not a tensor, for path "+t);return{obj:n,objProp:a}};return NeuralNetwork}();function depthwiseSeparableConv$1(t,r,n){return e.tidy((function(){var a=e.separableConv2d(t,r.depthwise_filter,r.pointwise_filter,n,"same");a=e.add(a,r.bias);return a}))}function denseBlock3(t,r,n){void 0===n&&(n=false);return e.tidy((function(){var a=e.relu(n?e.add(e.conv2d(t,r.conv0.filters,[2,2],"same"),r.conv0.bias):depthwiseSeparableConv$1(t,r.conv0,[2,2]));var o=depthwiseSeparableConv$1(a,r.conv1,[1,1]);var i=e.relu(e.add(a,o));var s=depthwiseSeparableConv$1(i,r.conv2,[1,1]);return e.relu(e.add(a,e.add(o,s)))}))}function denseBlock4(t,r,n,a){void 0===n&&(n=false);void 0===a&&(a=true);return e.tidy((function(){var o=e.relu(n?e.add(e.conv2d(t,r.conv0.filters,a?[2,2]:[1,1],"same"),r.conv0.bias):depthwiseSeparableConv$1(t,r.conv0,a?[2,2]:[1,1]));var i=depthwiseSeparableConv$1(o,r.conv1,[1,1]);var s=e.relu(e.add(o,i));var c=depthwiseSeparableConv$1(s,r.conv2,[1,1]);var u=e.relu(e.add(o,e.add(i,c)));var l=depthwiseSeparableConv$1(u,r.conv3,[1,1]);return e.relu(e.add(o,e.add(i,e.add(c,l))))}))}function convLayer$1(t,r,n,a){void 0===n&&(n="same");void 0===a&&(a=false);return e.tidy((function(){var o=e.add(e.conv2d(t,r.filters,[1,1],n),r.bias);return a?e.relu(o):o}))}function disposeUnusedWeightTensors(e,t){Object.keys(e).forEach((function(r){t.some((function(e){return e.originalPath===r}))||e[r].dispose()}))}function extractConvParamsFactory(t,r){return function(n,a,o,i){var s=e.tensor4d(t(n*a*o*o),[o,o,n,a]);var c=e.tensor1d(t(a));r.push({paramPath:i+"/filters"},{paramPath:i+"/bias"});return{filters:s,bias:c}}}function extractFCParamsFactory(t,r){return function(n,a,o){var i=e.tensor2d(t(n*a),[n,a]);var s=e.tensor1d(t(a));r.push({paramPath:o+"/weights"},{paramPath:o+"/bias"});return{weights:i,bias:s}}}var N=function(){function SeparableConvParams(e,t,r){this.depthwise_filter=e;this.pointwise_filter=t;this.bias=r}return SeparableConvParams}();function extractSeparableConvParamsFactory(t,r){return function(n,a,o){var i=e.tensor4d(t(9*n),[3,3,n,1]);var s=e.tensor4d(t(n*a),[1,1,n,a]);var c=e.tensor1d(t(a));r.push({paramPath:o+"/depthwise_filter"},{paramPath:o+"/pointwise_filter"},{paramPath:o+"/bias"});return new N(i,s,c)}}function loadSeparableConvParamsFactory(e){return function(t){var r=e(t+"/depthwise_filter",4);var n=e(t+"/pointwise_filter",4);var a=e(t+"/bias",1);return new N(r,n,a)}}function extractWeightEntryFactory(e,t){return function(r,n,a){var o=e[r];if(!isTensor(o,n))throw new Error("expected weightMap["+r+"] to be a Tensor"+n+"D, instead have "+o);t.push({originalPath:r,paramPath:a||r});return o}}function extractWeightsFactory(e){var t=e;function extractWeights(e){var r=t.slice(0,e);t=t.slice(e);return r}function getRemainingWeights(){return t}return{extractWeights:extractWeights,getRemainingWeights:getRemainingWeights}}function extractorsFactory$9(e,t){var r=extractConvParamsFactory(e,t);var n=extractSeparableConvParamsFactory(e,t);function extractDenseBlock3Params(e,t,a,o){void 0===o&&(o=false);var i=o?r(e,t,3,a+"/conv0"):n(e,t,a+"/conv0");var s=n(t,t,a+"/conv1");var c=n(t,t,a+"/conv2");return{conv0:i,conv1:s,conv2:c}}function extractDenseBlock4Params(e,t,r,a){void 0===a&&(a=false);var o=extractDenseBlock3Params(e,t,r,a),i=o.conv0,s=o.conv1,c=o.conv2;var u=n(t,t,r+"/conv3");return{conv0:i,conv1:s,conv2:c,conv3:u}}return{extractDenseBlock3Params:extractDenseBlock3Params,extractDenseBlock4Params:extractDenseBlock4Params}}function extractParams$7(e){var t=[];var r=extractWeightsFactory(e),n=r.extractWeights,a=r.getRemainingWeights;var o=extractorsFactory$9(n,t).extractDenseBlock4Params;var i=o(3,32,"dense0",true);var s=o(32,64,"dense1");var c=o(64,128,"dense2");var u=o(128,256,"dense3");if(0!==a().length)throw new Error("weights remaing after extract: "+a().length);return{paramMappings:t,params:{dense0:i,dense1:s,dense2:c,dense3:u}}}function loadConvParamsFactory(e){return function(t){var r=e(t+"/filters",4);var n=e(t+"/bias",1);return{filters:r,bias:n}}}function loadParamsFactory$1(e,t){var r=extractWeightEntryFactory(e,t);var n=loadConvParamsFactory(r);var a=loadSeparableConvParamsFactory(r);function extractDenseBlock3Params(e,t){void 0===t&&(t=false);var r=t?n(e+"/conv0"):a(e+"/conv0");var o=a(e+"/conv1");var i=a(e+"/conv2");return{conv0:r,conv1:o,conv2:i}}function extractDenseBlock4Params(e,t){void 0===t&&(t=false);var r=t?n(e+"/conv0"):a(e+"/conv0");var o=a(e+"/conv1");var i=a(e+"/conv2");var s=a(e+"/conv3");return{conv0:r,conv1:o,conv2:i,conv3:s}}return{extractDenseBlock3Params:extractDenseBlock3Params,extractDenseBlock4Params:extractDenseBlock4Params}}function extractParamsFromWeigthMap$7(e){var t=[];var r=loadParamsFactory$1(e,t).extractDenseBlock4Params;var n={dense0:r("dense0",true),dense1:r("dense1"),dense2:r("dense2"),dense3:r("dense3")};disposeUnusedWeightTensors(e,t);return{params:n,paramMappings:t}}var B=function(r){t(FaceFeatureExtractor,r);function FaceFeatureExtractor(){return r.call(this,"FaceFeatureExtractor")||this}FaceFeatureExtractor.prototype.forwardInput=function(t){var r=this.params;if(!r)throw new Error("FaceFeatureExtractor - load model before inference");return e.tidy((function(){var n=t.toBatchTensor(112,true);var a=[122.782,117.001,104.298];var o=normalize$1(n,a).div(e.scalar(255));var i=denseBlock4(o,r.dense0,true);i=denseBlock4(i,r.dense1);i=denseBlock4(i,r.dense2);i=denseBlock4(i,r.dense3);i=e.avgPool(i,[7,7],[2,2],"valid");return i}))};FaceFeatureExtractor.prototype.forward=function(e){return a(this,void 0,void 0,(function(){var t;return o(this,(function(r){switch(r.label){case 0:t=this.forwardInput;return[4,toNetInput(e)];case 1:return[2,t.apply(this,[r.sent()])]}}))}))};FaceFeatureExtractor.prototype.getDefaultModelName=function(){return"face_feature_extractor_model"};FaceFeatureExtractor.prototype.extractParamsFromWeigthMap=function(e){return extractParamsFromWeigthMap$7(e)};FaceFeatureExtractor.prototype.extractParams=function(e){return extractParams$7(e)};return FaceFeatureExtractor}(L);function fullyConnectedLayer(t,r){return e.tidy((function(){return e.add(e.matMul(t,r.weights),r.bias)}))}function extractParams$6(e,t,r){var n=[];var a=extractWeightsFactory(e),o=a.extractWeights,i=a.getRemainingWeights;var s=extractFCParamsFactory(o,n);var c=s(t,r,"fc");if(0!==i().length)throw new Error("weights remaing after extract: "+i().length);return{paramMappings:n,params:{fc:c}}}function extractParamsFromWeigthMap$6(e){var t=[];var r=extractWeightEntryFactory(e,t);function extractFcParams(e){var t=r(e+"/weights",2);var n=r(e+"/bias",1);return{weights:t,bias:n}}var n={fc:extractFcParams("fc")};disposeUnusedWeightTensors(e,t);return{params:n,paramMappings:t}}function seperateWeightMaps(e){var t={};var r={};Object.keys(e).forEach((function(n){var a=n.startsWith("fc")?r:t;a[n]=e[n]}));return{featureExtractorMap:t,classifierMap:r}}var A=function(r){t(FaceProcessor,r);function FaceProcessor(e,t){var n=r.call(this,e)||this;n._faceFeatureExtractor=t;return n}Object.defineProperty(FaceProcessor.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:true,configurable:true});FaceProcessor.prototype.runNet=function(t){var r=this;var n=this.params;if(!n)throw new Error(this._name+" - load model before inference");return e.tidy((function(){var e=t instanceof S?r.faceFeatureExtractor.forwardInput(t):t;return fullyConnectedLayer(e.as2D(e.shape[0],-1),n.fc)}))};FaceProcessor.prototype.dispose=function(e){void 0===e&&(e=true);this.faceFeatureExtractor.dispose(e);r.prototype.dispose.call(this,e)};FaceProcessor.prototype.loadClassifierParams=function(e){var t=this.extractClassifierParams(e),r=t.params,n=t.paramMappings;this._params=r;this._paramMappings=n};FaceProcessor.prototype.extractClassifierParams=function(e){return extractParams$6(e,this.getClassifierChannelsIn(),this.getClassifierChannelsOut())};FaceProcessor.prototype.extractParamsFromWeigthMap=function(e){var t=seperateWeightMaps(e),r=t.featureExtractorMap,n=t.classifierMap;this.faceFeatureExtractor.loadFromWeightMap(r);return extractParamsFromWeigthMap$6(n)};FaceProcessor.prototype.extractParams=function(e){var t=this.getClassifierChannelsIn();var r=this.getClassifierChannelsOut();var n=r*t+r;var a=e.slice(0,e.length-n);var o=e.slice(e.length-n);this.faceFeatureExtractor.extractWeights(a);return this.extractClassifierParams(o)};return FaceProcessor}(L);var W=["neutral","happy","sad","angry","fearful","disgusted","surprised"];var O=function(){function FaceExpressions(e){var t=this;if(7!==e.length)throw new Error("FaceExpressions.constructor - expected probabilities.length to be 7, have: "+e.length);W.forEach((function(r,n){t[r]=e[n]}))}FaceExpressions.prototype.asSortedArray=function(){var e=this;return W.map((function(t){return{expression:t,probability:e[t]}})).sort((function(e,t){return t.probability-e.probability}))};return FaceExpressions}();var I=function(r){t(FaceExpressionNet,r);function FaceExpressionNet(e){void 0===e&&(e=new B);return r.call(this,"FaceExpressionNet",e)||this}FaceExpressionNet.prototype.forwardInput=function(t){var r=this;return e.tidy((function(){return e.softmax(r.runNet(t))}))};FaceExpressionNet.prototype.forward=function(e){return a(this,void 0,void 0,(function(){var t;return o(this,(function(r){switch(r.label){case 0:t=this.forwardInput;return[4,toNetInput(e)];case 1:return[2,t.apply(this,[r.sent()])]}}))}))};FaceExpressionNet.prototype.predictExpressions=function(t){return a(this,void 0,void 0,(function(){var r,n,i,s;var c=this;return o(this,(function(u){switch(u.label){case 0:return[4,toNetInput(t)];case 1:r=u.sent();return[4,this.forwardInput(r)];case 2:n=u.sent();return[4,Promise.all(e.unstack(n).map((function(e){return a(c,void 0,void 0,(function(){var t;return o(this,(function(r){switch(r.label){case 0:return[4,e.data()];case 1:t=r.sent();e.dispose();return[2,t]}}))}))})))];case 3:i=u.sent();n.dispose();s=i.map((function(e){return new O(e)}));return[2,r.isBatchInput?s:s[0]]}}))}))};FaceExpressionNet.prototype.getDefaultModelName=function(){return"face_expression_model"};FaceExpressionNet.prototype.getClassifierChannelsIn=function(){return 256};FaceExpressionNet.prototype.getClassifierChannelsOut=function(){return 7};return FaceExpressionNet}(A);function isWithFaceExpressions(e){return e.expressions instanceof O}function extendWithFaceExpressions(e,t){var r={expressions:t};return Object.assign({},e,r)}function drawFaceExpressions(e,t,r,n){void 0===r&&(r=.1);var a=Array.isArray(t)?t:[t];a.forEach((function(t){var a=t instanceof O?t:isWithFaceExpressions(t)?t.expressions:void 0;if(!a)throw new Error("drawFaceExpressions - expected faceExpressions to be FaceExpressions | WithFaceExpressions<{}> or array thereof");var o=a.asSortedArray();var i=o.filter((function(e){return e.probability>r}));var s=isWithFaceDetection(t)?t.detection.box.bottomLeft:n||new c(0,0);var u=new k(i.map((function(e){return e.expression+" ("+round(e.probability)+")"})),s);u.draw(e)}))}function isWithFaceLandmarks(e){return isWithFaceDetection(e)&&e.landmarks instanceof g&&e.unshiftedLandmarks instanceof g&&e.alignedRect instanceof p}function extendWithFaceLandmarks(e,t){var r=e.detection.box;var n=t.shiftBy(r.x,r.y);var a=n.align();var o=e.detection.imageDims;var i=new p(e.detection.score,a.rescale(o.reverse()),o);var s={landmarks:n,unshiftedLandmarks:t,alignedRect:i};return Object.assign({},e,s)}var R=function(){function DrawFaceLandmarksOptions(e){void 0===e&&(e={});var t=e.drawLines,r=void 0===t||t,n=e.drawPoints,a=void 0===n||n,o=e.lineWidth,i=e.lineColor,s=e.pointSize,c=e.pointColor;this.drawLines=r;this.drawPoints=a;this.lineWidth=o||1;this.pointSize=s||2;this.lineColor=i||"rgba(0, 255, 255, 1)";this.pointColor=c||"rgba(255, 0, 255, 1)"}return DrawFaceLandmarksOptions}();var j=function(){function DrawFaceLandmarks(e,t){void 0===t&&(t={});this.faceLandmarks=e;this.options=new R(t)}DrawFaceLandmarks.prototype.draw=function(e){var t=getContext2dOrThrow(e);var r=this.options,n=r.drawLines,a=r.drawPoints,o=r.lineWidth,i=r.lineColor,s=r.pointSize,c=r.pointColor;if(n&&this.faceLandmarks instanceof y){t.strokeStyle=i;t.lineWidth=o;drawContour(t,this.faceLandmarks.getJawOutline());drawContour(t,this.faceLandmarks.getLeftEyeBrow());drawContour(t,this.faceLandmarks.getRightEyeBrow());drawContour(t,this.faceLandmarks.getNose());drawContour(t,this.faceLandmarks.getLeftEye(),true);drawContour(t,this.faceLandmarks.getRightEye(),true);drawContour(t,this.faceLandmarks.getMouth(),true)}if(a){t.strokeStyle=c;t.fillStyle=c;var drawPoint=function(e){t.beginPath();t.arc(e.x,e.y,s,0,2*Math.PI);t.fill()};this.faceLandmarks.positions.forEach(drawPoint)}};return DrawFaceLandmarks}();function drawFaceLandmarks(e,t){var r=Array.isArray(t)?t:[t];r.forEach((function(t){var r=t instanceof g?t:isWithFaceLandmarks(t)?t.landmarks:void 0;if(!r)throw new Error("drawFaceLandmarks - expected faceExpressions to be FaceLandmarks | WithFaceLandmarks<WithFaceDetection<{}>> or array thereof");new j(r).draw(e)}))}var z=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",drawContour:drawContour,drawDetections:drawDetections,drawFaceExpressions:drawFaceExpressions,DrawBoxOptions:E,DrawBox:M,DrawFaceLandmarksOptions:R,DrawFaceLandmarks:j,drawFaceLandmarks:drawFaceLandmarks,get AnchorPosition(){return C},DrawTextFieldOptions:D,DrawTextField:k});function extractorsFactory$8(e,t){var r=extractConvParamsFactory(e,t);var n=extractSeparableConvParamsFactory(e,t);function extractReductionBlockParams(e,t,a){var o=n(e,t,a+"/separable_conv0");var i=n(t,t,a+"/separable_conv1");var s=r(e,t,1,a+"/expansion_conv");return{separable_conv0:o,separable_conv1:i,expansion_conv:s}}function extractMainBlockParams(e,t){var r=n(e,e,t+"/separable_conv0");var a=n(e,e,t+"/separable_conv1");var o=n(e,e,t+"/separable_conv2");return{separable_conv0:r,separable_conv1:a,separable_conv2:o}}return{extractConvParams:r,extractSeparableConvParams:n,extractReductionBlockParams:extractReductionBlockParams,extractMainBlockParams:extractMainBlockParams}}function extractParams$5(e,t){var r=[];var n=extractWeightsFactory(e),a=n.extractWeights,o=n.getRemainingWeights;var i=extractorsFactory$8(a,r),s=i.extractConvParams,c=i.extractSeparableConvParams,u=i.extractReductionBlockParams,l=i.extractMainBlockParams;var h=s(3,32,3,"entry_flow/conv_in");var p=u(32,64,"entry_flow/reduction_block_0");var v=u(64,128,"entry_flow/reduction_block_1");var d={conv_in:h,reduction_block_0:p,reduction_block_1:v};var f={};range(t,0,1).forEach((function(e){f["main_block_"+e]=l(128,"middle_flow/main_block_"+e)}));var m=u(128,256,"exit_flow/reduction_block");var g=c(256,512,"exit_flow/separable_conv");var x={reduction_block:m,separable_conv:g};if(0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{paramMappings:r,params:{entry_flow:d,middle_flow:f,exit_flow:x}}}function loadParamsFactory(e,t){var r=extractWeightEntryFactory(e,t);var n=loadConvParamsFactory(r);var a=loadSeparableConvParamsFactory(r);function extractReductionBlockParams(e){var t=a(e+"/separable_conv0");var r=a(e+"/separable_conv1");var o=n(e+"/expansion_conv");return{separable_conv0:t,separable_conv1:r,expansion_conv:o}}function extractMainBlockParams(e){var t=a(e+"/separable_conv0");var r=a(e+"/separable_conv1");var n=a(e+"/separable_conv2");return{separable_conv0:t,separable_conv1:r,separable_conv2:n}}return{extractConvParams:n,extractSeparableConvParams:a,extractReductionBlockParams:extractReductionBlockParams,extractMainBlockParams:extractMainBlockParams}}function extractParamsFromWeigthMap$5(e,t){var r=[];var n=loadParamsFactory(e,r),a=n.extractConvParams,o=n.extractSeparableConvParams,i=n.extractReductionBlockParams,s=n.extractMainBlockParams;var c=a("entry_flow/conv_in");var u=i("entry_flow/reduction_block_0");var l=i("entry_flow/reduction_block_1");var h={conv_in:c,reduction_block_0:u,reduction_block_1:l};var p={};range(t,0,1).forEach((function(e){p["main_block_"+e]=s("middle_flow/main_block_"+e)}));var v=i("exit_flow/reduction_block");var d=o("exit_flow/separable_conv");var f={reduction_block:v,separable_conv:d};disposeUnusedWeightTensors(e,r);return{params:{entry_flow:h,middle_flow:p,exit_flow:f},paramMappings:r}}function conv$1(t,r,n){return e.add(e.conv2d(t,r.filters,n,"same"),r.bias)}function reductionBlock(t,r,n){void 0===n&&(n=true);var a=n?e.relu(t):t;a=depthwiseSeparableConv$1(a,r.separable_conv0,[1,1]);a=depthwiseSeparableConv$1(e.relu(a),r.separable_conv1,[1,1]);a=e.maxPool(a,[3,3],[2,2],"same");a=e.add(a,conv$1(t,r.expansion_conv,[2,2]));return a}function mainBlock(t,r){var n=depthwiseSeparableConv$1(e.relu(t),r.separable_conv0,[1,1]);n=depthwiseSeparableConv$1(e.relu(n),r.separable_conv1,[1,1]);n=depthwiseSeparableConv$1(e.relu(n),r.separable_conv2,[1,1]);n=e.add(n,t);return n}var $=function(r){t(TinyXception,r);function TinyXception(e){var t=r.call(this,"TinyXception")||this;t._numMainBlocks=e;return t}TinyXception.prototype.forwardInput=function(t){var r=this;var n=this.params;if(!n)throw new Error("TinyXception - load model before inference");return e.tidy((function(){var a=t.toBatchTensor(112,true);var o=[122.782,117.001,104.298];var i=normalize$1(a,o).div(e.scalar(256));var s=e.relu(conv$1(i,n.entry_flow.conv_in,[2,2]));s=reductionBlock(s,n.entry_flow.reduction_block_0,false);s=reductionBlock(s,n.entry_flow.reduction_block_1);range(r._numMainBlocks,0,1).forEach((function(e){s=mainBlock(s,n.middle_flow["main_block_"+e])}));s=reductionBlock(s,n.exit_flow.reduction_block);s=e.relu(depthwiseSeparableConv$1(s,n.exit_flow.separable_conv,[1,1]));return s}))};TinyXception.prototype.forward=function(e){return a(this,void 0,void 0,(function(){var t;return o(this,(function(r){switch(r.label){case 0:t=this.forwardInput;return[4,toNetInput(e)];case 1:return[2,t.apply(this,[r.sent()])]}}))}))};TinyXception.prototype.getDefaultModelName=function(){return"tiny_xception_model"};TinyXception.prototype.extractParamsFromWeigthMap=function(e){return extractParamsFromWeigthMap$5(e,this._numMainBlocks)};TinyXception.prototype.extractParams=function(e){return extractParams$5(e,this._numMainBlocks)};return TinyXception}(L);function extractParams$4(e){var t=[];var r=extractWeightsFactory(e),n=r.extractWeights,a=r.getRemainingWeights;var o=extractFCParamsFactory(n,t);var i=o(512,1,"fc/age");var s=o(512,2,"fc/gender");if(0!==a().length)throw new Error("weights remaing after extract: "+a().length);return{paramMappings:t,params:{fc:{age:i,gender:s}}}}function extractParamsFromWeigthMap$4(e){var t=[];var r=extractWeightEntryFactory(e,t);function extractFcParams(e){var t=r(e+"/weights",2);var n=r(e+"/bias",1);return{weights:t,bias:n}}var n={fc:{age:extractFcParams("fc/age"),gender:extractFcParams("fc/gender")}};disposeUnusedWeightTensors(e,t);return{params:n,paramMappings:t}}var G;(function(e){e.FEMALE="female";e.MALE="male"})(G||(G={}));var V=function(r){t(AgeGenderNet,r);function AgeGenderNet(e){void 0===e&&(e=new $(2));var t=r.call(this,"AgeGenderNet")||this;t._faceFeatureExtractor=e;return t}Object.defineProperty(AgeGenderNet.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:true,configurable:true});AgeGenderNet.prototype.runNet=function(t){var r=this;var n=this.params;if(!n)throw new Error(this._name+" - load model before inference");return e.tidy((function(){var a=t instanceof S?r.faceFeatureExtractor.forwardInput(t):t;var o=e.avgPool(a,[7,7],[2,2],"valid").as2D(a.shape[0],-1);var i=fullyConnectedLayer(o,n.fc.age).as1D();var s=fullyConnectedLayer(o,n.fc.gender);return{age:i,gender:s}}))};AgeGenderNet.prototype.forwardInput=function(t){var r=this;return e.tidy((function(){var n=r.runNet(t),a=n.age,o=n.gender;return{age:a,gender:e.softmax(o)}}))};AgeGenderNet.prototype.forward=function(e){return a(this,void 0,void 0,(function(){var t;return o(this,(function(r){switch(r.label){case 0:t=this.forwardInput;return[4,toNetInput(e)];case 1:return[2,t.apply(this,[r.sent()])]}}))}))};AgeGenderNet.prototype.predictAgeAndGender=function(t){return a(this,void 0,void 0,(function(){var r,n,i,s,c,u;var l=this;return o(this,(function(h){switch(h.label){case 0:return[4,toNetInput(t)];case 1:r=h.sent();return[4,this.forwardInput(r)];case 2:n=h.sent();i=e.unstack(n.age);s=e.unstack(n.gender);c=i.map((function(e,t){return{ageTensor:e,genderTensor:s[t]}}));return[4,Promise.all(c.map((function(e){var t=e.ageTensor,r=e.genderTensor;return a(l,void 0,void 0,(function(){var e,n,a,i,s;return o(this,(function(o){switch(o.label){case 0:return[4,t.data()];case 1:e=o.sent()[0];return[4,r.data()];case 2:n=o.sent()[0];a=n>.5;i=a?G.MALE:G.FEMALE;s=a?n:1-n;t.dispose();r.dispose();return[2,{age:e,gender:i,genderProbability:s}]}}))}))})))];case 3:u=h.sent();n.age.dispose();n.gender.dispose();return[2,r.isBatchInput?u:u[0]]}}))}))};AgeGenderNet.prototype.getDefaultModelName=function(){return"age_gender_model"};AgeGenderNet.prototype.dispose=function(e){void 0===e&&(e=true);this.faceFeatureExtractor.dispose(e);r.prototype.dispose.call(this,e)};AgeGenderNet.prototype.loadClassifierParams=function(e){var t=this.extractClassifierParams(e),r=t.params,n=t.paramMappings;this._params=r;this._paramMappings=n};AgeGenderNet.prototype.extractClassifierParams=function(e){return extractParams$4(e)};AgeGenderNet.prototype.extractParamsFromWeigthMap=function(e){var t=seperateWeightMaps(e),r=t.featureExtractorMap,n=t.classifierMap;this.faceFeatureExtractor.loadFromWeightMap(r);return extractParamsFromWeigthMap$4(n)};AgeGenderNet.prototype.extractParams=function(e){var t=1539;var r=e.slice(0,e.length-t);var n=e.slice(e.length-t);this.faceFeatureExtractor.extractWeights(r);return this.extractClassifierParams(n)};return AgeGenderNet}(L);var Y=function(r){t(FaceLandmark68NetBase,r);function FaceLandmark68NetBase(){return null!==r&&r.apply(this,arguments)||this}FaceLandmark68NetBase.prototype.postProcess=function(t,r,n){var a=n.map((function(e){var t=e.width,n=e.height;var a=r/Math.max(n,t);return{width:t*a,height:n*a}}));var o=a.length;return e.tidy((function(){var createInterleavedTensor=function(t,r){return e.stack([e.fill([68],t),e.fill([68],r)],1).as2D(1,136).as1D()};var getPadding=function(e,t){var r=a[e],n=r.width,o=r.height;return t(n,o)?Math.abs(n-o)/2:0};var getPaddingX=function(e){return getPadding(e,(function(e,t){return e<t}))};var getPaddingY=function(e){return getPadding(e,(function(e,t){return t<e}))};var n=t.mul(e.fill([o,136],r)).sub(e.stack(Array.from(Array(o),(function(e,t){return createInterleavedTensor(getPaddingX(t),getPaddingY(t))})))).div(e.stack(Array.from(Array(o),(function(e,t){return createInterleavedTensor(a[t].width,a[t].height)}))));return n}))};FaceLandmark68NetBase.prototype.forwardInput=function(t){var r=this;return e.tidy((function(){var e=r.runNet(t);return r.postProcess(e,t.inputSize,t.inputDimensions.map((function(e){var t=e[0],r=e[1];return{height:t,width:r}})))}))};FaceLandmark68NetBase.prototype.forward=function(e){return a(this,void 0,void 0,(function(){var t;return o(this,(function(r){switch(r.label){case 0:t=this.forwardInput;return[4,toNetInput(e)];case 1:return[2,t.apply(this,[r.sent()])]}}))}))};FaceLandmark68NetBase.prototype.detectLandmarks=function(t){return a(this,void 0,void 0,(function(){var r,n,i;var s=this;return o(this,(function(u){switch(u.label){case 0:return[4,toNetInput(t)];case 1:r=u.sent();n=e.tidy((function(){return e.unstack(s.forwardInput(r))}));return[4,Promise.all(n.map((function(e,t){return a(s,void 0,void 0,(function(){var n,a,i,s,u;return o(this,(function(o){switch(o.label){case 0:i=(a=Array).from;return[4,e.data()];case 1:n=i.apply(a,[o.sent()]);s=n.filter((function(e,t){return isEven(t)}));u=n.filter((function(e,t){return!isEven(t)}));return[2,new y(Array(68).fill(0).map((function(e,t){return new c(s[t],u[t])})),{height:r.getInputHeight(t),width:r.getInputWidth(t)})]}}))}))})))];case 2:i=u.sent();n.forEach((function(e){return e.dispose()}));return[2,r.isBatchInput?i:i[0]]}}))}))};FaceLandmark68NetBase.prototype.getClassifierChannelsOut=function(){return 136};return FaceLandmark68NetBase}(A);var H=function(e){t(FaceLandmark68Net,e);function FaceLandmark68Net(t){void 0===t&&(t=new B);return e.call(this,"FaceLandmark68Net",t)||this}FaceLandmark68Net.prototype.getDefaultModelName=function(){return"face_landmark_68_model"};FaceLandmark68Net.prototype.getClassifierChannelsIn=function(){return 256};return FaceLandmark68Net}(Y);function extractParamsFromWeigthMapTiny(e){var t=[];var r=loadParamsFactory$1(e,t).extractDenseBlock3Params;var n={dense0:r("dense0",true),dense1:r("dense1"),dense2:r("dense2")};disposeUnusedWeightTensors(e,t);return{params:n,paramMappings:t}}function extractParamsTiny(e){var t=[];var r=extractWeightsFactory(e),n=r.extractWeights,a=r.getRemainingWeights;var o=extractorsFactory$9(n,t).extractDenseBlock3Params;var i=o(3,32,"dense0",true);var s=o(32,64,"dense1");var c=o(64,128,"dense2");if(0!==a().length)throw new Error("weights remaing after extract: "+a().length);return{paramMappings:t,params:{dense0:i,dense1:s,dense2:c}}}var U=function(r){t(TinyFaceFeatureExtractor,r);function TinyFaceFeatureExtractor(){return r.call(this,"TinyFaceFeatureExtractor")||this}TinyFaceFeatureExtractor.prototype.forwardInput=function(t){var r=this.params;if(!r)throw new Error("TinyFaceFeatureExtractor - load model before inference");return e.tidy((function(){var n=t.toBatchTensor(112,true);var a=[122.782,117.001,104.298];var o=normalize$1(n,a).div(e.scalar(255));var i=denseBlock3(o,r.dense0,true);i=denseBlock3(i,r.dense1);i=denseBlock3(i,r.dense2);i=e.avgPool(i,[14,14],[2,2],"valid");return i}))};TinyFaceFeatureExtractor.prototype.forward=function(e){return a(this,void 0,void 0,(function(){var t;return o(this,(function(r){switch(r.label){case 0:t=this.forwardInput;return[4,toNetInput(e)];case 1:return[2,t.apply(this,[r.sent()])]}}))}))};TinyFaceFeatureExtractor.prototype.getDefaultModelName=function(){return"face_feature_extractor_tiny_model"};TinyFaceFeatureExtractor.prototype.extractParamsFromWeigthMap=function(e){return extractParamsFromWeigthMapTiny(e)};TinyFaceFeatureExtractor.prototype.extractParams=function(e){return extractParamsTiny(e)};return TinyFaceFeatureExtractor}(L);var J=function(e){t(FaceLandmark68TinyNet,e);function FaceLandmark68TinyNet(t){void 0===t&&(t=new U);return e.call(this,"FaceLandmark68TinyNet",t)||this}FaceLandmark68TinyNet.prototype.getDefaultModelName=function(){return"face_landmark_68_tiny_model"};FaceLandmark68TinyNet.prototype.getClassifierChannelsIn=function(){return 128};return FaceLandmark68TinyNet}(Y);var q=function(e){t(FaceLandmarkNet,e);function FaceLandmarkNet(){return null!==e&&e.apply(this,arguments)||this}return FaceLandmarkNet}(H);function scale(t,r){return e.add(e.mul(t,r.weights),r.biases)}function convLayer(t,r,n,a,o){void 0===o&&(o="same");var i=r.conv,s=i.filters,c=i.bias;var u=e.conv2d(t,s,n,o);u=e.add(u,c);u=scale(u,r.scale);return a?e.relu(u):u}function conv(e,t){return convLayer(e,t,[1,1],true)}function convNoRelu(e,t){return convLayer(e,t,[1,1],false)}function convDown(e,t){return convLayer(e,t,[2,2],true,"valid")}function extractorsFactory$7(t,r){function extractFilterValues(r,n,a){var o=t(r);var i=o.length/(n*a*a);if(isFloat(i))throw new Error("depth has to be an integer: "+i+", weights.length: "+o.length+", numFilters: "+n+", filterSize: "+a);return e.tidy((function(){return e.transpose(e.tensor4d(o,[n,i,a,a]),[2,3,1,0])}))}function extractConvParams(n,a,o,i){var s=extractFilterValues(n,a,o);var c=e.tensor1d(t(a));r.push({paramPath:i+"/filters"},{paramPath:i+"/bias"});return{filters:s,bias:c}}function extractScaleLayerParams(n,a){var o=e.tensor1d(t(n));var i=e.tensor1d(t(n));r.push({paramPath:a+"/weights"},{paramPath:a+"/biases"});return{weights:o,biases:i}}function extractConvLayerParams(e,t,r,n){var a=extractConvParams(e,t,r,n+"/conv");var o=extractScaleLayerParams(t,n+"/scale");return{conv:a,scale:o}}function extractResidualLayerParams(e,t,r,n,a){void 0===a&&(a=false);var o=extractConvLayerParams((a?.5:1)*e,t,r,n+"/conv1");var i=extractConvLayerParams(e,t,r,n+"/conv2");return{conv1:o,conv2:i}}return{extractConvLayerParams:extractConvLayerParams,extractResidualLayerParams:extractResidualLayerParams}}function extractParams$3(t){var r=extractWeightsFactory(t),n=r.extractWeights,a=r.getRemainingWeights;var o=[];var i=extractorsFactory$7(n,o),s=i.extractConvLayerParams,c=i.extractResidualLayerParams;var u=s(4704,32,7,"conv32_down");var l=c(9216,32,3,"conv32_1");var h=c(9216,32,3,"conv32_2");var p=c(9216,32,3,"conv32_3");var v=c(36864,64,3,"conv64_down",true);var d=c(36864,64,3,"conv64_1");var f=c(36864,64,3,"conv64_2");var m=c(36864,64,3,"conv64_3");var g=c(147456,128,3,"conv128_down",true);var x=c(147456,128,3,"conv128_1");var y=c(147456,128,3,"conv128_2");var b=c(589824,256,3,"conv256_down",true);var w=c(589824,256,3,"conv256_1");var _=c(589824,256,3,"conv256_2");var P=c(589824,256,3,"conv256_down_out");var F=e.tidy((function(){return e.transpose(e.tensor2d(n(32768),[128,256]),[1,0])}));o.push({paramPath:"fc"});if(0!==a().length)throw new Error("weights remaing after extract: "+a().length);var T={conv32_down:u,conv32_1:l,conv32_2:h,conv32_3:p,conv64_down:v,conv64_1:d,conv64_2:f,conv64_3:m,conv128_down:g,conv128_1:x,conv128_2:y,conv256_down:b,conv256_1:w,conv256_2:_,conv256_down_out:P,fc:F};return{params:T,paramMappings:o}}function extractorsFactory$6(e,t){var r=extractWeightEntryFactory(e,t);function extractScaleLayerParams(e){var t=r(e+"/scale/weights",1);var n=r(e+"/scale/biases",1);return{weights:t,biases:n}}function extractConvLayerParams(e){var t=r(e+"/conv/filters",4);var n=r(e+"/conv/bias",1);var a=extractScaleLayerParams(e);return{conv:{filters:t,bias:n},scale:a}}function extractResidualLayerParams(e){return{conv1:extractConvLayerParams(e+"/conv1"),conv2:extractConvLayerParams(e+"/conv2")}}return{extractConvLayerParams:extractConvLayerParams,extractResidualLayerParams:extractResidualLayerParams}}function extractParamsFromWeigthMap$3(e){var t=[];var r=extractorsFactory$6(e,t),n=r.extractConvLayerParams,a=r.extractResidualLayerParams;var o=n("conv32_down");var i=a("conv32_1");var s=a("conv32_2");var c=a("conv32_3");var u=a("conv64_down");var l=a("conv64_1");var h=a("conv64_2");var p=a("conv64_3");var v=a("conv128_down");var d=a("conv128_1");var f=a("conv128_2");var m=a("conv256_down");var g=a("conv256_1");var x=a("conv256_2");var y=a("conv256_down_out");var b=e.fc;t.push({originalPath:"fc",paramPath:"fc"});if(!isTensor2D(b))throw new Error("expected weightMap[fc] to be a Tensor2D, instead have "+b);var w={conv32_down:o,conv32_1:i,conv32_2:s,conv32_3:c,conv64_down:u,conv64_1:l,conv64_2:h,conv64_3:p,conv128_down:v,conv128_1:d,conv128_2:f,conv256_down:m,conv256_1:g,conv256_2:x,conv256_down_out:y,fc:b};disposeUnusedWeightTensors(e,t);return{params:w,paramMappings:t}}function residual(t,r){var n=conv(t,r.conv1);n=convNoRelu(n,r.conv2);n=e.add(n,t);n=e.relu(n);return n}function residualDown(t,n){var a=convDown(t,n.conv1);a=convNoRelu(a,n.conv2);var o=e.avgPool(t,2,2,"valid");var i=e.zeros(o.shape);var s=o.shape[3]!==a.shape[3];var c=o.shape[1]!==a.shape[1]||o.shape[2]!==a.shape[2];if(c){var u=r(a.shape);u[1]=1;var l=e.zeros(u);a=e.concat([a,l],1);var h=r(a.shape);h[2]=1;var p=e.zeros(h);a=e.concat([a,p],2)}o=s?e.concat([o,i],3):o;a=e.add(o,a);a=e.relu(a);return a}var X=function(r){t(FaceRecognitionNet,r);function FaceRecognitionNet(){return r.call(this,"FaceRecognitionNet")||this}FaceRecognitionNet.prototype.forwardInput=function(t){var r=this.params;if(!r)throw new Error("FaceRecognitionNet - load model before inference");return e.tidy((function(){var n=t.toBatchTensor(150,true).toFloat();var a=[122.782,117.001,104.298];var o=normalize$1(n,a).div(e.scalar(256));var i=convDown(o,r.conv32_down);i=e.maxPool(i,3,2,"valid");i=residual(i,r.conv32_1);i=residual(i,r.conv32_2);i=residual(i,r.conv32_3);i=residualDown(i,r.conv64_down);i=residual(i,r.conv64_1);i=residual(i,r.conv64_2);i=residual(i,r.conv64_3);i=residualDown(i,r.conv128_down);i=residual(i,r.conv128_1);i=residual(i,r.conv128_2);i=residualDown(i,r.conv256_down);i=residual(i,r.conv256_1);i=residual(i,r.conv256_2);i=residualDown(i,r.conv256_down_out);var s=i.mean([1,2]);var c=e.matMul(s,r.fc);return c}))};FaceRecognitionNet.prototype.forward=function(e){return a(this,void 0,void 0,(function(){var t;return o(this,(function(r){switch(r.label){case 0:t=this.forwardInput;return[4,toNetInput(e)];case 1:return[2,t.apply(this,[r.sent()])]}}))}))};FaceRecognitionNet.prototype.computeFaceDescriptor=function(t){return a(this,void 0,void 0,(function(){var r,n,a;var i=this;return o(this,(function(o){switch(o.label){case 0:return[4,toNetInput(t)];case 1:r=o.sent();n=e.tidy((function(){return e.unstack(i.forwardInput(r))}));return[4,Promise.all(n.map((function(e){return e.data()})))];case 2:a=o.sent();n.forEach((function(e){return e.dispose()}));return[2,r.isBatchInput?a:a[0]]}}))}))};FaceRecognitionNet.prototype.getDefaultModelName=function(){return"face_recognition_model"};FaceRecognitionNet.prototype.extractParamsFromWeigthMap=function(e){return extractParamsFromWeigthMap$3(e)};FaceRecognitionNet.prototype.extractParams=function(e){return extractParams$3(e)};return FaceRecognitionNet}(L);function createFaceRecognitionNet(e){var t=new X;t.extractWeights(e);return t}function extendWithFaceDescriptor(e,t){var r={descriptor:t};return Object.assign({},e,r)}function isWithAge(e){return"number"===typeof e.age}function extendWithAge(e,t){var r={age:t};return Object.assign({},e,r)}function isWithGender(e){return(e.gender===G.MALE||e.gender===G.FEMALE)&&isValidProbablitiy(e.genderProbability)}function extendWithGender(e,t,r){var n={gender:t,genderProbability:r};return Object.assign({},e,n)}var Z=function(){function MtcnnOptions(e){var t=void 0===e?{}:e,r=t.minFaceSize,n=t.scaleFactor,a=t.maxNumScales,o=t.scoreThresholds,i=t.scaleSteps;this._name="MtcnnOptions";this._minFaceSize=r||20;this._scaleFactor=n||.709;this._maxNumScales=a||10;this._scoreThresholds=o||[.6,.7,.7];this._scaleSteps=i;if("number"!==typeof this._minFaceSize||this._minFaceSize<0)throw new Error(this._name+" - expected minFaceSize to be a number > 0");if("number"!==typeof this._scaleFactor||this._scaleFactor<=0||this._scaleFactor>=1)throw new Error(this._name+" - expected scaleFactor to be a number between 0 and 1");if("number"!==typeof this._maxNumScales||this._maxNumScales<0)throw new Error(this._name+" - expected maxNumScales to be a number > 0");if(!Array.isArray(this._scoreThresholds)||3!==this._scoreThresholds.length||this._scoreThresholds.some((function(e){return"number"!==typeof e})))throw new Error(this._name+" - expected scoreThresholds to be an array of numbers of length 3");if(this._scaleSteps&&(!Array.isArray(this._scaleSteps)||this._scaleSteps.some((function(e){return"number"!==typeof e}))))throw new Error(this._name+" - expected scaleSteps to be an array of numbers")}Object.defineProperty(MtcnnOptions.prototype,"minFaceSize",{get:function(){return this._minFaceSize},enumerable:true,configurable:true});Object.defineProperty(MtcnnOptions.prototype,"scaleFactor",{get:function(){return this._scaleFactor},enumerable:true,configurable:true});Object.defineProperty(MtcnnOptions.prototype,"maxNumScales",{get:function(){return this._maxNumScales},enumerable:true,configurable:true});Object.defineProperty(MtcnnOptions.prototype,"scoreThresholds",{get:function(){return this._scoreThresholds},enumerable:true,configurable:true});Object.defineProperty(MtcnnOptions.prototype,"scaleSteps",{get:function(){return this._scaleSteps},enumerable:true,configurable:true});return MtcnnOptions}();function extractorsFactory$5(t,r){function extractDepthwiseConvParams(n,a){var o=e.tensor4d(t(9*n),[3,3,n,1]);var i=e.tensor1d(t(n));var s=e.tensor1d(t(n));var c=e.tensor1d(t(n));var u=e.tensor1d(t(n));r.push({paramPath:a+"/filters"},{paramPath:a+"/batch_norm_scale"},{paramPath:a+"/batch_norm_offset"},{paramPath:a+"/batch_norm_mean"},{paramPath:a+"/batch_norm_variance"});return{filters:o,batch_norm_scale:i,batch_norm_offset:s,batch_norm_mean:c,batch_norm_variance:u}}function extractConvParams(n,a,o,i,s){var c=e.tensor4d(t(n*a*o*o),[o,o,n,a]);var u=e.tensor1d(t(a));r.push({paramPath:i+"/filters"},{paramPath:i+"/"+(s?"batch_norm_offset":"bias")});return{filters:c,bias:u}}function extractPointwiseConvParams(e,t,r,n){var a=extractConvParams(e,t,r,n,true),o=a.filters,i=a.bias;return{filters:o,batch_norm_offset:i}}function extractConvPairParams(e,t,r){var n=extractDepthwiseConvParams(e,r+"/depthwise_conv");var a=extractPointwiseConvParams(e,t,1,r+"/pointwise_conv");return{depthwise_conv:n,pointwise_conv:a}}function extractMobilenetV1Params(){var e=extractPointwiseConvParams(3,32,3,"mobilenetv1/conv_0");var t=extractConvPairParams(32,64,"mobilenetv1/conv_1");var r=extractConvPairParams(64,128,"mobilenetv1/conv_2");var n=extractConvPairParams(128,128,"mobilenetv1/conv_3");var a=extractConvPairParams(128,256,"mobilenetv1/conv_4");var o=extractConvPairParams(256,256,"mobilenetv1/conv_5");var i=extractConvPairParams(256,512,"mobilenetv1/conv_6");var s=extractConvPairParams(512,512,"mobilenetv1/conv_7");var c=extractConvPairParams(512,512,"mobilenetv1/conv_8");var u=extractConvPairParams(512,512,"mobilenetv1/conv_9");var l=extractConvPairParams(512,512,"mobilenetv1/conv_10");var h=extractConvPairParams(512,512,"mobilenetv1/conv_11");var p=extractConvPairParams(512,1024,"mobilenetv1/conv_12");var v=extractConvPairParams(1024,1024,"mobilenetv1/conv_13");return{conv_0:e,conv_1:t,conv_2:r,conv_3:n,conv_4:a,conv_5:o,conv_6:i,conv_7:s,conv_8:c,conv_9:u,conv_10:l,conv_11:h,conv_12:p,conv_13:v}}function extractPredictionLayerParams(){var e=extractPointwiseConvParams(1024,256,1,"prediction_layer/conv_0");var t=extractPointwiseConvParams(256,512,3,"prediction_layer/conv_1");var r=extractPointwiseConvParams(512,128,1,"prediction_layer/conv_2");var n=extractPointwiseConvParams(128,256,3,"prediction_layer/conv_3");var a=extractPointwiseConvParams(256,128,1,"prediction_layer/conv_4");var o=extractPointwiseConvParams(128,256,3,"prediction_layer/conv_5");var i=extractPointwiseConvParams(256,64,1,"prediction_layer/conv_6");var s=extractPointwiseConvParams(64,128,3,"prediction_layer/conv_7");var c=extractConvParams(512,12,1,"prediction_layer/box_predictor_0/box_encoding_predictor");var u=extractConvParams(512,9,1,"prediction_layer/box_predictor_0/class_predictor");var l=extractConvParams(1024,24,1,"prediction_layer/box_predictor_1/box_encoding_predictor");var h=extractConvParams(1024,18,1,"prediction_layer/box_predictor_1/class_predictor");var p=extractConvParams(512,24,1,"prediction_layer/box_predictor_2/box_encoding_predictor");var v=extractConvParams(512,18,1,"prediction_layer/box_predictor_2/class_predictor");var d=extractConvParams(256,24,1,"prediction_layer/box_predictor_3/box_encoding_predictor");var f=extractConvParams(256,18,1,"prediction_layer/box_predictor_3/class_predictor");var m=extractConvParams(256,24,1,"prediction_layer/box_predictor_4/box_encoding_predictor");var g=extractConvParams(256,18,1,"prediction_layer/box_predictor_4/class_predictor");var x=extractConvParams(128,24,1,"prediction_layer/box_predictor_5/box_encoding_predictor");var y=extractConvParams(128,18,1,"prediction_layer/box_predictor_5/class_predictor");var b={box_encoding_predictor:c,class_predictor:u};var w={box_encoding_predictor:l,class_predictor:h};var _={box_encoding_predictor:p,class_predictor:v};var P={box_encoding_predictor:d,class_predictor:f};var F={box_encoding_predictor:m,class_predictor:g};var T={box_encoding_predictor:x,class_predictor:y};return{conv_0:e,conv_1:t,conv_2:r,conv_3:n,conv_4:a,conv_5:o,conv_6:i,conv_7:s,box_predictor_0:b,box_predictor_1:w,box_predictor_2:_,box_predictor_3:P,box_predictor_4:F,box_predictor_5:T}}return{extractMobilenetV1Params:extractMobilenetV1Params,extractPredictionLayerParams:extractPredictionLayerParams}}function extractParams$2(t){var r=[];var n=extractWeightsFactory(t),a=n.extractWeights,o=n.getRemainingWeights;var i=extractorsFactory$5(a,r),s=i.extractMobilenetV1Params,c=i.extractPredictionLayerParams;var u=s();var l=c();var h=e.tensor3d(a(20472),[1,5118,4]);var p={extra_dim:h};r.push({paramPath:"output_layer/extra_dim"});if(0!==o().length)throw new Error("weights remaing after extract: "+o().length);return{params:{mobilenetv1:u,prediction_layer:l,output_layer:p},paramMappings:r}}function extractorsFactory$4(e,t){var r=extractWeightEntryFactory(e,t);function extractPointwiseConvParams(e,t,n){var a=r(e+"/Conv2d_"+t+"_pointwise/weights",4,n+"/filters");var o=r(e+"/Conv2d_"+t+"_pointwise/convolution_bn_offset",1,n+"/batch_norm_offset");return{filters:a,batch_norm_offset:o}}function extractConvPairParams(e){var t="mobilenetv1/conv_"+e;var n="MobilenetV1/Conv2d_"+e+"_depthwise";var a=t+"/depthwise_conv";var o=t+"/pointwise_conv";var i=r(n+"/depthwise_weights",4,a+"/filters");var s=r(n+"/BatchNorm/gamma",1,a+"/batch_norm_scale");var c=r(n+"/BatchNorm/beta",1,a+"/batch_norm_offset");var u=r(n+"/BatchNorm/moving_mean",1,a+"/batch_norm_mean");var l=r(n+"/BatchNorm/moving_variance",1,a+"/batch_norm_variance");return{depthwise_conv:{filters:i,batch_norm_scale:s,batch_norm_offset:c,batch_norm_mean:u,batch_norm_variance:l},pointwise_conv:extractPointwiseConvParams("MobilenetV1",e,o)}}function extractMobilenetV1Params(){return{conv_0:extractPointwiseConvParams("MobilenetV1",0,"mobilenetv1/conv_0"),conv_1:extractConvPairParams(1),conv_2:extractConvPairParams(2),conv_3:extractConvPairParams(3),conv_4:extractConvPairParams(4),conv_5:extractConvPairParams(5),conv_6:extractConvPairParams(6),conv_7:extractConvPairParams(7),conv_8:extractConvPairParams(8),conv_9:extractConvPairParams(9),conv_10:extractConvPairParams(10),conv_11:extractConvPairParams(11),conv_12:extractConvPairParams(12),conv_13:extractConvPairParams(13)}}function extractConvParams(e,t){var n=r(e+"/weights",4,t+"/filters");var a=r(e+"/biases",1,t+"/bias");return{filters:n,bias:a}}function extractBoxPredictorParams(e){var t=extractConvParams("Prediction/BoxPredictor_"+e+"/BoxEncodingPredictor","prediction_layer/box_predictor_"+e+"/box_encoding_predictor");var r=extractConvParams("Prediction/BoxPredictor_"+e+"/ClassPredictor","prediction_layer/box_predictor_"+e+"/class_predictor");return{box_encoding_predictor:t,class_predictor:r}}function extractPredictionLayerParams(){return{conv_0:extractPointwiseConvParams("Prediction",0,"prediction_layer/conv_0"),conv_1:extractPointwiseConvParams("Prediction",1,"prediction_layer/conv_1"),conv_2:extractPointwiseConvParams("Prediction",2,"prediction_layer/conv_2"),conv_3:extractPointwiseConvParams("Prediction",3,"prediction_layer/conv_3"),conv_4:extractPointwiseConvParams("Prediction",4,"prediction_layer/conv_4"),conv_5:extractPointwiseConvParams("Prediction",5,"prediction_layer/conv_5"),conv_6:extractPointwiseConvParams("Prediction",6,"prediction_layer/conv_6"),conv_7:extractPointwiseConvParams("Prediction",7,"prediction_layer/conv_7"),box_predictor_0:extractBoxPredictorParams(0),box_predictor_1:extractBoxPredictorParams(1),box_predictor_2:extractBoxPredictorParams(2),box_predictor_3:extractBoxPredictorParams(3),box_predictor_4:extractBoxPredictorParams(4),box_predictor_5:extractBoxPredictorParams(5)}}return{extractMobilenetV1Params:extractMobilenetV1Params,extractPredictionLayerParams:extractPredictionLayerParams}}function extractParamsFromWeigthMap$2(e){var t=[];var r=extractorsFactory$4(e,t),n=r.extractMobilenetV1Params,a=r.extractPredictionLayerParams;var o=e["Output/extra_dim"];t.push({originalPath:"Output/extra_dim",paramPath:"output_layer/extra_dim"});if(!isTensor3D(o))throw new Error("expected weightMap['Output/extra_dim'] to be a Tensor3D, instead have "+o);var i={mobilenetv1:n(),prediction_layer:a(),output_layer:{extra_dim:o}};disposeUnusedWeightTensors(e,t);return{params:i,paramMappings:t}}function pointwiseConvLayer(t,r,n){return e.tidy((function(){var a=e.conv2d(t,r.filters,n,"same");a=e.add(a,r.batch_norm_offset);return e.clipByValue(a,0,6)}))}var K=.0010000000474974513;function depthwiseConvLayer(t,r,n){return e.tidy((function(){var a=e.depthwiseConv2d(t,r.filters,n,"same");a=e.batchNorm(a,r.batch_norm_mean,r.batch_norm_variance,r.batch_norm_offset,r.batch_norm_scale,K);return e.clipByValue(a,0,6)}))}function getStridesForLayerIdx(e){return[2,4,6,12].some((function(t){return t===e}))?[2,2]:[1,1]}function mobileNetV1(t,r){return e.tidy((function(){var e=null;var n=pointwiseConvLayer(t,r.conv_0,[2,2]);var a=[r.conv_1,r.conv_2,r.conv_3,r.conv_4,r.conv_5,r.conv_6,r.conv_7,r.conv_8,r.conv_9,r.conv_10,r.conv_11,r.conv_12,r.conv_13];a.forEach((function(t,r){var a=r+1;var o=getStridesForLayerIdx(a);n=depthwiseConvLayer(n,t.depthwise_conv,o);n=pointwiseConvLayer(n,t.pointwise_conv,[1,1]);11===a&&(e=n)}));if(null===e)throw new Error("mobileNetV1 - output of conv layer 11 is null");return{out:n,conv11:e}}))}function nonMaxSuppression(e,t,r,n,a){var o=e.shape[0];var i=Math.min(r,o);var s=t.map((function(e,t){return{score:e,boxIndex:t}})).filter((function(e){return e.score>a})).sort((function(e,t){return t.score-e.score}));var suppressFunc=function(e){return e<=n?1:0};var c=[];s.forEach((function(t){if(!(c.length>=i)){var r=t.score;for(var n=c.length-1;n>=0;--n){var o=IOU(e,t.boxIndex,c[n]);if(0!==o){t.score*=suppressFunc(o);if(t.score<=a)break}}r===t.score&&c.push(t.boxIndex)}}));return c}function IOU(e,t,r){var n=e.arraySync();var a=Math.min(n[t][0],n[t][2]);var o=Math.min(n[t][1],n[t][3]);var i=Math.max(n[t][0],n[t][2]);var s=Math.max(n[t][1],n[t][3]);var c=Math.min(n[r][0],n[r][2]);var u=Math.min(n[r][1],n[r][3]);var l=Math.max(n[r][0],n[r][2]);var h=Math.max(n[r][1],n[r][3]);var p=(i-a)*(s-o);var v=(l-c)*(h-u);if(p<=0||v<=0)return 0;var d=Math.max(a,c);var f=Math.max(o,u);var m=Math.min(i,l);var g=Math.min(s,h);var x=Math.max(m-d,0)*Math.max(g-f,0);return x/(p+v-x)}function getCenterCoordinatesAndSizesLayer(t){var r=e.unstack(e.transpose(t,[1,0]));var n=[e.sub(r[2],r[0]),e.sub(r[3],r[1])];var a=[e.add(r[0],e.div(n[0],e.scalar(2))),e.add(r[1],e.div(n[1],e.scalar(2)))];return{sizes:n,centers:a}}function decodeBoxesLayer(t,r){var n=getCenterCoordinatesAndSizesLayer(t),a=n.sizes,o=n.centers;var i=e.unstack(e.transpose(r,[1,0]));var s=e.div(e.mul(e.exp(e.div(i[2],e.scalar(5))),a[0]),e.scalar(2));var c=e.add(e.mul(e.div(i[0],e.scalar(10)),a[0]),o[0]);var u=e.div(e.mul(e.exp(e.div(i[3],e.scalar(5))),a[1]),e.scalar(2));var l=e.add(e.mul(e.div(i[1],e.scalar(10)),a[1]),o[1]);return e.transpose(e.stack([e.sub(c,s),e.sub(l,u),e.add(c,s),e.add(l,u)]),[1,0])}function outputLayer(t,r,n){return e.tidy((function(){var a=t.shape[0];var o=decodeBoxesLayer(e.reshape(e.tile(n.extra_dim,[a,1,1]),[-1,4]),e.reshape(t,[-1,4]));o=e.reshape(o,[a,o.shape[0]/a,4]);var i=e.sigmoid(e.slice(r,[0,0,1],[-1,-1,-1]));var s=e.slice(i,[0,0,0],[-1,-1,1]);s=e.reshape(s,[a,s.shape[1]]);var c=e.unstack(o);var u=e.unstack(s);return{boxes:c,scores:u}}))}function boxPredictionLayer(t,r){return e.tidy((function(){var n=t.shape[0];var a=e.reshape(convLayer$1(t,r.box_encoding_predictor),[n,-1,1,4]);var o=e.reshape(convLayer$1(t,r.class_predictor),[n,-1,3]);return{boxPredictionEncoding:a,classPrediction:o}}))}function predictionLayer(t,r,n){return e.tidy((function(){var a=pointwiseConvLayer(t,n.conv_0,[1,1]);var o=pointwiseConvLayer(a,n.conv_1,[2,2]);var i=pointwiseConvLayer(o,n.conv_2,[1,1]);var s=pointwiseConvLayer(i,n.conv_3,[2,2]);var c=pointwiseConvLayer(s,n.conv_4,[1,1]);var u=pointwiseConvLayer(c,n.conv_5,[2,2]);var l=pointwiseConvLayer(u,n.conv_6,[1,1]);var h=pointwiseConvLayer(l,n.conv_7,[2,2]);var p=boxPredictionLayer(r,n.box_predictor_0);var v=boxPredictionLayer(t,n.box_predictor_1);var d=boxPredictionLayer(o,n.box_predictor_2);var f=boxPredictionLayer(s,n.box_predictor_3);var m=boxPredictionLayer(u,n.box_predictor_4);var g=boxPredictionLayer(h,n.box_predictor_5);var x=e.concat([p.boxPredictionEncoding,v.boxPredictionEncoding,d.boxPredictionEncoding,f.boxPredictionEncoding,m.boxPredictionEncoding,g.boxPredictionEncoding],1);var y=e.concat([p.classPrediction,v.classPrediction,d.classPrediction,f.classPrediction,m.classPrediction,g.classPrediction],1);return{boxPredictions:x,classPredictions:y}}))}var Q=function(){function SsdMobilenetv1Options(e){var t=void 0===e?{}:e,r=t.minConfidence,n=t.maxResults;this._name="SsdMobilenetv1Options";this._minConfidence=r||.5;this._maxResults=n||100;if("number"!==typeof this._minConfidence||this._minConfidence<=0||this._minConfidence>=1)throw new Error(this._name+" - expected minConfidence to be a number between 0 and 1");if("number"!==typeof this._maxResults)throw new Error(this._name+" - expected maxResults to be a number")}Object.defineProperty(SsdMobilenetv1Options.prototype,"minConfidence",{get:function(){return this._minConfidence},enumerable:true,configurable:true});Object.defineProperty(SsdMobilenetv1Options.prototype,"maxResults",{get:function(){return this._maxResults},enumerable:true,configurable:true});return SsdMobilenetv1Options}();var ee=function(r){t(SsdMobilenetv1,r);function SsdMobilenetv1(){return r.call(this,"SsdMobilenetv1")||this}SsdMobilenetv1.prototype.forwardInput=function(t){var r=this.params;if(!r)throw new Error("SsdMobilenetv1 - load model before inference");return e.tidy((function(){var n=t.toBatchTensor(512,false).toFloat();var a=e.sub(e.mul(n,e.scalar(.007843137718737125)),e.scalar(1));var o=mobileNetV1(a,r.mobilenetv1);var i=predictionLayer(o.out,o.conv11,r.prediction_layer),s=i.boxPredictions,c=i.classPredictions;return outputLayer(s,c,r.output_layer)}))};SsdMobilenetv1.prototype.forward=function(e){return a(this,void 0,void 0,(function(){var t;return o(this,(function(r){switch(r.label){case 0:t=this.forwardInput;return[4,toNetInput(e)];case 1:return[2,t.apply(this,[r.sent()])]}}))}))};SsdMobilenetv1.prototype.locateFaces=function(e,t){void 0===t&&(t={});return a(this,void 0,void 0,(function(){var r,n,a,i,s,c,u,l,h,d,f,m,g,x,y,b,w,_,P,F,T;return o(this,(function(o){switch(o.label){case 0:r=new Q(t),n=r.maxResults,a=r.minConfidence;return[4,toNetInput(e)];case 1:i=o.sent();s=this.forwardInput(i),c=s.boxes,u=s.scores;l=c[0];h=u[0];for(d=1;d<c.length;d++){c[d].dispose();u[d].dispose()}g=(m=Array).from;return[4,h.data()];case 2:f=g.apply(m,[o.sent()]);x=.5;y=nonMaxSuppression(l,f,n,x,a);b=i.getReshapedInputDimensions(0);w=i.inputSize;_=w/b.width;P=w/b.height;F=l.arraySync();T=y.map((function(e){var t=[Math.max(0,F[e][0]),Math.min(1,F[e][2])].map((function(e){return e*P})),r=t[0],n=t[1];var a=[Math.max(0,F[e][1]),Math.min(1,F[e][3])].map((function(e){return e*_})),o=a[0],s=a[1];return new p(f[e],new v(o,r,s-o,n-r),{height:i.getInputHeight(0),width:i.getInputWidth(0)})}));l.dispose();h.dispose();return[2,T]}}))}))};SsdMobilenetv1.prototype.getDefaultModelName=function(){return"ssd_mobilenetv1_model"};SsdMobilenetv1.prototype.extractParamsFromWeigthMap=function(e){return extractParamsFromWeigthMap$2(e)};SsdMobilenetv1.prototype.extractParams=function(e){return extractParams$2(e)};return SsdMobilenetv1}(L);function createSsdMobilenetv1(e){var t=new ee;t.extractWeights(e);return t}function createFaceDetectionNet(e){return createSsdMobilenetv1(e)}var te=function(e){t(FaceDetectionNet,e);function FaceDetectionNet(){return null!==e&&e.apply(this,arguments)||this}return FaceDetectionNet}(ee);var re=.4;var ne=[new c(.738768,.874946),new c(2.42204,2.65704),new c(4.30971,7.04493),new c(10.246,4.59428),new c(12.6868,11.8741)];var ae=[new c(1.603231,2.094468),new c(6.041143,7.080126),new c(2.882459,3.518061),new c(4.266906,5.178857),new c(9.041765,10.66308)];var oe=[117.001,114.697,97.404];var ie="tiny_yolov2_model";var se="tiny_yolov2_separable_conv_model";var isNumber=function(e){return"number"===typeof e};function validateConfig(e){if(!e)throw new Error("invalid config: "+e);if("boolean"!==typeof e.withSeparableConvs)throw new Error("config.withSeparableConvs has to be a boolean, have: "+e.withSeparableConvs);if(!isNumber(e.iouThreshold)||e.iouThreshold<0||e.iouThreshold>1)throw new Error("config.iouThreshold has to be a number between [0, 1], have: "+e.iouThreshold);if(!Array.isArray(e.classes)||!e.classes.length||!e.classes.every((function(e){return"string"===typeof e})))throw new Error("config.classes has to be an array class names: string[], have: "+JSON.stringify(e.classes));if(!Array.isArray(e.anchors)||!e.anchors.length||!e.anchors.map((function(e){return e||{}})).every((function(e){return isNumber(e.x)&&isNumber(e.y)})))throw new Error("config.anchors has to be an array of { x: number, y: number }, have: "+JSON.stringify(e.anchors));if(e.meanRgb&&(!Array.isArray(e.meanRgb)||3!==e.meanRgb.length||!e.meanRgb.every(isNumber)))throw new Error("config.meanRgb has to be an array of shape [number, number, number], have: "+JSON.stringify(e.meanRgb))}function leaky(t){return e.tidy((function(){var r=e.mul(t,e.scalar(.10000000149011612));return e.add(e.relu(e.sub(t,r)),r)}))}function convWithBatchNorm(t,r){return e.tidy((function(){var n=e.pad(t,[[0,0],[1,1],[1,1],[0,0]]);n=e.conv2d(n,r.conv.filters,[1,1],"valid");n=e.sub(n,r.bn.sub);n=e.mul(n,r.bn.truediv);n=e.add(n,r.conv.bias);return leaky(n)}))}function depthwiseSeparableConv(t,r){return e.tidy((function(){var n=e.pad(t,[[0,0],[1,1],[1,1],[0,0]]);n=e.separableConv2d(n,r.depthwise_filter,r.pointwise_filter,[1,1],"valid");n=e.add(n,r.bias);return leaky(n)}))}function extractorsFactory$3(t,r){var n=extractConvParamsFactory(t,r);function extractBatchNormParams(n,a){var o=e.tensor1d(t(n));var i=e.tensor1d(t(n));r.push({paramPath:a+"/sub"},{paramPath:a+"/truediv"});return{sub:o,truediv:i}}function extractConvWithBatchNormParams(e,t,r){var a=n(e,t,3,r+"/conv");var o=extractBatchNormParams(t,r+"/bn");return{conv:a,bn:o}}var a=extractSeparableConvParamsFactory(t,r);return{extractConvParams:n,extractConvWithBatchNormParams:extractConvWithBatchNormParams,extractSeparableConvParams:a}}function extractParams$1(e,t,r,n){var a=extractWeightsFactory(e),o=a.extractWeights,i=a.getRemainingWeights;var s=[];var c=extractorsFactory$3(o,s),u=c.extractConvParams,l=c.extractConvWithBatchNormParams,h=c.extractSeparableConvParams;var p;if(t.withSeparableConvs){var v=n[0],d=n[1],f=n[2],m=n[3],g=n[4],x=n[5],y=n[6],b=n[7],w=n[8];var _=t.isFirstLayerConv2d?u(v,d,3,"conv0"):h(v,d,"conv0");var P=h(d,f,"conv1");var F=h(f,m,"conv2");var T=h(m,g,"conv3");var C=h(g,x,"conv4");var D=h(x,y,"conv5");var k=b?h(y,b,"conv6"):void 0;var E=w?h(b,w,"conv7"):void 0;var M=u(w||b||y,5*r,1,"conv8");p={conv0:_,conv1:P,conv2:F,conv3:T,conv4:C,conv5:D,conv6:k,conv7:E,conv8:M}}else{v=n[0],d=n[1],f=n[2],m=n[3],g=n[4],x=n[5],y=n[6],b=n[7],w=n[8];_=l(v,d,"conv0");P=l(d,f,"conv1");F=l(f,m,"conv2");T=l(m,g,"conv3");C=l(g,x,"conv4");D=l(x,y,"conv5");k=l(y,b,"conv6");E=l(b,w,"conv7");M=u(w,5*r,1,"conv8");p={conv0:_,conv1:P,conv2:F,conv3:T,conv4:C,conv5:D,conv6:k,conv7:E,conv8:M}}if(0!==i().length)throw new Error("weights remaing after extract: "+i().length);return{params:p,paramMappings:s}}function extractorsFactory$2(e,t){var r=extractWeightEntryFactory(e,t);function extractBatchNormParams(e){var t=r(e+"/sub",1);var n=r(e+"/truediv",1);return{sub:t,truediv:n}}function extractConvParams(e){var t=r(e+"/filters",4);var n=r(e+"/bias",1);return{filters:t,bias:n}}function extractConvWithBatchNormParams(e){var t=extractConvParams(e+"/conv");var r=extractBatchNormParams(e+"/bn");return{conv:t,bn:r}}var n=loadSeparableConvParamsFactory(r);return{extractConvParams:extractConvParams,extractConvWithBatchNormParams:extractConvWithBatchNormParams,extractSeparableConvParams:n}}function extractParamsFromWeigthMap$1(e,t){var r=[];var n=extractorsFactory$2(e,r),a=n.extractConvParams,o=n.extractConvWithBatchNormParams,i=n.extractSeparableConvParams;var s;if(t.withSeparableConvs){var c=t.filterSizes&&t.filterSizes.length||9;s={conv0:t.isFirstLayerConv2d?a("conv0"):i("conv0"),conv1:i("conv1"),conv2:i("conv2"),conv3:i("conv3"),conv4:i("conv4"),conv5:i("conv5"),conv6:c>7?i("conv6"):void 0,conv7:c>8?i("conv7"):void 0,conv8:a("conv8")}}else s={conv0:o("conv0"),conv1:o("conv1"),conv2:o("conv2"),conv3:o("conv3"),conv4:o("conv4"),conv5:o("conv5"),conv6:o("conv6"),conv7:o("conv7"),conv8:a("conv8")};disposeUnusedWeightTensors(e,r);return{params:s,paramMappings:r}}var ce;(function(e){e[e.XS=224]="XS";e[e.SM=320]="SM";e[e.MD=416]="MD";e[e.LG=608]="LG"})(ce||(ce={}));var ue=function(){function TinyYolov2Options(e){var t=void 0===e?{}:e,r=t.inputSize,n=t.scoreThreshold;this._name="TinyYolov2Options";this._inputSize=r||416;this._scoreThreshold=n||.5;if("number"!==typeof this._inputSize||this._inputSize%32!==0)throw new Error(this._name+" - expected inputSize to be a number divisible by 32");if("number"!==typeof this._scoreThreshold||this._scoreThreshold<=0||this._scoreThreshold>=1)throw new Error(this._name+" - expected scoreThreshold to be a number between 0 and 1")}Object.defineProperty(TinyYolov2Options.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:true,configurable:true});Object.defineProperty(TinyYolov2Options.prototype,"scoreThreshold",{get:function(){return this._scoreThreshold},enumerable:true,configurable:true});return TinyYolov2Options}();var le=function(r){t(TinyYolov2Base,r);function TinyYolov2Base(e){var t=r.call(this,"TinyYolov2")||this;validateConfig(e);t._config=e;return t}Object.defineProperty(TinyYolov2Base.prototype,"config",{get:function(){return this._config},enumerable:true,configurable:true});Object.defineProperty(TinyYolov2Base.prototype,"withClassScores",{get:function(){return this.config.withClassScores||this.config.classes.length>1},enumerable:true,configurable:true});Object.defineProperty(TinyYolov2Base.prototype,"boxEncodingSize",{get:function(){return 5+(this.withClassScores?this.config.classes.length:0)},enumerable:true,configurable:true});TinyYolov2Base.prototype.runTinyYolov2=function(t,r){var n=convWithBatchNorm(t,r.conv0);n=e.maxPool(n,[2,2],[2,2],"same");n=convWithBatchNorm(n,r.conv1);n=e.maxPool(n,[2,2],[2,2],"same");n=convWithBatchNorm(n,r.conv2);n=e.maxPool(n,[2,2],[2,2],"same");n=convWithBatchNorm(n,r.conv3);n=e.maxPool(n,[2,2],[2,2],"same");n=convWithBatchNorm(n,r.conv4);n=e.maxPool(n,[2,2],[2,2],"same");n=convWithBatchNorm(n,r.conv5);n=e.maxPool(n,[2,2],[1,1],"same");n=convWithBatchNorm(n,r.conv6);n=convWithBatchNorm(n,r.conv7);return convLayer$1(n,r.conv8,"valid",false)};TinyYolov2Base.prototype.runMobilenet=function(t,r){var n=this.config.isFirstLayerConv2d?leaky(convLayer$1(t,r.conv0,"valid",false)):depthwiseSeparableConv(t,r.conv0);n=e.maxPool(n,[2,2],[2,2],"same");n=depthwiseSeparableConv(n,r.conv1);n=e.maxPool(n,[2,2],[2,2],"same");n=depthwiseSeparableConv(n,r.conv2);n=e.maxPool(n,[2,2],[2,2],"same");n=depthwiseSeparableConv(n,r.conv3);n=e.maxPool(n,[2,2],[2,2],"same");n=depthwiseSeparableConv(n,r.conv4);n=e.maxPool(n,[2,2],[2,2],"same");n=depthwiseSeparableConv(n,r.conv5);n=e.maxPool(n,[2,2],[1,1],"same");n=r.conv6?depthwiseSeparableConv(n,r.conv6):n;n=r.conv7?depthwiseSeparableConv(n,r.conv7):n;return convLayer$1(n,r.conv8,"valid",false)};TinyYolov2Base.prototype.forwardInput=function(t,r){var n=this;var a=this.params;if(!a)throw new Error("TinyYolov2 - load model before inference");return e.tidy((function(){var o=t.toBatchTensor(r,false).toFloat();o=n.config.meanRgb?normalize$1(o,n.config.meanRgb):o;o=o.div(e.scalar(256));return n.config.withSeparableConvs?n.runMobilenet(o,a):n.runTinyYolov2(o,a)}))};TinyYolov2Base.prototype.forward=function(e,t){return a(this,void 0,void 0,(function(){var r;return o(this,(function(n){switch(n.label){case 0:r=this.forwardInput;return[4,toNetInput(e)];case 1:return[4,r.apply(this,[n.sent(),t])];case 2:return[2,n.sent()]}}))}))};TinyYolov2Base.prototype.detect=function(t,r){void 0===r&&(r={});return a(this,void 0,void 0,(function(){var n,a,i,s,c,u,l,p,v,d,f,m,g,x;var y=this;return o(this,(function(o){switch(o.label){case 0:n=new ue(r),a=n.inputSize,i=n.scoreThreshold;return[4,toNetInput(t)];case 1:s=o.sent();return[4,this.forwardInput(s,a)];case 2:c=o.sent();u=e.tidy((function(){return e.unstack(c)[0].expandDims()}));l={width:s.getInputWidth(0),height:s.getInputHeight(0)};return[4,this.extractBoxes(u,s.getReshapedInputDimensions(0),i)];case 3:p=o.sent();c.dispose();u.dispose();v=p.map((function(e){return e.box}));d=p.map((function(e){return e.score}));f=p.map((function(e){return e.classScore}));m=p.map((function(e){return y.config.classes[e.label]}));g=nonMaxSuppression$1(v.map((function(e){return e.rescale(a)})),d,this.config.iouThreshold,true);x=g.map((function(e){return new h(d[e],f[e],m[e],v[e],l)}));return[2,x]}}))}))};TinyYolov2Base.prototype.getDefaultModelName=function(){return""};TinyYolov2Base.prototype.extractParamsFromWeigthMap=function(e){return extractParamsFromWeigthMap$1(e,this.config)};TinyYolov2Base.prototype.extractParams=function(e){var t=this.config.filterSizes||TinyYolov2Base.DEFAULT_FILTER_SIZES;var r=t?t.length:void 0;if(7!==r&&8!==r&&9!==r)throw new Error("TinyYolov2 - expected 7 | 8 | 9 convolutional filters, but found "+r+" filterSizes in config");return extractParams$1(e,this.config,this.boxEncodingSize,t)};TinyYolov2Base.prototype.extractBoxes=function(t,r,i){return a(this,void 0,void 0,(function(){var a,s,c,u,h,p,v,d,f,m,g,x,y,b,w,_,P,F,T,C,D,k,E,M,S,L,N,B,A;var W=this;return o(this,(function(o){switch(o.label){case 0:a=r.width,s=r.height;c=Math.max(a,s);u=c/a;h=c/s;p=t.shape[1];v=this.config.anchors.length;d=e.tidy((function(){var r=t.reshape([p,p,v,W.boxEncodingSize]);var n=r.slice([0,0,0,0],[p,p,v,4]);var a=r.slice([0,0,0,4],[p,p,v,1]);var o=W.withClassScores?e.softmax(r.slice([0,0,0,5],[p,p,v,W.config.classes.length]),3):e.scalar(0);return[n,a,o]})),f=d[0],m=d[1],g=d[2];x=[];return[4,m.array()];case 1:y=o.sent();return[4,f.array()];case 2:b=o.sent();w=0;o.label=3;case 3:if(!(w<p))return[3,12];_=0;o.label=4;case 4:if(!(_<p))return[3,11];P=0;o.label=5;case 5:if(!(P<v))return[3,10];F=sigmoid(y[w][_][P][0]);if(!(!i||F>i))return[3,9];T=(_+sigmoid(b[w][_][P][0]))/p*u;C=(w+sigmoid(b[w][_][P][1]))/p*h;D=Math.exp(b[w][_][P][2])*this.config.anchors[P].x/p*u;k=Math.exp(b[w][_][P][3])*this.config.anchors[P].y/p*h;E=T-D/2;M=C-k/2;S={row:w,col:_,anchor:P};return this.withClassScores?[4,this.extractPredictedClass(g,S)]:[3,7];case 6:A=o.sent();return[3,8];case 7:A={classScore:1,label:0};o.label=8;case 8:L=A,N=L.classScore,B=L.label;x.push(n({box:new l(E,M,E+D,M+k),score:F,classScore:F*N,label:B},S));o.label=9;case 9:P++;return[3,5];case 10:_++;return[3,4];case 11:w++;return[3,3];case 12:f.dispose();m.dispose();g.dispose();return[2,x]}}))}))};TinyYolov2Base.prototype.extractPredictedClass=function(e,t){return a(this,void 0,void 0,(function(){var r,n,a,i;return o(this,(function(o){switch(o.label){case 0:r=t.row,n=t.col,a=t.anchor;return[4,e.array()];case 1:i=o.sent();return[2,Array(this.config.classes.length).fill(0).map((function(e,t){return i[r][n][a][t]})).map((function(e,t){return{classScore:e,label:t}})).reduce((function(e,t){return e.classScore>t.classScore?e:t}))]}}))}))};TinyYolov2Base.DEFAULT_FILTER_SIZES=[3,16,32,64,128,256,512,1024,1024];return TinyYolov2Base}(L);var he=function(e){t(TinyYolov2,e);function TinyYolov2(t){void 0===t&&(t=true);var r=this;var n=Object.assign({},{withSeparableConvs:t,iouThreshold:re,classes:["face"]},t?{anchors:ae,meanRgb:oe}:{anchors:ne,withClassScores:true});r=e.call(this,n)||this;return r}Object.defineProperty(TinyYolov2.prototype,"withSeparableConvs",{get:function(){return this.config.withSeparableConvs},enumerable:true,configurable:true});Object.defineProperty(TinyYolov2.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:true,configurable:true});TinyYolov2.prototype.locateFaces=function(e,t){return a(this,void 0,void 0,(function(){var r;return o(this,(function(n){switch(n.label){case 0:return[4,this.detect(e,t)];case 1:r=n.sent();return[2,r.map((function(e){return new p(e.score,e.relativeBox,{width:e.imageWidth,height:e.imageHeight})}))]}}))}))};TinyYolov2.prototype.getDefaultModelName=function(){return this.withSeparableConvs?se:ie};TinyYolov2.prototype.extractParamsFromWeigthMap=function(t){return e.prototype.extractParamsFromWeigthMap.call(this,t)};return TinyYolov2}(le);function createTinyYolov2(e,t){void 0===t&&(t=true);var r=new he(t);r.extractWeights(e);return r}var pe=function(e){t(TinyFaceDetectorOptions,e);function TinyFaceDetectorOptions(){var t=null!==e&&e.apply(this,arguments)||this;t._name="TinyFaceDetectorOptions";return t}return TinyFaceDetectorOptions}(ue);var ve=function(){function ComposableTask(){}ComposableTask.prototype.then=function(e){return a(this,void 0,void 0,(function(){var t;return o(this,(function(r){switch(r.label){case 0:t=e;return[4,this.run()];case 1:return[2,t.apply(void 0,[r.sent()])]}}))}))};ComposableTask.prototype.run=function(){return a(this,void 0,void 0,(function(){return o(this,(function(e){throw new Error("ComposableTask - run is not implemented")}))}))};return ComposableTask}();function extractAllFacesAndComputeResults(t,r,n,i,s){void 0===s&&(s=function(e){var t=e.alignedRect;return t});return a(this,void 0,void 0,(function(){var a,c,u,l,h;return o(this,(function(o){switch(o.label){case 0:a=t.map((function(e){return isWithFaceLandmarks(e)?s(e):e.detection}));u=i;return u?[3,5]:r instanceof e.Tensor?[4,extractFaceTensors(r,a)]:[3,2];case 1:l=o.sent();return[3,4];case 2:return[4,extractFaces(r,a)];case 3:l=o.sent();o.label=4;case 4:u=l;o.label=5;case 5:c=u;return[4,n(c)];case 6:h=o.sent();c.forEach((function(t){return t instanceof e.Tensor&&t.dispose()}));return[2,h]}}))}))}function extractSingleFaceAndComputeResult(e,t,r,n,i){return a(this,void 0,void 0,(function(){var s=this;return o(this,(function(c){return[2,extractAllFacesAndComputeResults([e],t,(function(e){return a(s,void 0,void 0,(function(){return o(this,(function(t){return[2,r(e[0])]}))}))}),n,i)]}))}))}function bgrToRgbTensor(t){return e.tidy((function(){return e.stack(e.unstack(t,3).reverse(),3)}))}var de=2;var fe=12;function extractorsFactory$1(t,r){var a=extractConvParamsFactory(t,r);var o=extractFCParamsFactory(t,r);function extractPReluParams(n,a){var o=e.tensor1d(t(n));r.push({paramPath:a});return o}function extractSharedParams(e,t,r){void 0===r&&(r=false);var n=a(e[0],e[1],3,t+"/conv1");var o=extractPReluParams(e[1],t+"/prelu1_alpha");var i=a(e[1],e[2],3,t+"/conv2");var s=extractPReluParams(e[2],t+"/prelu2_alpha");var c=a(e[2],e[3],r?2:3,t+"/conv3");var u=extractPReluParams(e[3],t+"/prelu3_alpha");return{conv1:n,prelu1_alpha:o,conv2:i,prelu2_alpha:s,conv3:c,prelu3_alpha:u}}function extractPNetParams(){var e=extractSharedParams([3,10,16,32],"pnet");var t=a(32,2,1,"pnet/conv4_1");var r=a(32,4,1,"pnet/conv4_2");return n(n({},e),{conv4_1:t,conv4_2:r})}function extractRNetParams(){var e=extractSharedParams([3,28,48,64],"rnet",true);var t=o(576,128,"rnet/fc1");var r=extractPReluParams(128,"rnet/prelu4_alpha");var a=o(128,2,"rnet/fc2_1");var i=o(128,4,"rnet/fc2_2");return n(n({},e),{fc1:t,prelu4_alpha:r,fc2_1:a,fc2_2:i})}function extractONetParams(){var e=extractSharedParams([3,32,64,64],"onet");var t=a(64,128,2,"onet/conv4");var r=extractPReluParams(128,"onet/prelu4_alpha");var i=o(1152,256,"onet/fc1");var s=extractPReluParams(256,"onet/prelu5_alpha");var c=o(256,2,"onet/fc2_1");var u=o(256,4,"onet/fc2_2");var l=o(256,10,"onet/fc2_3");return n(n({},e),{conv4:t,prelu4_alpha:r,fc1:i,prelu5_alpha:s,fc2_1:c,fc2_2:u,fc2_3:l})}return{extractPNetParams:extractPNetParams,extractRNetParams:extractRNetParams,extractONetParams:extractONetParams}}function extractParams(e){var t=extractWeightsFactory(e),r=t.extractWeights,n=t.getRemainingWeights;var a=[];var o=extractorsFactory$1(r,a),i=o.extractPNetParams,s=o.extractRNetParams,c=o.extractONetParams;var u=i();var l=s();var h=c();if(0!==n().length)throw new Error("weights remaing after extract: "+n().length);return{params:{pnet:u,rnet:l,onet:h},paramMappings:a}}function extractorsFactory(e,t){var r=extractWeightEntryFactory(e,t);function extractConvParams(e){var t=r(e+"/weights",4,e+"/filters");var n=r(e+"/bias",1);return{filters:t,bias:n}}function extractFCParams(e){var t=r(e+"/weights",2);var n=r(e+"/bias",1);return{weights:t,bias:n}}function extractPReluParams(e){return r(e,1)}function extractSharedParams(e){var t=extractConvParams(e+"/conv1");var r=extractPReluParams(e+"/prelu1_alpha");var n=extractConvParams(e+"/conv2");var a=extractPReluParams(e+"/prelu2_alpha");var o=extractConvParams(e+"/conv3");var i=extractPReluParams(e+"/prelu3_alpha");return{conv1:t,prelu1_alpha:r,conv2:n,prelu2_alpha:a,conv3:o,prelu3_alpha:i}}function extractPNetParams(){var e=extractSharedParams("pnet");var t=extractConvParams("pnet/conv4_1");var r=extractConvParams("pnet/conv4_2");return n(n({},e),{conv4_1:t,conv4_2:r})}function extractRNetParams(){var e=extractSharedParams("rnet");var t=extractFCParams("rnet/fc1");var r=extractPReluParams("rnet/prelu4_alpha");var a=extractFCParams("rnet/fc2_1");var o=extractFCParams("rnet/fc2_2");return n(n({},e),{fc1:t,prelu4_alpha:r,fc2_1:a,fc2_2:o})}function extractONetParams(){var e=extractSharedParams("onet");var t=extractConvParams("onet/conv4");var r=extractPReluParams("onet/prelu4_alpha");var a=extractFCParams("onet/fc1");var o=extractPReluParams("onet/prelu5_alpha");var i=extractFCParams("onet/fc2_1");var s=extractFCParams("onet/fc2_2");var c=extractFCParams("onet/fc2_3");return n(n({},e),{conv4:t,prelu4_alpha:r,fc1:a,prelu5_alpha:o,fc2_1:i,fc2_2:s,fc2_3:c})}return{extractPNetParams:extractPNetParams,extractRNetParams:extractRNetParams,extractONetParams:extractONetParams}}function extractParamsFromWeigthMap(e){var t=[];var r=extractorsFactory(e,t),n=r.extractPNetParams,a=r.extractRNetParams,o=r.extractONetParams;var i=n();var s=a();var c=o();disposeUnusedWeightTensors(e,t);return{params:{pnet:i,rnet:s,onet:c},paramMappings:t}}function getSizesForScale(e,t){var r=t[0],n=t[1];return{height:Math.floor(r*e),width:Math.floor(n*e)}}function pyramidDown(e,t,r){var n=r[0],a=r[1];var o=fe/e;var i=[];var s=Math.min(n,a)*o;var c=0;while(s>=12){i.push(o*Math.pow(t,c));s*=t;c+=1}return i}var me=function(e){t(MtcnnBox,e);function MtcnnBox(t,r,n,a){return e.call(this,{left:t,top:r,right:n,bottom:a},true)||this}return MtcnnBox}(u);function normalize(t){return e.tidy((function(){return e.mul(e.sub(t,e.scalar(127.5)),e.scalar(.0078125))}))}function prelu(t,r){return e.tidy((function(){return e.add(e.relu(t),e.mul(r,e.neg(e.relu(e.neg(t)))))}))}function sharedLayer(t,r,n){void 0===n&&(n=false);return e.tidy((function(){var a=convLayer$1(t,r.conv1,"valid");a=prelu(a,r.prelu1_alpha);a=e.maxPool(a,n?[2,2]:[3,3],[2,2],"same");a=convLayer$1(a,r.conv2,"valid");a=prelu(a,r.prelu2_alpha);a=n?a:e.maxPool(a,[3,3],[2,2],"valid");a=convLayer$1(a,r.conv3,"valid");a=prelu(a,r.prelu3_alpha);return a}))}function PNet(t,r){return e.tidy((function(){var n=sharedLayer(t,r,true);var a=convLayer$1(n,r.conv4_1,"valid");var o=e.expandDims(e.max(a,3),3);var i=e.softmax(e.sub(a,o),3);var s=convLayer$1(n,r.conv4_2,"valid");return{prob:i,regions:s}}))}function rescaleAndNormalize(t,r){return e.tidy((function(){var n=getSizesForScale(r,t.shape.slice(1)),a=n.height,o=n.width;var i=e.image.resizeBilinear(t,[a,o]);var s=normalize(i);return e.transpose(s,[0,2,1,3])}))}function extractBoundingBoxes(e,t,r,n){var a=[];var o=e.arraySync();for(var i=0;i<e.shape[0];i++)for(var s=0;s<e.shape[1];s++)o[i][s]>=n&&a.push(new c(s,i));var u=a.map((function(e){var n=new l(Math.round((e.y*de+1)/r),Math.round((e.x*de+1)/r),Math.round((e.y*de+fe)/r),Math.round((e.x*de+fe)/r));var a=o[e.y][e.x];var i=t.arraySync();var s=new me(i[e.y][e.x][0],i[e.y][e.x][1],i[e.y][e.x][2],i[e.y][e.x][3]);return{cell:n,score:a,region:s}}));return u}function stage1(t,r,n,a,o){o.stage1=[];var i=r.map((function(r){return e.tidy((function(){var n={scale:r};var o=rescaleAndNormalize(t,r);var i=Date.now();var s=PNet(o,a),c=s.prob,u=s.regions;n.pnet=Date.now()-i;var l=e.unstack(e.unstack(c,3)[1])[0];var h=e.unstack(u)[0];return{scoresTensor:l,regionsTensor:h,scale:r,statsForScale:n}}))}));var s=i.map((function(e){var t=e.scoresTensor,r=e.regionsTensor,a=e.scale,i=e.statsForScale;var s=extractBoundingBoxes(t,r,a,n);t.dispose();r.dispose();if(!s.length){o.stage1.push(i);return[]}var c=Date.now();var u=nonMaxSuppression$1(s.map((function(e){return e.cell})),s.map((function(e){return e.score})),.5);i.nms=Date.now()-c;i.numBoxes=u.length;o.stage1.push(i);return u.map((function(e){return s[e]}))}));var c=s.reduce((function(e,t){return e.concat(t)}),[]);var u=[];var h=[];if(c.length>0){var p=Date.now();var v=nonMaxSuppression$1(c.map((function(e){return e.cell})),c.map((function(e){return e.score})),.7);o.stage1_nms=Date.now()-p;h=v.map((function(e){return c[e].score}));u=v.map((function(e){return c[e]})).map((function(e){var t=e.cell,r=e.region;return new l(t.left+r.left*t.width,t.top+r.top*t.height,t.right+r.right*t.width,t.bottom+r.bottom*t.height).toSquare().round()}))}return{boxes:u,scores:h}}function extractImagePatches(t,r,n){var i=n.width,s=n.height;return a(this,void 0,void 0,(function(){var n,c,u;var l=this;return o(this,(function(h){switch(h.label){case 0:n=getContext2dOrThrow(t);return[4,Promise.all(r.map((function(e){return a(l,void 0,void 0,(function(){var r,a,i,s,c,u,l,h;return o(this,(function(o){r=e.padAtBorders(t.height,t.width),a=r.y,i=r.ey,s=r.x,c=r.ex;u=s-1;l=a-1;h=n.getImageData(u,l,c-u,i-l);return[2,T.isNodejs()?createCanvasFromMedia(h):createImageBitmap(h)]}))}))})))];case 1:c=h.sent();u=[];c.forEach((function(e){var t=createCanvas({width:i,height:s});var r=getContext2dOrThrow(t);r.drawImage(e,0,0,i,s);var n=r.getImageData(0,0,i,s).data;var a=[];for(var o=0;o<n.length;o+=4){a.push(n[o+2]);a.push(n[o+1]);a.push(n[o])}u.push(a)}));return[2,u.map((function(t){var r=e.tidy((function(){var r=e.transpose(e.tensor4d(t,[1,i,s,3]),[0,2,1,3]).toFloat();return normalize(r)}));return r}))]}}))}))}function RNet(t,r){return e.tidy((function(){var n=sharedLayer(t,r);var a=e.reshape(n,[n.shape[0],r.fc1.weights.shape[0]]);var o=fullyConnectedLayer(a,r.fc1);var i=prelu(o,r.prelu4_alpha);var s=fullyConnectedLayer(i,r.fc2_1);var c=e.expandDims(e.max(s,1),1);var u=e.softmax(e.sub(s,c),1);var l=fullyConnectedLayer(i,r.fc2_2);var h=e.unstack(u,1)[1];return{scores:h,regions:l}}))}function stage2(t,r,n,i,s){return a(this,void 0,void 0,(function(){var a,c,u,l,h,p,v,d,f,m,g,x,y,b;return o(this,(function(o){switch(o.label){case 0:a=Date.now();return[4,extractImagePatches(t,r,{width:24,height:24})];case 1:c=o.sent();s.stage2_extractImagePatches=Date.now()-a;a=Date.now();u=c.map((function(e){var t=RNet(e,i);e.dispose();return t}));s.stage2_rnet=Date.now()-a;l=u.length>1?e.concat(u.map((function(e){return e.scores}))):u[0].scores;v=(p=Array).from;return[4,l.data()];case 2:h=v.apply(p,[o.sent()]);l.dispose();d=h.map((function(e,t){return{score:e,idx:t}})).filter((function(e){return e.score>n})).map((function(e){var t=e.idx;return t}));f=d.map((function(e){return r[e]}));m=d.map((function(e){return h[e]}));g=[];x=[];if(f.length>0){a=Date.now();y=nonMaxSuppression$1(f,m,.7);s.stage2_nms=Date.now()-a;b=y.map((function(e){var t=u[d[e]].regions.arraySync();return new me(t[0][0],t[0][1],t[0][2],t[0][3])}));x=y.map((function(e){return m[e]}));g=y.map((function(e,t){return f[e].calibrate(b[t])}))}u.forEach((function(e){e.regions.dispose();e.scores.dispose()}));return[2,{boxes:g,scores:x}]}}))}))}function ONet(t,r){return e.tidy((function(){var n=sharedLayer(t,r);n=e.maxPool(n,[2,2],[2,2],"same");n=convLayer$1(n,r.conv4,"valid");n=prelu(n,r.prelu4_alpha);var a=e.reshape(n,[n.shape[0],r.fc1.weights.shape[0]]);var o=fullyConnectedLayer(a,r.fc1);var i=prelu(o,r.prelu5_alpha);var s=fullyConnectedLayer(i,r.fc2_1);var c=e.expandDims(e.max(s,1),1);var u=e.softmax(e.sub(s,c),1);var l=fullyConnectedLayer(i,r.fc2_2);var h=fullyConnectedLayer(i,r.fc2_3);var p=e.unstack(u,1)[1];return{scores:p,regions:l,points:h}}))}function stage3(t,r,n,i,s){return a(this,void 0,void 0,(function(){var a,u,l,h,p,v,d,f,m,g,x,y,b,w,_;return o(this,(function(o){switch(o.label){case 0:a=Date.now();return[4,extractImagePatches(t,r,{width:48,height:48})];case 1:u=o.sent();s.stage3_extractImagePatches=Date.now()-a;a=Date.now();l=u.map((function(e){var t=ONet(e,i);e.dispose();return t}));s.stage3_onet=Date.now()-a;h=l.length>1?e.concat(l.map((function(e){return e.scores}))):l[0].scores;d=(v=Array).from;return[4,h.data()];case 2:p=d.apply(v,[o.sent()]);h.dispose();f=p.map((function(e,t){return{score:e,idx:t}})).filter((function(e){return e.score>n})).map((function(e){var t=e.idx;return t}));m=f.map((function(e){var t=l[e].regions.arraySync();return new me(t[0][0],t[0][1],t[0][2],t[0][3])}));g=f.map((function(e,t){return r[e].calibrate(m[t])}));x=f.map((function(e){return p[e]}));y=[];b=[];w=[];if(g.length>0){a=Date.now();_=nonMaxSuppression$1(g,x,.7,false);s.stage3_nms=Date.now()-a;y=_.map((function(e){return g[e]}));b=_.map((function(e){return x[e]}));w=_.map((function(e,t){return Array(5).fill(0).map((function(r,n){var a=l[e].points.arraySync();return new c(a[0][n]*(y[t].width+1)+y[t].left,a[0][n+5]*(y[t].height+1)+y[t].top)}))}))}l.forEach((function(e){e.regions.dispose();e.scores.dispose();e.points.dispose()}));return[2,{boxes:y,scores:b,points:w}]}}))}))}var ge=function(r){t(Mtcnn,r);function Mtcnn(){return r.call(this,"Mtcnn")||this}Mtcnn.prototype.load=function(e){return a(this,void 0,void 0,(function(){return o(this,(function(t){console.warn("mtcnn is deprecated and will be removed soon");return[2,r.prototype.load.call(this,e)]}))}))};Mtcnn.prototype.loadFromDisk=function(e){return a(this,void 0,void 0,(function(){return o(this,(function(t){console.warn("mtcnn is deprecated and will be removed soon");return[2,r.prototype.loadFromDisk.call(this,e)]}))}))};Mtcnn.prototype.forwardInput=function(t,r){void 0===r&&(r={});return a(this,void 0,void 0,(function(){var n,a,i,s,u,l,h,d,f,m,g,y,b,w,_,P,F,T,C,D,k;return o(this,(function(o){switch(o.label){case 0:n=this.params;if(!n)throw new Error("Mtcnn - load model before inference");a=t.canvases[0];if(!a)throw new Error("Mtcnn - inputCanvas is not defined, note that passing tensors into Mtcnn.forwardInput is not supported yet.");i={};s=Date.now();u=e.tidy((function(){return bgrToRgbTensor(e.expandDims(e.browser.fromPixels(a)).toFloat())}));l=function(e){u.dispose();i.total=Date.now()-s;return e};h=u.shape.slice(1),d=h[0],f=h[1];m=new Z(r),g=m.minFaceSize,y=m.scaleFactor,b=m.maxNumScales,w=m.scoreThresholds,_=m.scaleSteps;P=(_||pyramidDown(g,y,[d,f])).filter((function(e){var t=getSizesForScale(e,[d,f]);return Math.min(t.width,t.height)>fe})).slice(0,b);i.scales=P;i.pyramid=P.map((function(e){return getSizesForScale(e,[d,f])}));F=Date.now();return[4,stage1(u,P,w[0],n.pnet,i)];case 1:T=o.sent();i.total_stage1=Date.now()-F;if(!T.boxes.length)return[2,l({results:[],stats:i})];i.stage2_numInputBoxes=T.boxes.length;F=Date.now();return[4,stage2(a,T.boxes,w[1],n.rnet,i)];case 2:C=o.sent();i.total_stage2=Date.now()-F;if(!C.boxes.length)return[2,l({results:[],stats:i})];i.stage3_numInputBoxes=C.boxes.length;F=Date.now();return[4,stage3(a,C.boxes,w[2],n.onet,i)];case 3:D=o.sent();i.total_stage3=Date.now()-F;k=D.boxes.map((function(e,t){return extendWithFaceLandmarks(extendWithFaceDetection({},new p(D.scores[t],new v(e.left/f,e.top/d,e.width/f,e.height/d),{height:d,width:f})),new x(D.points[t].map((function(t){return t.sub(new c(e.left,e.top)).div(new c(e.width,e.height))})),{width:e.width,height:e.height}))}));return[2,l({results:k,stats:i})]}}))}))};Mtcnn.prototype.forward=function(e,t){void 0===t&&(t={});return a(this,void 0,void 0,(function(){var r;return o(this,(function(n){switch(n.label){case 0:r=this.forwardInput;return[4,toNetInput(e)];case 1:return[4,r.apply(this,[n.sent(),t])];case 2:return[2,n.sent().results]}}))}))};Mtcnn.prototype.forwardWithStats=function(e,t){void 0===t&&(t={});return a(this,void 0,void 0,(function(){var r;return o(this,(function(n){switch(n.label){case 0:r=this.forwardInput;return[4,toNetInput(e)];case 1:return[2,r.apply(this,[n.sent(),t])]}}))}))};Mtcnn.prototype.getDefaultModelName=function(){return"mtcnn_model"};Mtcnn.prototype.extractParamsFromWeigthMap=function(e){return extractParamsFromWeigthMap(e)};Mtcnn.prototype.extractParams=function(e){return extractParams(e)};return Mtcnn}(L);var xe=.4;var ye=[new c(1.603231,2.094468),new c(6.041143,7.080126),new c(2.882459,3.518061),new c(4.266906,5.178857),new c(9.041765,10.66308)];var be=[117.001,114.697,97.404];var we=function(e){t(TinyFaceDetector,e);function TinyFaceDetector(){var t=this;var r={withSeparableConvs:true,iouThreshold:xe,classes:["face"],anchors:ye,meanRgb:be,isFirstLayerConv2d:true,filterSizes:[3,16,32,64,128,256,512]};t=e.call(this,r)||this;return t}Object.defineProperty(TinyFaceDetector.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:true,configurable:true});TinyFaceDetector.prototype.locateFaces=function(e,t){return a(this,void 0,void 0,(function(){var r;return o(this,(function(n){switch(n.label){case 0:return[4,this.detect(e,t)];case 1:r=n.sent();return[2,r.map((function(e){return new p(e.score,e.relativeBox,{width:e.imageWidth,height:e.imageHeight})}))]}}))}))};TinyFaceDetector.prototype.getDefaultModelName=function(){return"tiny_face_detector_model"};TinyFaceDetector.prototype.extractParamsFromWeigthMap=function(t){return e.prototype.extractParamsFromWeigthMap.call(this,t)};return TinyFaceDetector}(le);var _e={ssdMobilenetv1:new ee,tinyFaceDetector:new we,tinyYolov2:new he,mtcnn:new ge,faceLandmark68Net:new H,faceLandmark68TinyNet:new J,faceRecognitionNet:new X,faceExpressionNet:new I,ageGenderNet:new V};
/**
 * Attempts to detect all faces in an image using SSD Mobilenetv1 Network.
 *
 * @param input The input image.
 * @param options (optional, default: see SsdMobilenetv1Options constructor for default parameters).
 * @returns Bounding box of each face with score.
 */var ssdMobilenetv1=function(e,t){return _e.ssdMobilenetv1.locateFaces(e,t)};
/**
 * Attempts to detect all faces in an image using the Tiny Face Detector.
 *
 * @param input The input image.
 * @param options (optional, default: see TinyFaceDetectorOptions constructor for default parameters).
 * @returns Bounding box of each face with score.
 */var tinyFaceDetector=function(e,t){return _e.tinyFaceDetector.locateFaces(e,t)};
/**
 * Attempts to detect all faces in an image using the Tiny Yolov2 Network.
 *
 * @param input The input image.
 * @param options (optional, default: see TinyYolov2Options constructor for default parameters).
 * @returns Bounding box of each face with score.
 */var tinyYolov2=function(e,t){return _e.tinyYolov2.locateFaces(e,t)};
/**
 * Attempts to detect all faces in an image and the 5 point face landmarks
 * of each detected face using the MTCNN Network.
 *
 * @param input The input image.
 * @param options (optional, default: see MtcnnOptions constructor for default parameters).
 * @returns Bounding box of each face with score and 5 point face landmarks.
 */var mtcnn=function(e,t){return _e.mtcnn.forward(e,t)};
/**
 * Detects the 68 point face landmark positions of the face shown in an image.
 *
 * @param inputs The face image extracted from the bounding box of a face. Can
 * also be an array of input images, which will be batch processed.
 * @returns 68 point face landmarks or array thereof in case of batch input.
 */var detectFaceLandmarks=function(e){return _e.faceLandmark68Net.detectLandmarks(e)};
/**
 * Detects the 68 point face landmark positions of the face shown in an image
 * using a tinier version of the 68 point face landmark model, which is slightly
 * faster at inference, but also slightly less accurate.
 *
 * @param inputs The face image extracted from the bounding box of a face. Can
 * also be an array of input images, which will be batch processed.
 * @returns 68 point face landmarks or array thereof in case of batch input.
 */var detectFaceLandmarksTiny=function(e){return _e.faceLandmark68TinyNet.detectLandmarks(e)};
/**
 * Computes a 128 entry vector (face descriptor / face embeddings) from the face shown in an image,
 * which uniquely represents the features of that persons face. The computed face descriptor can
 * be used to measure the similarity between faces, by computing the euclidean distance of two
 * face descriptors.
 *
 * @param inputs The face image extracted from the aligned bounding box of a face. Can
 * also be an array of input images, which will be batch processed.
 * @returns Face descriptor with 128 entries or array thereof in case of batch input.
 */var computeFaceDescriptor=function(e){return _e.faceRecognitionNet.computeFaceDescriptor(e)};
/**
 * Recognizes the facial expressions from a face image.
 *
 * @param inputs The face image extracted from the bounding box of a face. Can
 * also be an array of input images, which will be batch processed.
 * @returns Facial expressions with corresponding probabilities or array thereof in case of batch input.
 */var recognizeFaceExpressions=function(e){return _e.faceExpressionNet.predictExpressions(e)};
/**
 * Predicts age and gender from a face image.
 *
 * @param inputs The face image extracted from the bounding box of a face. Can
 * also be an array of input images, which will be batch processed.
 * @returns Predictions with age, gender and gender probability or array thereof in case of batch input.
 */var predictAgeAndGender=function(e){return _e.ageGenderNet.predictAgeAndGender(e)};var loadSsdMobilenetv1Model=function(e){return _e.ssdMobilenetv1.load(e)};var loadTinyFaceDetectorModel=function(e){return _e.tinyFaceDetector.load(e)};var loadMtcnnModel=function(e){return _e.mtcnn.load(e)};var loadTinyYolov2Model=function(e){return _e.tinyYolov2.load(e)};var loadFaceLandmarkModel=function(e){return _e.faceLandmark68Net.load(e)};var loadFaceLandmarkTinyModel=function(e){return _e.faceLandmark68TinyNet.load(e)};var loadFaceRecognitionModel=function(e){return _e.faceRecognitionNet.load(e)};var loadFaceExpressionModel=function(e){return _e.faceExpressionNet.load(e)};var loadAgeGenderModel=function(e){return _e.ageGenderNet.load(e)};var Pe=loadSsdMobilenetv1Model;var Fe=ssdMobilenetv1;var Te=detectFaceLandmarks;var Ce=function(e){t(PredictFaceExpressionsTaskBase,e);function PredictFaceExpressionsTaskBase(t,r,n){var a=e.call(this)||this;a.parentTask=t;a.input=r;a.extractedFaces=n;return a}return PredictFaceExpressionsTaskBase}(ve);var De=function(e){t(PredictAllFaceExpressionsTask,e);function PredictAllFaceExpressionsTask(){return null!==e&&e.apply(this,arguments)||this}PredictAllFaceExpressionsTask.prototype.run=function(){return a(this,void 0,void 0,(function(){var e,t;var r=this;return o(this,(function(n){switch(n.label){case 0:return[4,this.parentTask];case 1:e=n.sent();return[4,extractAllFacesAndComputeResults(e,this.input,(function(e){return a(r,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,Promise.all(e.map((function(e){return _e.faceExpressionNet.predictExpressions(e)})))];case 1:return[2,t.sent()]}}))}))}),this.extractedFaces)];case 2:t=n.sent();return[2,e.map((function(e,r){return extendWithFaceExpressions(e,t[r])}))]}}))}))};PredictAllFaceExpressionsTask.prototype.withAgeAndGender=function(){return new Le(this,this.input)};return PredictAllFaceExpressionsTask}(Ce);var ke=function(e){t(PredictSingleFaceExpressionsTask,e);function PredictSingleFaceExpressionsTask(){return null!==e&&e.apply(this,arguments)||this}PredictSingleFaceExpressionsTask.prototype.run=function(){return a(this,void 0,void 0,(function(){var e,t;return o(this,(function(r){switch(r.label){case 0:return[4,this.parentTask];case 1:e=r.sent();return e?[4,extractSingleFaceAndComputeResult(e,this.input,(function(e){return _e.faceExpressionNet.predictExpressions(e)}),this.extractedFaces)]:[2];case 2:t=r.sent();return[2,extendWithFaceExpressions(e,t)]}}))}))};PredictSingleFaceExpressionsTask.prototype.withAgeAndGender=function(){return new Ne(this,this.input)};return PredictSingleFaceExpressionsTask}(Ce);var Ee=function(e){t(PredictAllFaceExpressionsWithFaceAlignmentTask,e);function PredictAllFaceExpressionsWithFaceAlignmentTask(){return null!==e&&e.apply(this,arguments)||this}PredictAllFaceExpressionsWithFaceAlignmentTask.prototype.withAgeAndGender=function(){return new Be(this,this.input)};PredictAllFaceExpressionsWithFaceAlignmentTask.prototype.withFaceDescriptors=function(){return new Oe(this,this.input)};return PredictAllFaceExpressionsWithFaceAlignmentTask}(De);var Me=function(e){t(PredictSingleFaceExpressionsWithFaceAlignmentTask,e);function PredictSingleFaceExpressionsWithFaceAlignmentTask(){return null!==e&&e.apply(this,arguments)||this}PredictSingleFaceExpressionsWithFaceAlignmentTask.prototype.withAgeAndGender=function(){return new Ae(this,this.input)};PredictSingleFaceExpressionsWithFaceAlignmentTask.prototype.withFaceDescriptor=function(){return new Ie(this,this.input)};return PredictSingleFaceExpressionsWithFaceAlignmentTask}(ke);var Se=function(e){t(PredictAgeAndGenderTaskBase,e);function PredictAgeAndGenderTaskBase(t,r,n){var a=e.call(this)||this;a.parentTask=t;a.input=r;a.extractedFaces=n;return a}return PredictAgeAndGenderTaskBase}(ve);var Le=function(e){t(PredictAllAgeAndGenderTask,e);function PredictAllAgeAndGenderTask(){return null!==e&&e.apply(this,arguments)||this}PredictAllAgeAndGenderTask.prototype.run=function(){return a(this,void 0,void 0,(function(){var e,t;var r=this;return o(this,(function(n){switch(n.label){case 0:return[4,this.parentTask];case 1:e=n.sent();return[4,extractAllFacesAndComputeResults(e,this.input,(function(e){return a(r,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,Promise.all(e.map((function(e){return _e.ageGenderNet.predictAgeAndGender(e)})))];case 1:return[2,t.sent()]}}))}))}),this.extractedFaces)];case 2:t=n.sent();return[2,e.map((function(e,r){var n=t[r],a=n.age,o=n.gender,i=n.genderProbability;return extendWithAge(extendWithGender(e,o,i),a)}))]}}))}))};PredictAllAgeAndGenderTask.prototype.withFaceExpressions=function(){return new De(this,this.input)};return PredictAllAgeAndGenderTask}(Se);var Ne=function(e){t(PredictSingleAgeAndGenderTask,e);function PredictSingleAgeAndGenderTask(){return null!==e&&e.apply(this,arguments)||this}PredictSingleAgeAndGenderTask.prototype.run=function(){return a(this,void 0,void 0,(function(){var e,t,r,n,a;return o(this,(function(o){switch(o.label){case 0:return[4,this.parentTask];case 1:e=o.sent();return e?[4,extractSingleFaceAndComputeResult(e,this.input,(function(e){return _e.ageGenderNet.predictAgeAndGender(e)}),this.extractedFaces)]:[2];case 2:t=o.sent(),r=t.age,n=t.gender,a=t.genderProbability;return[2,extendWithAge(extendWithGender(e,n,a),r)]}}))}))};PredictSingleAgeAndGenderTask.prototype.withFaceExpressions=function(){return new ke(this,this.input)};return PredictSingleAgeAndGenderTask}(Se);var Be=function(e){t(PredictAllAgeAndGenderWithFaceAlignmentTask,e);function PredictAllAgeAndGenderWithFaceAlignmentTask(){return null!==e&&e.apply(this,arguments)||this}PredictAllAgeAndGenderWithFaceAlignmentTask.prototype.withFaceExpressions=function(){return new Ee(this,this.input)};PredictAllAgeAndGenderWithFaceAlignmentTask.prototype.withFaceDescriptors=function(){return new Oe(this,this.input)};return PredictAllAgeAndGenderWithFaceAlignmentTask}(Le);var Ae=function(e){t(PredictSingleAgeAndGenderWithFaceAlignmentTask,e);function PredictSingleAgeAndGenderWithFaceAlignmentTask(){return null!==e&&e.apply(this,arguments)||this}PredictSingleAgeAndGenderWithFaceAlignmentTask.prototype.withFaceExpressions=function(){return new Me(this,this.input)};PredictSingleAgeAndGenderWithFaceAlignmentTask.prototype.withFaceDescriptor=function(){return new Ie(this,this.input)};return PredictSingleAgeAndGenderWithFaceAlignmentTask}(Ne);var We=function(e){t(ComputeFaceDescriptorsTaskBase,e);function ComputeFaceDescriptorsTaskBase(t,r){var n=e.call(this)||this;n.parentTask=t;n.input=r;return n}return ComputeFaceDescriptorsTaskBase}(ve);var Oe=function(e){t(ComputeAllFaceDescriptorsTask,e);function ComputeAllFaceDescriptorsTask(){return null!==e&&e.apply(this,arguments)||this}ComputeAllFaceDescriptorsTask.prototype.run=function(){return a(this,void 0,void 0,(function(){var e,t;return o(this,(function(r){switch(r.label){case 0:return[4,this.parentTask];case 1:e=r.sent();return[4,extractAllFacesAndComputeResults(e,this.input,(function(e){return Promise.all(e.map((function(e){return _e.faceRecognitionNet.computeFaceDescriptor(e)})))}),null,(function(e){return e.landmarks.align(null,{useDlibAlignment:true})}))];case 2:t=r.sent();return[2,t.map((function(t,r){return extendWithFaceDescriptor(e[r],t)}))]}}))}))};ComputeAllFaceDescriptorsTask.prototype.withFaceExpressions=function(){return new Ee(this,this.input)};ComputeAllFaceDescriptorsTask.prototype.withAgeAndGender=function(){return new Be(this,this.input)};return ComputeAllFaceDescriptorsTask}(We);var Ie=function(e){t(ComputeSingleFaceDescriptorTask,e);function ComputeSingleFaceDescriptorTask(){return null!==e&&e.apply(this,arguments)||this}ComputeSingleFaceDescriptorTask.prototype.run=function(){return a(this,void 0,void 0,(function(){var e,t;return o(this,(function(r){switch(r.label){case 0:return[4,this.parentTask];case 1:e=r.sent();return e?[4,extractSingleFaceAndComputeResult(e,this.input,(function(e){return _e.faceRecognitionNet.computeFaceDescriptor(e)}),null,(function(e){return e.landmarks.align(null,{useDlibAlignment:true})}))]:[2];case 2:t=r.sent();return[2,extendWithFaceDescriptor(e,t)]}}))}))};ComputeSingleFaceDescriptorTask.prototype.withFaceExpressions=function(){return new Me(this,this.input)};ComputeSingleFaceDescriptorTask.prototype.withAgeAndGender=function(){return new Ae(this,this.input)};return ComputeSingleFaceDescriptorTask}(We);var Re=function(e){t(DetectFaceLandmarksTaskBase,e);function DetectFaceLandmarksTaskBase(t,r,n){var a=e.call(this)||this;a.parentTask=t;a.input=r;a.useTinyLandmarkNet=n;return a}Object.defineProperty(DetectFaceLandmarksTaskBase.prototype,"landmarkNet",{get:function(){return this.useTinyLandmarkNet?_e.faceLandmark68TinyNet:_e.faceLandmark68Net},enumerable:true,configurable:true});return DetectFaceLandmarksTaskBase}(ve);var je=function(r){t(DetectAllFaceLandmarksTask,r);function DetectAllFaceLandmarksTask(){return null!==r&&r.apply(this,arguments)||this}DetectAllFaceLandmarksTask.prototype.run=function(){return a(this,void 0,void 0,(function(){var t,r,n,a,i;var s=this;return o(this,(function(o){switch(o.label){case 0:return[4,this.parentTask];case 1:t=o.sent();r=t.map((function(e){return e.detection}));return this.input instanceof e.Tensor?[4,extractFaceTensors(this.input,r)]:[3,3];case 2:a=o.sent();return[3,5];case 3:return[4,extractFaces(this.input,r)];case 4:a=o.sent();o.label=5;case 5:n=a;return[4,Promise.all(n.map((function(e){return s.landmarkNet.detectLandmarks(e)})))];case 6:i=o.sent();n.forEach((function(t){return t instanceof e.Tensor&&t.dispose()}));return[2,t.map((function(e,t){return extendWithFaceLandmarks(e,i[t])}))]}}))}))};DetectAllFaceLandmarksTask.prototype.withFaceExpressions=function(){return new Ee(this,this.input)};DetectAllFaceLandmarksTask.prototype.withAgeAndGender=function(){return new Be(this,this.input)};DetectAllFaceLandmarksTask.prototype.withFaceDescriptors=function(){return new Oe(this,this.input)};return DetectAllFaceLandmarksTask}(Re);var ze=function(r){t(DetectSingleFaceLandmarksTask,r);function DetectSingleFaceLandmarksTask(){return null!==r&&r.apply(this,arguments)||this}DetectSingleFaceLandmarksTask.prototype.run=function(){return a(this,void 0,void 0,(function(){var t,r,n,a,i;return o(this,(function(o){switch(o.label){case 0:return[4,this.parentTask];case 1:t=o.sent();if(!t)return[2];r=t.detection;return this.input instanceof e.Tensor?[4,extractFaceTensors(this.input,[r])]:[3,3];case 2:a=o.sent();return[3,5];case 3:return[4,extractFaces(this.input,[r])];case 4:a=o.sent();o.label=5;case 5:n=a;return[4,this.landmarkNet.detectLandmarks(n[0])];case 6:i=o.sent();n.forEach((function(t){return t instanceof e.Tensor&&t.dispose()}));return[2,extendWithFaceLandmarks(t,i)]}}))}))};DetectSingleFaceLandmarksTask.prototype.withFaceExpressions=function(){return new Me(this,this.input)};DetectSingleFaceLandmarksTask.prototype.withAgeAndGender=function(){return new Ae(this,this.input)};DetectSingleFaceLandmarksTask.prototype.withFaceDescriptor=function(){return new Ie(this,this.input)};return DetectSingleFaceLandmarksTask}(Re);var $e=function(e){t(DetectFacesTaskBase,e);function DetectFacesTaskBase(t,r){void 0===r&&(r=new Q);var n=e.call(this)||this;n.input=t;n.options=r;return n}return DetectFacesTaskBase}(ve);var Ge=function(e){t(DetectAllFacesTask,e);function DetectAllFacesTask(){return null!==e&&e.apply(this,arguments)||this}DetectAllFacesTask.prototype.run=function(){return a(this,void 0,void 0,(function(){var e,t,r,n;return o(this,(function(a){switch(a.label){case 0:e=this,t=e.input,r=e.options;return r instanceof Z?[4,_e.mtcnn.forward(t,r)]:[3,2];case 1:return[2,a.sent().map((function(e){return e.detection}))];case 2:n=r instanceof pe?function(e){return _e.tinyFaceDetector.locateFaces(e,r)}:r instanceof Q?function(e){return _e.ssdMobilenetv1.locateFaces(e,r)}:r instanceof ue?function(e){return _e.tinyYolov2.locateFaces(e,r)}:null;if(!n)throw new Error("detectFaces - expected options to be instance of TinyFaceDetectorOptions | SsdMobilenetv1Options | MtcnnOptions | TinyYolov2Options");return[2,n(t)]}}))}))};DetectAllFacesTask.prototype.runAndExtendWithFaceDetections=function(){var e=this;return new Promise((function(t){return a(e,void 0,void 0,(function(){var e;return o(this,(function(r){switch(r.label){case 0:return[4,this.run()];case 1:e=r.sent();return[2,t(e.map((function(e){return extendWithFaceDetection({},e)})))]}}))}))}))};DetectAllFacesTask.prototype.withFaceLandmarks=function(e){void 0===e&&(e=false);return new je(this.runAndExtendWithFaceDetections(),this.input,e)};DetectAllFacesTask.prototype.withFaceExpressions=function(){return new De(this.runAndExtendWithFaceDetections(),this.input)};DetectAllFacesTask.prototype.withAgeAndGender=function(){return new Le(this.runAndExtendWithFaceDetections(),this.input)};return DetectAllFacesTask}($e);var Ve=function(e){t(DetectSingleFaceTask,e);function DetectSingleFaceTask(){return null!==e&&e.apply(this,arguments)||this}DetectSingleFaceTask.prototype.run=function(){return a(this,void 0,void 0,(function(){var e,t;return o(this,(function(r){switch(r.label){case 0:return[4,new Ge(this.input,this.options)];case 1:e=r.sent();t=e[0];e.forEach((function(e){e.score>t.score&&(t=e)}));return[2,t]}}))}))};DetectSingleFaceTask.prototype.runAndExtendWithFaceDetection=function(){var e=this;return new Promise((function(t){return a(e,void 0,void 0,(function(){var e;return o(this,(function(r){switch(r.label){case 0:return[4,this.run()];case 1:e=r.sent();return[2,t(e?extendWithFaceDetection({},e):void 0)]}}))}))}))};DetectSingleFaceTask.prototype.withFaceLandmarks=function(e){void 0===e&&(e=false);return new ze(this.runAndExtendWithFaceDetection(),this.input,e)};DetectSingleFaceTask.prototype.withFaceExpressions=function(){return new ke(this.runAndExtendWithFaceDetection(),this.input)};DetectSingleFaceTask.prototype.withAgeAndGender=function(){return new Ne(this.runAndExtendWithFaceDetection(),this.input)};return DetectSingleFaceTask}($e);function detectSingleFace(e,t){void 0===t&&(t=new Q);return new Ve(e,t)}function detectAllFaces(e,t){void 0===t&&(t=new Q);return new Ge(e,t)}function allFacesSsdMobilenetv1(e,t){return a(this,void 0,void 0,(function(){return o(this,(function(r){switch(r.label){case 0:console.warn("allFacesSsdMobilenetv1 is deprecated and will be removed soon, use the high level api instead");return[4,detectAllFaces(e,new Q(t?{minConfidence:t}:{})).withFaceLandmarks().withFaceDescriptors()];case 1:return[2,r.sent()]}}))}))}function allFacesTinyYolov2(e,t){void 0===t&&(t={});return a(this,void 0,void 0,(function(){return o(this,(function(r){switch(r.label){case 0:console.warn("allFacesTinyYolov2 is deprecated and will be removed soon, use the high level api instead");return[4,detectAllFaces(e,new ue(t)).withFaceLandmarks().withFaceDescriptors()];case 1:return[2,r.sent()]}}))}))}function allFacesMtcnn(e,t){void 0===t&&(t={});return a(this,void 0,void 0,(function(){return o(this,(function(r){switch(r.label){case 0:console.warn("allFacesMtcnn is deprecated and will be removed soon, use the high level api instead");return[4,detectAllFaces(e,new Z(t)).withFaceLandmarks().withFaceDescriptors()];case 1:return[2,r.sent()]}}))}))}var Ye=allFacesSsdMobilenetv1;function euclideanDistance(e,t){if(e.length!==t.length)throw new Error("euclideanDistance: arr1.length !== arr2.length");var r=Array.from(e);var n=Array.from(t);return Math.sqrt(r.map((function(e,t){return e-n[t]})).reduce((function(e,t){return e+Math.pow(t,2)}),0))}var He=function(){function FaceMatcher(e,t){void 0===t&&(t=.6);this._distanceThreshold=t;var r=Array.isArray(e)?e:[e];if(!r.length)throw new Error("FaceRecognizer.constructor - expected atleast one input");var n=1;var createUniqueLabel=function(){return"person "+n++};this._labeledDescriptors=r.map((function(e){if(e instanceof _)return e;if(e instanceof Float32Array)return new _(createUniqueLabel(),[e]);if(e.descriptor&&e.descriptor instanceof Float32Array)return new _(createUniqueLabel(),[e.descriptor]);throw new Error("FaceRecognizer.constructor - expected inputs to be of type LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array | Array<LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array>")}))}Object.defineProperty(FaceMatcher.prototype,"labeledDescriptors",{get:function(){return this._labeledDescriptors},enumerable:true,configurable:true});Object.defineProperty(FaceMatcher.prototype,"distanceThreshold",{get:function(){return this._distanceThreshold},enumerable:true,configurable:true});FaceMatcher.prototype.computeMeanDistance=function(e,t){return t.map((function(t){return euclideanDistance(t,e)})).reduce((function(e,t){return e+t}),0)/(t.length||1)};FaceMatcher.prototype.matchDescriptor=function(e){var t=this;return this.labeledDescriptors.map((function(r){var n=r.descriptors,a=r.label;return new b(a,t.computeMeanDistance(e,n))})).reduce((function(e,t){return e.distance<t.distance?e:t}))};FaceMatcher.prototype.findBestMatch=function(e){var t=this.matchDescriptor(e);return t.distance<this.distanceThreshold?t:new b("unknown",t.distance)};FaceMatcher.prototype.toJSON=function(){return{distanceThreshold:this.distanceThreshold,labeledDescriptors:this.labeledDescriptors.map((function(e){return e.toJSON()}))}};FaceMatcher.fromJSON=function(e){var t=e.labeledDescriptors.map((function(e){return _.fromJSON(e)}));return new FaceMatcher(t,e.distanceThreshold)};return FaceMatcher}();function createMtcnn(e){var t=new ge;t.extractWeights(e);return t}function createTinyFaceDetector(e){var t=new we;t.extractWeights(e);return t}function resizeResults(e,t){var r=new i(t.width,t.height),n=r.width,a=r.height;if(n<=0||a<=0)throw new Error("resizeResults - invalid dimensions: "+JSON.stringify({width:n,height:a}));if(Array.isArray(e))return e.map((function(e){return resizeResults(e,{width:n,height:a})}));if(isWithFaceLandmarks(e)){var o=e.detection.forSize(n,a);var s=e.unshiftedLandmarks.forSize(o.box.width,o.box.height);return extendWithFaceLandmarks(extendWithFaceDetection(e,o),s)}return isWithFaceDetection(e)?extendWithFaceDetection(e,e.detection.forSize(n,a)):e instanceof g||e instanceof p?e.forSize(n,a):e}export{V as AgeGenderNet,l as BoundingBox,u as Box,ve as ComposableTask,Oe as ComputeAllFaceDescriptorsTask,We as ComputeFaceDescriptorsTaskBase,Ie as ComputeSingleFaceDescriptorTask,je as DetectAllFaceLandmarksTask,Ge as DetectAllFacesTask,Re as DetectFaceLandmarksTaskBase,$e as DetectFacesTaskBase,ze as DetectSingleFaceLandmarksTask,Ve as DetectSingleFaceTask,i as Dimensions,W as FACE_EXPRESSION_LABELS,p as FaceDetection,te as FaceDetectionNet,I as FaceExpressionNet,O as FaceExpressions,H as FaceLandmark68Net,J as FaceLandmark68TinyNet,q as FaceLandmarkNet,g as FaceLandmarks,x as FaceLandmarks5,y as FaceLandmarks68,b as FaceMatch,He as FaceMatcher,X as FaceRecognitionNet,G as Gender,w as LabeledBox,_ as LabeledFaceDescriptors,ge as Mtcnn,Z as MtcnnOptions,S as NetInput,L as NeuralNetwork,h as ObjectDetection,c as Point,P as PredictedBox,v as Rect,ee as SsdMobilenetv1,Q as SsdMobilenetv1Options,we as TinyFaceDetector,pe as TinyFaceDetectorOptions,he as TinyYolov2,ue as TinyYolov2Options,ce as TinyYolov2SizeType,Ye as allFaces,allFacesMtcnn,allFacesSsdMobilenetv1,allFacesTinyYolov2,awaitMediaLoaded,bufferToImage,computeFaceDescriptor,createCanvas,createCanvasFromMedia,createFaceDetectionNet,createFaceRecognitionNet,createMtcnn,createSsdMobilenetv1,createTinyFaceDetector,createTinyYolov2,detectAllFaces,detectFaceLandmarks,detectFaceLandmarksTiny,Te as detectLandmarks,detectSingleFace,z as draw,T as env,euclideanDistance,extendWithAge,extendWithFaceDescriptor,extendWithFaceDetection,extendWithFaceExpressions,extendWithFaceLandmarks,extendWithGender,extractFaceTensors,extractFaces,fetchImage,fetchJson,fetchNetWeights,fetchOrThrow,getContext2dOrThrow,getMediaDimensions,imageTensorToCanvas,imageToSquare,inverseSigmoid,iou,isMediaElement,isMediaLoaded,isWithAge,isWithFaceDetection,isWithFaceExpressions,isWithFaceLandmarks,isWithGender,loadAgeGenderModel,Pe as loadFaceDetectionModel,loadFaceExpressionModel,loadFaceLandmarkModel,loadFaceLandmarkTinyModel,loadFaceRecognitionModel,loadMtcnnModel,loadSsdMobilenetv1Model,loadTinyFaceDetectorModel,loadTinyYolov2Model,loadWeightMap,Fe as locateFaces,matchDimensions,minBbox,mtcnn,_e as nets,nonMaxSuppression$1 as nonMaxSuppression,normalize$1 as normalize,padToSquare,predictAgeAndGender,recognizeFaceExpressions,resizeResults,resolveInput,shuffleArray,sigmoid,ssdMobilenetv1,tinyFaceDetector,tinyYolov2,toNetInput,s as utils,validateConfig};

