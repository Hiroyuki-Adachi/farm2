import e from"underscore";import t from"fs-extra";import n from"crypto";import a from"path";import r from"buffer";import i from"bluebird";var o={};var c=e;var u=t;var s=n;var f=a;var d=r.Buffer;var l=i;f=a;var p={};function walk(e){var t=[];var n=u.readdirSync(e);n.forEach((function(n){n=e+"/"+n;var a=u.statSync(n);a&&a.isDirectory()?t=t.concat(walk(n)):t.push(n)}));return t}function applyBasePath(e){if(c.isUndefined(p.basePath))return e;var t=["Bucket","CopySource"];var n=c.mapObject(e,(function(e,n){return-1===c.indexOf(t,n)?e:null!=p.basePath&&null!=e?f.join(p.basePath,e):void 0}));return n}function FakeStream(e){this.src=e.Bucket+"/"+e.Key}FakeStream.prototype.createReadStream=function(){return u.createReadStream(this.src)};function createPromisable(e){return function(){var t=this;var n=l.promisify(e,{context:t});var a=[].slice.call(arguments);var r=null;var i=Math.min(a.length-1,e.length);if(a.length>=1){var o=a[i];c.isFunction(o)&&(r=o)}if(!c.isFunction(r))return{createReadStream:function(){this.send();if(this._returned instanceof FakeStream)return this._returned.createReadStream()},promise:function(){return n.apply(t,a)},send:function(n){a.push(n);this._returned=e.apply(t,a)}};e.apply(t,a)}}function S3Mock(e){c.isUndefined(e)||c.isUndefined(e.params)||(this.defaultOptions=c.extend({},applyBasePath(e.params)));this.config={update:function(){}}}S3Mock.prototype={objectMetadataDictionary:[],objectTaggingDictionary:[],listObjectsV2:function(e,t){var n=c(e).clone();n.Marker=e.ContinuationToken||e.StartAfter;this.listObjects(n,(function(n,a){var r=c(a).clone();r.NextContinuationToken=a.NextMarker;r.ContinuationToken=e.ContinuationToken;r.StartAfter=e.StartAfter;t(n,r)}))},listObjects:function(e,t){e=c.extend({},this.defaultOptions,applyBasePath(e));var n=walk(e.Bucket);var a=c.filter(n,(function(t){return!e.Prefix||0===t.replace(e.Bucket+"/","").indexOf(e.Prefix)}));var r=0;var i=false;if(e.Marker){var o;var f=c(a).find((function(t){var n=e.Bucket+"/"+e.Marker;if(0===t.indexOf(n)){o=t.length!==n.length;return true}}));var d;d=o?a[a.indexOf(f)]:a[a.indexOf(f)+1];r=a.indexOf(d)}a=-1===r?[]:c.rest(a,r);if(a.length>Math.min(1e3,e.MaxKeys||1e3)){i=true;a=a.slice(0,Math.min(1e3,e.MaxKeys||1e3))}var l={Contents:c.map(a,(function(t){var n=u.statSync(t);return{Key:t.replace(e.Bucket+"/",""),ETag:'"'+s.createHash("md5").update(u.readFileSync(t)).digest("hex")+'"',LastModified:n.mtime,Size:n.size}})),CommonPrefixes:c.reduce(a,(function(t,n){var a=n.replace(e.Bucket+"/","").split("/").slice(0,-1).join("/").concat("/");return-1===t.indexOf(a)?t.concat([a]):t}),[]).map((function(e){return{Prefix:e}})),IsTruncated:i};e.Marker&&(l.Marker=e.Marker);i&&e.Delimiter&&(l.NextMarker=c.last(l.Contents).Key);t(null,l)},deleteObjects:function(e,t){e=c.extend({},this.defaultOptions,applyBasePath(e));var n=[];var a=[];c.each(e.Delete.Objects,(function(t){if(u.existsSync(e.Bucket+"/"+t.Key)){n.push(t);u.unlinkSync(e.Bucket+"/"+t.Key)}else a.push(t)}));a.length>0?t("Error deleting objects",{Errors:a,Deleted:n}):t(null,{Deleted:n})},deleteObject:function(e,t){e=c.extend({},this.defaultOptions,applyBasePath(e));if(u.existsSync(e.Bucket+"/"+e.Key)){u.unlinkSync(e.Bucket+"/"+e.Key);t(null,true)}else t(null,{})},headObject:function(e,t){var n=this;e=c.extend({},this.defaultOptions,applyBasePath(e));if(!t)return new FakeStream(e);u.readFile(e.Bucket+"/"+e.Key,(function(a,r){if(a){"ENOENT"===a.code&&(a.statusCode=404);t(a,e)}else{var i={Key:e.Key,ETag:'"'+s.createHash("md5").update(r).digest("hex")+'"',ContentLength:r.length};n.objectMetadataDictionary[e.Key]&&(i.Metadata=n.objectMetadataDictionary[e.Key]);t(null,i)}}))},getObject:function(e,t){var n=this;e=c.extend({},this.defaultOptions,applyBasePath(e));if(!t)return new FakeStream(e);var a=e.Bucket+"/"+e.Key;u.readFile(a,(function(r,i){if(r){if("ENOENT"===r.code)return t({cfId:void 0,code:"NoSuchKey",message:"The specified key does not exist.",name:"NoSuchKey",region:null,statusCode:404},e);t(r,e)}else{var o=u.statSync(a);var c={Key:e.Key,ETag:'"'+s.createHash("md5").update(i).digest("hex")+'"',Body:i,LastModified:o.mtime,ContentLength:i.length};n.objectMetadataDictionary[e.Key]&&(c.Metadata=n.objectMetadataDictionary[e.Key]);t(null,c)}}))},copyObject:function(e,t){e=c.extend({},this.defaultOptions,applyBasePath(e));u.mkdirsSync(f.dirname(e.Bucket+"/"+e.Key));u.copy(decodeURIComponent(e.CopySource),e.Bucket+"/"+e.Key,(function(n,a){t(n,e)}))},createBucket:function(e,t){var n=null;"object"===typeof e&&null!==e?("string"!==typeof e.Bucket||e.Bucket.length<=0)&&(n=new Error("Mock-AWS-S3: Argument 'params' must contain a 'Bucket' (String) property")):n=new Error("Mock-AWS-S3: Argument 'params' must be an Object");var a=c.extend({},this.defaultOptions,applyBasePath(e));if(null!==n)return t(n);var r=a.basePath||"";r+=a.Bucket;u.mkdirs(r,(function(e){return t(e)}))},
/**
   * Deletes a bucket. Behaviour as createBucket
   * @param params {Bucket: bucketName}. Name of bucket to delete
   * @param callback
   * @returns void
   */
deleteBucket:function(e,t){var n=null;"object"===typeof e&&null!==e?("string"!==typeof e.Bucket||e.Bucket.length<=0)&&(n=new Error("Mock-AWS-S3: Argument 'params' must contain a 'Bucket' (String) property")):n=new Error("Mock-AWS-S3: Argument 'params' must be an Object");var a=c.extend({},this.defaultOptions,applyBasePath(e));null!==n&&t(n);var r=a.basePath||"";r+=a.Bucket;u.remove(r,(function(e){return t(e)}))},putObject:function(e,t){e=c.extend({},this.defaultOptions,applyBasePath(e));e.Metadata&&(this.objectMetadataDictionary[e.Key]=e.Metadata);if("string"===typeof e.Tagging){var n={};var a=[];e.Tagging.split("&").forEach((function(e){var t=e.split("=");n[decodeURIComponent(t[0])]=decodeURIComponent(t[1])}));Object.keys(n).forEach((function(e){a.push({Key:e,Value:n[e]})}));this.objectTaggingDictionary[e.Key]=a}var r=e.Bucket+"/"+e.Key;var i=null;var done=function(){"function"===typeof i&&i.apply(this,arguments);"function"===typeof t&&t.apply(this,arguments)};"string"===typeof e.Body&&(e.Body=d.from(e.Body));if(e.Body instanceof d){u.createFileSync(r);u.writeFile(r,e.Body,(function(t){done(t,{Location:r,Key:e.Key,Bucket:e.Bucket})}))}else{u.mkdirsSync(f.dirname(r));var o=u.createWriteStream(r);o.on("finish",(function(){done(null,true)}));e.Body.on("error",(function(e){done(e)}));o.on("error",(function(e){done(e)}));e.Body.pipe(o)}return{send:function(e){i=e}}},getObjectTagging:function(e,t){var n=this;this.headObject(e,(function(a,r){return a?t(a):t(null,{VersionId:"1",TagSet:n.objectTaggingDictionary[e.Key]||[]})}))},putObjectTagging:function(e,t){var n=this;if(!e.Tagging||!e.Tagging.TagSet)return t(new Error("Tagging.TagSet required"));this.headObject(e,(function(a,r){if(a)return t(a);n.objectTaggingDictionary[e.Key]=e.Tagging.TagSet;return t(null,{VersionId:"1"})}))},upload:function(e,t,n){if("function"===typeof t&&void 0===n){n=t;t=null}return t&&t.tags&&!Array.isArray(t.tags)?n(new Error("Tags must be specified as an array; "+typeof t.tags+" provided")):this.putObject(e,function(a,r){return t&&t.tags?this.putObjectTagging({Bucket:e.Bucket,Key:e.Key,Tagging:{TagSet:t.tags}},(function(e){return e?n(e):n(null,r)})):n(a,r)}.bind(this))},getSignedUrl:function(e,t,n){var a="https://s3.us-east-2.amazonaws.com/"+t.Bucket+"/"+t.Key+"?X-Amz-Date=20170720T182534Z&X-Amz-SignedHeaders=host&X-Amz-Credential=ASIAIYLQNVRRFNZOCFBA%2F20170720%2Fus-east-2%2Fs3%2Faws4_request&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Expires=604800&X-Amz-Security-Token=FQoDYXdzEJP%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaDOLWx95j90zPxGh7WSLdAVnoYoKC4gjrrR1xbokFWRRwutmuAmOxaIVcQqOy%2Fqxy%2FXQt3Iz%2FohuEEmI7%2FHPzShy%2BfgQtvfUeDaojrAx5q8fG9P1KuIfcedfkiU%2BCxpM2foyCGlXzoZuNlcF8ohm%2BaM3wh4%2BxQ%2FpShLl18cKiKEiw0QF1UQGj%2FsiEqzoM81vOSUVWL9SpTTkVq8EQHY1chYKBkBWt7eIQcxjTI2dQeYOohlrbnZ5Y1%2F1cxPgrbk6PkNFO3whAoliSjyRC8e4TSjIY2j3V6d9fUy4%2Fp6nLZIf9wuERL7xW9PjE6eZbKOHnw8sF&X-Amz-Signature=a14b3065ab822105e8d7892eb5dcc455ddd603c61e47520774a7289178af9ecc";switch(e){case"getObject":this.headObject(t,(function(e,t){e&&(e.statusCode=404);if(!n){if(e)throw new Error(e);return a}e?n(e,null):n(null,a)}));break;case"putObject":if(!t.Bucket||!t.Key)throw new Error({statusCode:404});return a;default:}}};c.forEach(S3Mock.prototype,(function(e,t,n){c.isFunction(e)&&(n[t]=createPromisable(e))}));o.config=p;o.S3=function(e){return new S3Mock(e)};const y=o.config,h=o.S3;export default o;export{h as S3,y as config};

