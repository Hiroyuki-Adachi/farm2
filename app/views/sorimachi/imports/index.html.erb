<h1>ソリマチ農業簿記インポート</h1>
<% if @error %>
<div class="alert alert-danger" role="alert"><%= @error %></div>
<% end %>
<% if @journals && @journals.count > 0 %>
<table class="table table-sm">
  <thead>
    <tr>
      <th></th>
      <th class="numeric">行番号</th>
      <th class="numeric">明細番号</th>
      <th>仕訳日</th>
      <th>借方科目</th>
      <th class="numeric">借方金額</th>
      <th>貸方科目</th>
      <th class="numeric">貸方金額</th>
      <th>備考</th>
    </tr>
  </thead>
  <tbody>
  <% @journals.each do |journal| %>
    <% details = @details.select {|detail| detail.line == journal.line} %>
    <tr>
      <td>
        <% if details.count.positive? %>
        <button class="btn btn-sm btn-info has-details" data-line="<%= journal.line %>" data-details="false">明細</button>
        <% end %>
      </td>
      <td class="numeric"><%= journal.line %></td>
      <td class="numeric">1</td>
      <td><%= journal.accounted_on || "決算" %></td>
      <td><%= @accounts[journal.code01] || journal.code01 %></td>
      <td class="numeric"><%= number_to_currency(journal.amount1, {precision: 0, unit: ""}) %></td>
      <td><%= @accounts[journal.code12] || journal.code12 %></td>
      <td class="numeric"><%= number_to_currency(journal.amount2, {precision: 0, unit: ""}) %></td>
      <td><%= journal.remark1 %>／<%= journal.remark3 %></td>
    </tr>
    <% details.each do |detail| %>
      <tr data-detail-line="<%= detail.line %>" style="display:none;" class="bg-light">
        <td></td>
        <td class="numeric"><%= detail.line %></td>
        <td class="numeric"><%= detail.detail %></td>
        <td></td>
        <td><%= @accounts[detail.code01] || detail.code01 %></td>
        <td class="numeric"><%= number_to_currency(detail.amount1, {precision: 0, unit: ""}) %></td>
        <td><%= @accounts[detail.code12] || detail.code12 %></td>
        <td class="numeric"><%= number_to_currency(detail.amount2, {precision: 0, unit: ""}) %></td>
        <td><%= detail.remark1 %><%= detail.remark3.present? ? "／#{detail.remark3}" : "" %></td>
      </tr>
    <% end %>
  <% end %>
  </tbody>
</table>
<%= paginate(@journals) %>
<% end %>
<%= form_with(url: sorimachi_imports_path, html: {multipart: true}) do |f| %>
  <div class="row">
    <div class="col-md-4 form-group">
      <%= file_field_tag :import_file, {class: "form-control-file custom-file-input", data: {buttonText: "ファイル選択"}} %>
    </div>
  </div>
  <div class="btn-toolbar">
    <div class="btn-group mr-2">
      <%= submit_tag 'インポート', class: "btn btn-danger" %>
    </div>
    <div class="btn-group mr-2">
      <%= link_to "科目初期化", new_sorimachi_account_path, {class: "btn btn-danger"} %>
    </div>
    <div class="btn-group mr-2">
      <%= link_to "戻る", menu_index_path, {class: "btn btn-outline-dark"}%>
    </div>
  </div>
<% end %>
<script>
window.addEventListener("load", () => {
  document.querySelectorAll("button.has-details").forEach((element) => {
    element.addEventListener("click", (event) => {
      const dispFlag = (element.dataset.details != "true");
      element.dataset.details = dispFlag.toString();
      document.querySelectorAll(`[data-detail-line="${element.dataset.line}"]`).forEach((detail) => {
        detail.style.display = dispFlag ? "table-row" : "none";
      });
    });
  });
});
</script>
