<h1>作業日報／作業者登録</h1>

<script type="text/javascript">
window.onload = function() {
    set_add_buttons();
}
</script>
<%= render(:partial => "error") %>

<%= form_for(@work.model, url: {action: :update }, html: {method: :put}) do |f| %>
  <%= render(:partial => 'show_work', :locals => {:f => f}) %>

  <h2>作業者</h2>
  <div style="float:left;">
  <table id="tbl_workers">
    <thead>
    <tr>
      <th style="width:20px;">No.</th>
      <th style="width:120px;">作業者名</th>
      <th style="width:80px;">時間</th>
      <th style="width:40px;">&nbsp;</th>
    </tr>
    </thead>
    <tbody id="tbody_workers">
    <% @results.each_with_index do |result, i| %>
      <tr id="worker_<%= result.worker_id %>">
        <td class="numeric"><%= i + 1 %></td>
        <td><%= result.worker.name %></td>
        <td><%= number_field_tag "results[][hours]", result.hours, {id: nil, max: 99, step: 0.5} %></td>
        <td>
            <input type="button" value="削除" onclick="remove_worker(<%= result.worker_id %>)" />
            <%= hidden_field_tag "results[][worker_id]", result.worker_id, {:id => nil} %>
            <%= hidden_field_tag "results[][display_order]", i + 1, {:id => nil} %>
        </td>
      </tr>
    <% end %>
    </tbody>
  </table>
  </div>
  <div style="float:left;margin-left: 40px; margin-top: 25px;">
    <%= select_tag(:section, options_for_select(@sections), :onChange => "change_section(this);") %>
    <div style="height:300px; overflow:auto; border-style:double;overflow-x:hidden;">
    <table id="master_workers">
      <tbody>
        <% Worker.usual.each do |worker| %>
        <tr id="master_worker_<%= worker.id %>">
          <td><input id="add_button_<%= worker.id %>" type="button" value="←追加" onclick="add_worker(<%= worker.id %>, '<%= worker.name %>')" /></td>
          <td style="width:80px;"><%= worker.home.name %></td>
          <td style="width:120px;"><%= worker.name %></td>
          <td style="display: none;"><%= worker.home.section_id %></td>
        </tr>
        <% end %>
      </tbody>
    </table>
    </div>
  </div>
  <div style="clear:left;"></div>

  <br />
  <%= f.submit '登録', :name => 'regist_workers' %>
  <%= f.submit '戻る', :name => 'cancel' %>
<% end %>

<script type="text/javascript">
function add_worker(worker_id, worker_name)
{
    var tbody_workers = document.getElementById("tbody_workers");
    var row = tbody_workers.insertRow(tbody_workers.rows.length);

    row.id = "worker_" + worker_id.toString();

    var cell_no = row.insertCell(0);
    var cell_name = row.insertCell(1);
    var cell_time = row.insertCell(2);
    var cell_del = row.insertCell(3);

    var display_order = tbody_workers.rows.length ;

    cell_no.className = "numeric";
    cell_no.innerHTML = display_order;
    cell_name.innerHTML = worker_name;

    var elem_time = document.createElement("input");
    elem_time.type = "number";
    elem_time.value = get_hours();
    elem_time.name = "results[][hours]";
    elem_time.max = 99;
    elem_time.step = 0.5;
    cell_time.appendChild(elem_time);

    var elem_button = document.createElement("input")
    elem_button.type = "button";
    elem_button.value = "\u524a\u9664"; // 削除
    elem_button.onclick = new Function("remove_worker(" + worker_id + ");");
    cell_del.appendChild(elem_button);

    var elem_worker = document.createElement("input");
    elem_worker.type = "hidden";
    elem_worker.name = "results[][worker_id]";
    elem_worker.value = worker_id;
    cell_del.appendChild(elem_worker);

    var elem_order = document.createElement("input");
    elem_order.type = "hidden";
    elem_order.name = "results[][display_order]";
    elem_order.value = display_order;
    cell_del.appendChild(elem_order);

    set_add_buttons();
}

function remove_worker(worker_id)
{
    var tbl_workers = document.getElementById("tbl_workers");
    var tr_worker = document.getElementById("worker_" + worker_id.toString());

    tbl_workers.deleteRow(tr_worker.rowIndex);
    renumber_worker();
    set_add_buttons();
}

function renumber_worker()
{
    var tbody_workers = document.getElementById("tbody_workers");
    var row_worker;
    for(var i = 0; i < tbody_workers.rows.length; i++)
    {
        row_worker = tbody_workers.rows[i];
        row_worker.cells[0].innerHTML = i + 1;
        row_worker.cells[3].children[2].value = i + 1;
    }
}

function get_hours()
{
    var dateFormat = new DateFormat("yyyy-MM-dd HH:mm:ss");
    var start_time  = dateFormat.parse(document.getElementById("work_start_at").value.substring(0, 19));
    var end_time    = dateFormat.parse(document.getElementById("work_end_at").value.substring(0, 19));

    var start_hour = start_time.getHours();
    start_hour += parseFloat(start_time.getMinutes()) / 60.0;

    var end_hour = end_time.getHours();
    end_hour += parseFloat(end_time.getMinutes()) / 60.0;

    if((start_hour < 12) && (end_hour > 13)) end_hour-= 1.0;

    return (end_hour - start_hour).toFixed(1);
}

function set_add_buttons()
{
    var master_workers = document.getElementById("master_workers");
    var tbody_workers = document.getElementById("tbody_workers");
    var i;

    for(i = 0; i < master_workers.rows.length; i++)
    {
        master_workers.rows[i].cells[0].children[0].disabled = false;
        master_workers.rows[i].style.backgroundColor = "White";
    }

    for(i = 0; i < tbody_workers.rows.length; i++)
    {
        var worker_id = tbody_workers.rows[i].cells[3].children[1].value;
        document.getElementById("add_button_" + worker_id).disabled = true;
        document.getElementById("master_worker_" + worker_id).style.backgroundColor = "lightgrey";
    }
}

function change_section(section) {
    var workers = document.getElementById("master_workers");
    var worker_tr;

    for(var i = 0; i < workers.rows.length; i++) {
        worker_tr = master_workers.rows[i];
        worker_tr.style.display = "";
        if(parseInt(section.value) != 0 && parseInt(worker_tr.cells[3].innerText) != parseInt(section.value)) {
            worker_tr.style.display = "none";
        }
    }
}
</script>