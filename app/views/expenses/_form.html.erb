<%= error_print(@expense) %>
<%= form_for(@expense) do |f| %>
<div class="form-row">
  <div class="form-group col-md-2">
    <%= f.label :payed_on, class: "col-form-label-lg" %>
    <%= f.date_field :payed_on, {required: true, class: "form-control", min: current_system.start_date, max: current_system.end_date} %>
  </div>
  <div class="form-group col-md-4">
    <%= f.label :content, class: "col-form-label-lg" %>
    <%= f.text_field :content, {:maxlength => 40, :size => 40, required: true, class: "form-control"} %>
  </div>
  <div class="form-group col-md-2">
    <%= f.label :amount, class: "col-form-label-lg" %>
    <%= f.number_field :amount, {min: 0, max: 9999999, step: 1, required: true, class: "form-control"} %>
  </div>
</div>
<%= f.hidden_field :term, {value: current_term} %>
<div class="form-row">
  <div class="field form-group">
    <fieldset>
      <legend>原価対象</legend>
      <% @work_types.each do |work_type| %>
        <% expense_work_type = @expense.expense_work_types.find{|ewt| ewt.work_type_id == work_type.id} if @expense.expense_work_types %>
        <div class="form-check form-check-inline">
          <%= check_box_tag "", expense_work_type ? expense_work_type.true_rate : 1, expense_work_type ? expense_work_type.rate? : false, {id: "expense_work_types_rate_#{work_type.id}", class: "form-check-input", data: {id: "expense_rate_value_#{work_type.id}"}} %>
          <%= label_tag "expense_work_types_rate_#{work_type.id}", work_type.name, {class: "form-check-label", id: nil} %>
          <%= hidden_field_tag "expense[expense_work_types_attributes][][id]", expense_work_type&.id, {id: nil} %>
          <%= hidden_field_tag "expense[expense_work_types_attributes][][work_type_id]", work_type.id, {id: nil} %>
          <%= hidden_field_tag "expense[expense_work_types_attributes][][rate]", expense_work_type&.rate || 0, {id: "expense_rate_value_#{work_type.id}"} %>
        </div>
      <% end %>
    </fieldset>
  </div>
</div>
<div class="btn-toolbar">
  <div class="btn-group mr-2">
    <%= f.submit '登録', class: "btn btn-warning" %>
  </div>
  <% unless @expense.new_record? %>
    <div class="btn-group mr-2">
      <%= link_to '削除', @expense, {method: :delete, data: {confirm: "本当に削除してもよろしいですか?"}, class: "btn btn-danger"} %>
    </div>
  <% end %>
  <div class="btn-group mr-2">
    <%= link_to '戻る', expenses_path, class: "btn btn-outline-dark" %>
  </div>
</div>
<% end %>
<script>
$(function() {
    $("input[type='checkbox'][id^='expense_work_types_rate_']").click(function() {
        $("#" + $(this).data("id")).val($(this).prop("checked") ? $(this).val() : 0);
    });
});
</script>