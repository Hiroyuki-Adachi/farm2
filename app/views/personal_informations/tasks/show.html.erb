<!-- app/views/tasks/show.html+mobile.erb -->
<div class="container py-3">

  <!-- タイトル + ステータス/優先度バッジ（読み取り専用） -->
  <div class="mb-3">
    <h2 class="mb-2 lh-sm text-break">
      <small class="text-muted d-block mt-1"><%= @task.title %></small>
    </h2>
    <div class="d-flex flex-wrap gap-2">
      <span><%= @task.new_badge %></span>
      <span><%= @task.status_badge %></span>
      <span><%= @task.priority_badge %></span>
    </div>
  </div>

  <!-- メタ情報 -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <ul class="list-group list-group-flush">
        <li class="list-group-item px-0 d-flex justify-content-between">
          <span class="text-muted">作成者</span>
          <span class="text-break"><%= @task.creator&.name || "-" %></span>
        </li>
        <li class="list-group-item px-0 d-flex justify-content-between">
          <span class="text-muted">担当者</span>
          <span class="text-break"><%= @task.assignee&.name || "-" %></span>
        </li>
        <li class="list-group-item px-0 d-flex justify-content-between">
          <span class="text-muted">期限</span>
          <span><%= @task.due_on&.to_s || "-" %></span>
        </li>
        <li class="list-group-item px-0 d-flex justify-content-between">
          <span class="text-muted">役割</span>
          <span><%= @task.office_role_name %></span>
        </li>
        <li class="list-group-item px-0 d-flex justify-content-between">
          <span class="text-muted">着手日</span>
          <span><%= @task.started_on&.to_s || "-" %></span>
        </li>
        <li class="list-group-item px-0 d-flex justify-content-between">
          <span class="text-muted">完了日</span>
          <span><%= @task.ended_on&.to_s || "-" %></span>
        </li>
      </ul>
    </div>
  </div>

  <!-- 説明（Markdown） -->
  <div class="card shadow-sm mb-3">
    <div class="card-header fw-bold">説明</div>
    <div class="card-body">
      <% if @task.description.present? %>
        <div class="markdown-body text-break">
          <%= markdown_to_html(@task.description) %>
        </div>
      <% else %>
        <div class="text-muted fst-italic">（説明はありません）</div>
      <% end %>
    </div>
  </div>

<% events = @task.events.with_read_info(current_user.worker_id, @last_read_at).usual_order %>
<% events = TaskEventDecorator.decorate_collection(events, context: { current_worker: current_user.worker }) %>

  <!-- イベント＋メッセージ（チャット風・閲覧のみ） -->
  <section class="card shadow-sm">
    <div class="card-header fw-bold d-flex align-items-center gap-2">
      <i class="bi bi-chat-dots"></i><span>やり取り / 更新履歴</span>
    </div>

    <div class="card-body" id="timeline" style="max-height: 70vh; overflow-y: auto;">
      <div class="d-flex flex-column gap-3">
        <% events.each do |event| %>
          <%= render "tasks/events/mobile_item", task: @task, event: event, mine: event.mine_flag %>
        <% end %>
      </div>
    </div>
  </section>
</div>

<div class="fixed-bottom bg-white border-top p-3">
  <%= link_to "戻る", personal_information_schedules_path(personal_information_token: params[:personal_information_token]),
        class: "btn btn-lg btn-primary w-100" %>
</div>

<!-- 初回表示時に最下部へ（読み取り専用の軽いUX） -->
<script>
  (function(){ const el = document.getElementById("timeline"); if(el){ el.scrollTop = el.scrollHeight; } })();
</script>
